<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"nini-hub.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Puppeteer 是一个 Node 库，它提供了高级 API 来通过 DevTools 协议控制 Chromium 或 Chrome如何创建一个 Browser 实例puppeteer 提供了两种方法用于创建一个 Browser 实例：  puppeteer.connect: 连接一个已经存在的 Chrome 实例 puppeteer.launch: 每次都启动一个 Chrome 实例  123">
<meta property="og:type" content="article">
<meta property="og:title" content="自动化测试之puppeteer">
<meta property="og:url" content="https://nini-hub.github.io/2021/01/11/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B9%8Bpuppeteer/index.html">
<meta property="og:site_name" content="ninihub">
<meta property="og:description" content="Puppeteer 是一个 Node 库，它提供了高级 API 来通过 DevTools 协议控制 Chromium 或 Chrome如何创建一个 Browser 实例puppeteer 提供了两种方法用于创建一个 Browser 实例：  puppeteer.connect: 连接一个已经存在的 Chrome 实例 puppeteer.launch: 每次都启动一个 Chrome 实例  123">
<meta property="og:locale" content="zh">
<meta property="article:published_time" content="2021-01-11T05:57:29.000Z">
<meta property="article:modified_time" content="2021-01-11T07:13:54.534Z">
<meta property="article:author" content="妮妮妮">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://nini-hub.github.io/2021/01/11/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B9%8Bpuppeteer/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh'
  };
</script>

  <title>自动化测试之puppeteer | ninihub</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ninihub</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2021/01/11/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B9%8Bpuppeteer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          自动化测试之puppeteer
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>
              

              <time title="أُنشأ: 2021-01-11 13:57:29 / عُدل: 15:13:54" itemprop="dateCreated datePublished" datetime="2021-01-11T13:57:29+08:00">2021-01-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="Puppeteer-是一个-Node-库，它提供了高级-API-来通过-DevTools-协议控制-Chromium-或-Chrome"><a href="#Puppeteer-是一个-Node-库，它提供了高级-API-来通过-DevTools-协议控制-Chromium-或-Chrome" class="headerlink" title="Puppeteer 是一个 Node 库，它提供了高级 API 来通过 DevTools 协议控制 Chromium 或 Chrome"></a>Puppeteer 是一个 Node 库，它提供了高级 API 来通过 DevTools 协议控制 Chromium 或 Chrome</h4><h4 id="如何创建一个-Browser-实例"><a href="#如何创建一个-Browser-实例" class="headerlink" title="如何创建一个 Browser 实例"></a>如何创建一个 Browser 实例</h4><p>puppeteer 提供了两种方法用于创建一个 Browser 实例：</p>
<ul>
<li>puppeteer.connect: 连接一个已经存在的 Chrome 实例</li>
<li>puppeteer.launch: 每次都启动一个 Chrome 实例</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 puppeteer.launch 启动 Chrome</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">        headless: <span class="literal">false</span>,   <span class="comment">//有浏览器界面启动</span></span><br><span class="line">        slowMo: <span class="number">100</span>,       <span class="comment">//放慢浏览器执行速度，方便测试观察</span></span><br><span class="line">        args: [            <span class="comment">//启动 Chrome 的参数，详见上文中的介绍</span></span><br><span class="line">            <span class="string">'–no-sandbox'</span>,</span><br><span class="line">            <span class="string">'--window-size=1280,960'</span></span><br><span class="line">        ],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.baidu.com'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 puppeteer.connect 连接一个已经存在的 Chrome 实例</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">//通过 9222 端口的 http 接口获取对应的 websocketUrl</span></span><br><span class="line">    <span class="keyword">let</span> version = <span class="keyword">await</span> request(&#123;</span><br><span class="line">        uri:  <span class="string">"http://127.0.0.1:9222/json/version"</span>,</span><br><span class="line">        json: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//直接连接已经存在的 Chrome</span></span><br><span class="line">    <span class="keyword">let</span> browser = <span class="keyword">await</span> puppeteer.connect(&#123;</span><br><span class="line">        browserWSEndpoint: version.webSocketDebuggerUrl</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.baidu.com'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.disconnect();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>这两种方式的对比：</p>
<ul>
<li>puppeteer.launch 每次都要重新启动一个 Chrome 进程，启动平均耗时 100 到 150 ms，性能欠佳</li>
<li>puppeteer.connect 可以实现对于同一个 Chrome 实例的共用，减少启动关闭浏览器的时间消耗</li>
<li>puppeteer.launch 启动时参数可以动态修改</li>
<li>通过 puppeteer.connect 我们可以远程连接一个 Chrome 实例，部署在不同的机器上</li>
<li>puppeteer.connect 多个页面共用一个 chrome 实例，偶尔会出现 Page Crash 现象，需要进行并发控制，并定时重启 Chrome 实例</li>
</ul>
<h3 id="加载导航页面"><a href="#加载导航页面" class="headerlink" title="加载导航页面"></a>加载导航页面</h3><ul>
<li>page.goto：打开新页面</li>
<li>page.goBack ：回退到上一个页面</li>
<li>page.goForward ：前进到下一个页面</li>
<li>page.reload ：重新加载页面</li>
<li>page.waitForNavigation：等待页面跳转</li>
</ul>
<p>Pupeeteer 中的基本上所有的操作都是异步的，以上几个 API 都涉及到关于打开一个页面，什么情况下才能判断这个函数执行完毕呢，这些函数都提供了两个参数 waitUtil 和 timeout，waitUtil 表示直到什么出现就算执行完毕，timeout 表示如果超过这个时间还没有结束就抛出异常。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.goto(<span class="string">'https://www.baidu.com'</span>, &#123;</span><br><span class="line">   timeout: <span class="number">30</span> * <span class="number">1000</span>,</span><br><span class="line">   waitUntil: [</span><br><span class="line">       <span class="string">'load'</span>,              <span class="comment">//等待 “load” 事件触发</span></span><br><span class="line">       <span class="string">'domcontentloaded'</span>,  <span class="comment">//等待 “domcontentloaded” 事件触发</span></span><br><span class="line">       <span class="string">'networkidle0'</span>,      <span class="comment">//在 500ms 内没有任何网络连接</span></span><br><span class="line">       <span class="string">'networkidle2'</span>       <span class="comment">//在 500ms 内网络连接个数不超过 2 个</span></span><br><span class="line">   ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上 waitUtil 有四个事件，业务可以根据需求来设置其中一个或者多个触发才以为结束，networkidle0 和 networkidle2 中的 500ms 对时间性能要求高的用户来说，还是有点长的</p>
<h3 id="等待元素、请求、响应"><a href="#等待元素、请求、响应" class="headerlink" title="等待元素、请求、响应"></a>等待元素、请求、响应</h3><ul>
<li>page.waitForXPath：等待 xPath 对应的元素出现，返回对应的 ElementHandle 实例</li>
<li>page.waitForSelector ：等待选择器对应的元素出现，返回对应的 ElementHandle 实例</li>
<li>page.waitForResponse ：等待某个响应结束，返回 Response 实例</li>
<li>page.waitForRequest：等待某个请求出现，返回 Request 实例</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.waitForXPath(<span class="string">'//img'</span>);</span><br><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">'#uniqueId'</span>);</span><br><span class="line"><span class="keyword">await</span> page.waitForResponse(<span class="string">'https://d.youdata.netease.com/api/dash/hello'</span>);</span><br><span class="line"><span class="keyword">await</span> page.waitForRequest(<span class="string">'https://d.youdata.netease.com/api/dash/hello'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="几个常用的案例"><a href="#几个常用的案例" class="headerlink" title="几个常用的案例"></a>几个常用的案例</h3><h3 id="Case1：截图"><a href="#Case1：截图" class="headerlink" title="Case1：截图"></a>Case1：截图</h3><p>我们使用 Puppeteer 既可以对某个页面进行截图，也可以对页面中的某个元素进行截图：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="comment">//设置可视区域大小</span></span><br><span class="line">    <span class="keyword">await</span> page.setViewport(&#123;<span class="attr">width</span>: <span class="number">1920</span>, <span class="attr">height</span>: <span class="number">800</span>&#125;);</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://youdata.163.com'</span>);</span><br><span class="line">    <span class="comment">//对整个页面截图</span></span><br><span class="line">    <span class="keyword">await</span> page.screenshot(&#123;</span><br><span class="line">        path: <span class="string">'./files/capture.png'</span>,  <span class="comment">//图片保存路径</span></span><br><span class="line">        type: <span class="string">'png'</span>,</span><br><span class="line">        fullPage: <span class="literal">true</span> <span class="comment">//边滚动边截图</span></span><br><span class="line">        <span class="comment">// clip: &#123;x: 0, y: 0, width: 1920, height: 800&#125;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//对页面某个元素截图</span></span><br><span class="line">    <span class="keyword">let</span> [element] = <span class="keyword">await</span> page.$x(<span class="string">'/html/body/section[4]/div/div[2]'</span>);</span><br><span class="line">    <span class="keyword">await</span> element.screenshot(&#123;</span><br><span class="line">        path: <span class="string">'./files/element.png'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>我们怎么去获取页面中的某个元素呢？</p>
<ul>
<li>page.$(‘#uniqueId’)：获取某个选择器对应的第一个元素</li>
<li>page.$$(‘div’)：获取某个选择器对应的所有元素</li>
<li>page.$x(‘//img’)：获取某个 xPath 对应的所有元素</li>
<li>page.waitForXPath(‘//img’)：等待某个 xPath 对应的元素出现</li>
<li>page.waitForSelector(‘#uniqueId’)：等待某个选择器对应的元素出现</li>
</ul>
<h3 id="case2-模拟用户登录"><a href="#case2-模拟用户登录" class="headerlink" title="case2: 模拟用户登录"></a>case2: 模拟用户登录</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">        slowMo: <span class="number">100</span>,    <span class="comment">//放慢速度</span></span><br><span class="line">        headless: <span class="literal">false</span>,</span><br><span class="line">        defaultViewport: &#123;<span class="attr">width</span>: <span class="number">1440</span>, <span class="attr">height</span>: <span class="number">780</span>&#125;,</span><br><span class="line">        ignoreHTTPSErrors: <span class="literal">false</span>, <span class="comment">//忽略 https 报错</span></span><br><span class="line">        args: [<span class="string">'--start-fullscreen'</span>] <span class="comment">//全屏打开页面</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://demo.youdata.com'</span>);</span><br><span class="line">    <span class="comment">//输入账号密码</span></span><br><span class="line">    <span class="keyword">const</span> uniqueIdElement = <span class="keyword">await</span> page.$(<span class="string">'#uniqueId'</span>);</span><br><span class="line">    <span class="keyword">await</span> uniqueIdElement.type(<span class="string">'admin@admin.com'</span>, &#123;<span class="attr">delay</span>: <span class="number">20</span>&#125;);</span><br><span class="line">    <span class="keyword">const</span> passwordElement = <span class="keyword">await</span> page.$(<span class="string">'#password'</span>, &#123;<span class="attr">delay</span>: <span class="number">20</span>&#125;);</span><br><span class="line">    <span class="keyword">await</span> passwordElement.type(<span class="string">'123456'</span>);</span><br><span class="line">    <span class="comment">//点击确定按钮进行登录</span></span><br><span class="line">    <span class="keyword">let</span> okButtonElement = <span class="keyword">await</span> page.$(<span class="string">'#btn-ok'</span>);</span><br><span class="line">    <span class="comment">//等待页面跳转完成，一般点击某个按钮需要跳转时，都需要等待 page.waitForNavigation() 执行完毕才表示跳转成功</span></span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">        okButtonElement.click(),</span><br><span class="line">        page.waitForNavigation()  </span><br><span class="line">    ]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'admin 登录成功'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>那么 ElementHandle 都提供了哪些操作元素的函数呢？</p>
<ul>
<li>elementHandle.click()：点击某个元素</li>
<li>elementHandle.tap()：模拟手指触摸点击</li>
<li>elementHandle.focus()：聚焦到某个元素</li>
<li>elementHandle.hover()：鼠标 hover 到某个元素上</li>
<li>elementHandle.type(‘hello’)：在输入框输入文本</li>
</ul>
<h3 id="case3：请求拦截"><a href="#case3：请求拦截" class="headerlink" title="case3：请求拦截"></a>case3：请求拦截</h3><p>请求在有些场景下很有必要，拦截一下没必要的请求提高性能，我们可以在监听 Page 的 request 事件，并进行请求拦截，前提是要开启请求拦截 page.setRequestInterception(true)。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">const</span> blockTypes = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">'image'</span>, <span class="string">'media'</span>, <span class="string">'font'</span>]);</span><br><span class="line">    <span class="keyword">await</span> page.setRequestInterception(<span class="literal">true</span>); <span class="comment">//开启请求拦截</span></span><br><span class="line">    page.on(<span class="string">'request'</span>, request =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> type = request.resourceType();</span><br><span class="line">        <span class="keyword">const</span> shouldBlock = blockTypes.has(type);</span><br><span class="line">        <span class="keyword">if</span>(shouldBlock)&#123;</span><br><span class="line">            <span class="comment">//直接阻止请求</span></span><br><span class="line">            <span class="keyword">return</span> request.abort();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//对请求重写</span></span><br><span class="line">            <span class="keyword">return</span> request.continue(&#123;</span><br><span class="line">                <span class="comment">//可以对 url，method，postData，headers 进行覆盖</span></span><br><span class="line">                headers: <span class="built_in">Object</span>.assign(&#123;&#125;, request.headers(), &#123;</span><br><span class="line">                    <span class="string">'puppeteer-test'</span>: <span class="string">'true'</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://demo.youdata.com'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>那 page 页面上都提供了哪些事件呢？</p>
<ul>
<li>page.on(‘close’) 页面关闭</li>
<li>page.on(‘console’) console API 被调用</li>
<li>page.on(‘error’) 页面出错</li>
<li>page.on(‘load’) 页面加载完</li>
<li>page.on(‘request’) 收到请求</li>
<li>page.on(‘requestfailed’) 请求失败</li>
<li>page.on(‘requestfinished’) 请求成功</li>
<li>page.on(‘response’) 收到响应</li>
<li>page.on(‘workercreated’) 创建 webWorker</li>
<li>page.on(‘workerdestroyed’) 销毁 webWorker</li>
</ul>
<h3 id="case4：植入-javascript-代码"><a href="#case4：植入-javascript-代码" class="headerlink" title="case4：植入 javascript 代码"></a>case4：植入 javascript 代码</h3><p>Puppeteer 最强大的功能是，你可以在浏览器里执行任何你想要运行的 javascript 代码，下面是我在爬 188 邮箱的收件箱用户列表时，发现每次打开收件箱再关掉都会多处一个 iframe 来，随着打开收件箱的增多，iframe 增多到浏览器卡到无法运行，所以我在爬虫代码里加了删除无用 iframe 的脚本：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://webmail.vip.188.com'</span>);</span><br><span class="line">    <span class="comment">//注册一个 Node.js 函数，在浏览器里运行</span></span><br><span class="line">    <span class="keyword">await</span> page.exposeFunction(<span class="string">'md5'</span>, text =&gt;</span><br><span class="line">        crypto.createHash(<span class="string">'md5'</span>).update(text).digest(<span class="string">'hex'</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//通过 page.evaluate 在浏览器里执行删除无用的 iframe 代码</span></span><br><span class="line">    <span class="keyword">await</span> page.evaluate(<span class="keyword">async</span> () =&gt;  &#123;</span><br><span class="line">        <span class="keyword">let</span> iframes = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'iframe'</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">3</span>; i &lt;  iframes.length - <span class="number">1</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">let</span> iframe = iframes[i];</span><br><span class="line">            <span class="keyword">if</span>(iframe.name.includes(<span class="string">"frameBody"</span>))&#123;</span><br><span class="line">                iframe.src = <span class="string">'about:blank'</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    iframe.contentWindow.document.write(<span class="string">''</span>);</span><br><span class="line">                    iframe.contentWindow.document.clear();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">                <span class="comment">//把iframe从页面移除</span></span><br><span class="line">                iframe.parentNode.removeChild(iframe);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//在页面中调用 Node.js 环境中的函数</span></span><br><span class="line">        <span class="keyword">const</span> myHash = <span class="keyword">await</span> <span class="built_in">window</span>.md5(<span class="string">'PUPPETEER'</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`md5 of <span class="subst">$&#123;myString&#125;</span> is <span class="subst">$&#123;myHash&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>基于antd的鼠标拖拽失效问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dragAndDrop = <span class="keyword">async</span> (</span><br><span class="line">  page,</span><br><span class="line">  sourceX,</span><br><span class="line">  sourceY,</span><br><span class="line">  destinationX,</span><br><span class="line">  destinationY,</span><br><span class="line">  waitTime</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> page.evaluate(<span class="string">`(async (sourceX, sourceY, destinationX, destinationY, waitTime) =&gt; &#123;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 每步间隔</span></span><br><span class="line"><span class="string">        const sleep = (waitTime) =&gt; &#123;</span></span><br><span class="line"><span class="string">            waitTime = waitTime === null ? 10 : waitTime;</span></span><br><span class="line"><span class="string">            return new Promise(resolve =&gt; setTimeout(resolve, waitTime));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 获取起始位置的元素、定义被拖拽元素当前所在元素、定义被拖拽元素前一个所在元素</span></span><br><span class="line"><span class="string">        const elementDragged = document.elementFromPoint(sourceX, sourceY);</span></span><br><span class="line"><span class="string">        var elementDraggedOverNow = elementDragged;</span></span><br><span class="line"><span class="string">        var elementDraggedOverPrior = elementDraggedOverNow;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 创建 DataTransfer 对象</span></span><br><span class="line"><span class="string">        const dataTransfer = new DataTransfer();</span></span><br><span class="line"><span class="string">        dataTransfer.effectAllowed = 'all';</span></span><br><span class="line"><span class="string">        dataTransfer.dropEffect = 'move';</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 开始拖拽被拖拽元素触发 dragstart</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragstart', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 被拖拽元素进入可放置元素触发 dragenter</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragenter', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">        await sleep(waitTime);</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 拖拽被拖拽元素</span></span><br><span class="line"><span class="string">        const dragMove = async (x, y) =&gt; &#123;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">                new DragEvent('drag', &#123;</span></span><br><span class="line"><span class="string">                    dataTransfer,</span></span><br><span class="line"><span class="string">                    bubbles: true,</span></span><br><span class="line"><span class="string">                    clientX: x,</span></span><br><span class="line"><span class="string">                    clientY: y,</span></span><br><span class="line"><span class="string">                &#125;)</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            elementDraggedOverNow = document.elementFromPoint(x, y);</span></span><br><span class="line"><span class="string">            // 是否进入新元素，如果是，应触发前一个元素的 dragleave 和新元素的 dragenter</span></span><br><span class="line"><span class="string">            if (!elementDraggedOverNow.isSameNode(elementDraggedOverPrior)) &#123;</span></span><br><span class="line"><span class="string">                elementDraggedOverPrior.dispatchEvent(</span></span><br><span class="line"><span class="string">                    new DragEvent('dragleave', &#123;</span></span><br><span class="line"><span class="string">                        dataTransfer,</span></span><br><span class="line"><span class="string">                        bubbles: true,</span></span><br><span class="line"><span class="string">                        clientX: x,</span></span><br><span class="line"><span class="string">                        clientY: y,</span></span><br><span class="line"><span class="string">                    &#125;)</span></span><br><span class="line"><span class="string">                );</span></span><br><span class="line"><span class="string">                elementDraggedOverNow.dispatchEvent(</span></span><br><span class="line"><span class="string">                    new DragEvent('dragenter', &#123;</span></span><br><span class="line"><span class="string">                        dataTransfer,</span></span><br><span class="line"><span class="string">                        bubbles: true,</span></span><br><span class="line"><span class="string">                        clientX: x,</span></span><br><span class="line"><span class="string">                        clientY: y,</span></span><br><span class="line"><span class="string">                    &#125;)</span></span><br><span class="line"><span class="string">                );</span></span><br><span class="line"><span class="string">                elementDraggedOverPrior = elementDraggedOverNow;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            // 被拖拽元素在可放置元素上时触发 dragover</span></span><br><span class="line"><span class="string">            elementDraggedOverNow.dispatchEvent(</span></span><br><span class="line"><span class="string">                new DragEvent('dragover', &#123;</span></span><br><span class="line"><span class="string">                    dataTransfer,</span></span><br><span class="line"><span class="string">                    bubbles: true,</span></span><br><span class="line"><span class="string">                    clientX: x,</span></span><br><span class="line"><span class="string">                    clientY: y,</span></span><br><span class="line"><span class="string">                &#125;)</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            await sleep(waitTime);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        // 先水平拖拽</span></span><br><span class="line"><span class="string">        if (sourceX &lt;= destinationX) &#123;</span></span><br><span class="line"><span class="string">            for (let x = sourceX; x &lt;= destinationX; x++) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(x, sourceY);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            for (let x = sourceX; x &gt;= destinationX; x--) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(x, sourceY);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 再垂直拖拽</span></span><br><span class="line"><span class="string">        if (sourceY &lt;= destinationY) &#123;</span></span><br><span class="line"><span class="string">            for (let y = sourceY; y &lt;= destinationY; y++) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(destinationX, y);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            for (let y = sourceY; y &gt;= destinationY; y--) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(destinationX, y);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 在被拖拽元素当前所在的元素上放置被拖拽元素时触发 drop</span></span><br><span class="line"><span class="string">        elementDraggedOverNow.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('drop', &#123;</span></span><br><span class="line"><span class="string">                bubbles: true,</span></span><br><span class="line"><span class="string">                dataTransfer</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">        await sleep(waitTime);</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 结束拖拽被拖拽元素触发 dragend</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragend', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 当元素变得不再是拖动操作的选中目标时触发 dragexit</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragexit', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">        await sleep(waitTime);</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    &#125;)(<span class="subst">$&#123;sourceX&#125;</span>, <span class="subst">$&#123;sourceY&#125;</span>, <span class="subst">$&#123;destinationX&#125;</span>, <span class="subst">$&#123;destinationY&#125;</span>, <span class="subst">$&#123;waitTime&#125;</span>)`</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="case5-如何抓取-iframe-中的元素"><a href="#case5-如何抓取-iframe-中的元素" class="headerlink" title="case5: 如何抓取 iframe 中的元素"></a>case5: 如何抓取 iframe 中的元素</h3><p>一个 Frame 包含了一个执行上下文（Execution Context），我们不能跨 Frame 执行函数，一个页面中可以有多个 Frame，主要是通过 iframe 标签嵌入的生成的。其中在页面上的大部分函数其实是 page.mainFrame().xx 的一个简写，Frame 是树状结构，我们可以通过 frame.childFrames() 遍历到所有的 Frame，如果想在其它 Frame 中执行函数必须获取到对应的 Frame 才能进行相应的处理</p>
<p>以下是在登录 188 邮箱时，其登录窗口其实是嵌入的一个 iframe，以下代码时我们在获取 iframe 并进行登录</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;<span class="attr">headless</span>: <span class="literal">false</span>, <span class="attr">slowMo</span>: <span class="number">50</span>&#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.188.com'</span>);</span><br><span class="line">    <span class="comment">//点击使用密码登录</span></span><br><span class="line">    <span class="keyword">let</span> passwordLogin = <span class="keyword">await</span> page.waitForXPath(<span class="string">'//*[@id="qcode"]/div/div[2]/a'</span>);</span><br><span class="line">    <span class="keyword">await</span> passwordLogin.click();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> frame <span class="keyword">of</span> page.mainFrame().childFrames())&#123;</span><br><span class="line">        <span class="comment">//根据 url 找到登录页面对应的 iframe</span></span><br><span class="line">        <span class="keyword">if</span> (frame.url().includes(<span class="string">'passport.188.com'</span>))&#123;</span><br><span class="line">            <span class="keyword">await</span> frame.type(<span class="string">'.dlemail'</span>, <span class="string">'admin@admin.com'</span>);</span><br><span class="line">            <span class="keyword">await</span> frame.type(<span class="string">'.dlpwd'</span>, <span class="string">'123456'</span>);</span><br><span class="line">            <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">                frame.click(<span class="string">'#dologin'</span>),</span><br><span class="line">                page.waitForNavigation()</span><br><span class="line">            ]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="case7-文件的上传和下载"><a href="#case7-文件的上传和下载" class="headerlink" title="case7: 文件的上传和下载"></a>case7: 文件的上传和下载</h3><p>在自动化测试中，经常会遇到对于文件的上传和下载的需求，那么在 Puppeteer 中如何实现呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="comment">//通过 CDP 会话设置下载路径</span></span><br><span class="line">    <span class="keyword">const</span> cdp = <span class="keyword">await</span> page.target().createCDPSession();</span><br><span class="line">    <span class="keyword">await</span> cdp.send(<span class="string">'Page.setDownloadBehavior'</span>, &#123;</span><br><span class="line">        behavior: <span class="string">'allow'</span>, <span class="comment">//允许所有下载请求</span></span><br><span class="line">        downloadPath: <span class="string">'path/to/download'</span>  <span class="comment">//设置下载路径</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//点击按钮触发下载</span></span><br><span class="line">    <span class="keyword">await</span> (<span class="keyword">await</span> page.waitForSelector(<span class="string">'#someButton'</span>)).click();</span><br><span class="line">    <span class="comment">//等待文件出现，轮训判断文件是否出现</span></span><br><span class="line">    <span class="keyword">await</span> waitForFile(<span class="string">'path/to/download/filename'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上传时对应的 inputElement 必须是&lt;input&gt;元素</span></span><br><span class="line">    <span class="keyword">let</span> inputElement = <span class="keyword">await</span> page.waitForXPath(<span class="string">'//input[@type="file"]'</span>);</span><br><span class="line">    <span class="keyword">await</span> inputElement.uploadFile(<span class="string">'/path/to/file'</span>);</span><br><span class="line">    browser.close();</span><br><span class="line">    <span class="comment">// 如果需要上传多个文件 </span></span><br><span class="line">    <span class="comment">//  await inputElement.uploadFile('路径1','路径2' ...,'路径n');</span></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="case8：跳转新-tab-页处理"><a href="#case8：跳转新-tab-页处理" class="headerlink" title="case8：跳转新 tab 页处理"></a>case8：跳转新 tab 页处理</h3><p>在点击一个按钮跳转到新的 Tab 页时会新开一个页面，这个时候我们如何获取改页面对应的 Page 实例呢？可以通过监听 Browser 上的 targetcreated 事件来实现，表示有新的页面创建：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"><span class="keyword">await</span> page.goto(url);</span><br><span class="line"><span class="keyword">let</span> btn = <span class="keyword">await</span> page.waitForSelector(<span class="string">'#btn'</span>);</span><br><span class="line"><span class="comment">//在点击按钮之前，事先定义一个 Promise，用于返回新 tab 的 Page 对象</span></span><br><span class="line"><span class="keyword">const</span> newPagePromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">res</span> =&gt;</span> </span><br><span class="line">  browser.once(<span class="string">'targetcreated'</span>, </span><br><span class="line">    target =&gt; res(target.page())</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"><span class="keyword">await</span> btn.click();</span><br><span class="line"><span class="comment">//点击按钮后，等待新tab对象</span></span><br><span class="line"><span class="keyword">let</span> newPage = <span class="keyword">await</span> newPagePromise;</span><br></pre></td></tr></table></figure>

<h3 id="case9-模拟不同的设备"><a href="#case9-模拟不同的设备" class="headerlink" title="case9: 模拟不同的设备"></a>case9: 模拟不同的设备</h3><p>Puppeteer 提供了模拟不同设备的功能，其中 puppeteer.devices 对象上定义很多设备的配置信息，这些配置信息主要包含 viewport 和 userAgent，然后通过函数 page.emulate 实现不同设备的模拟</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> iPhone = puppeteer.devices[<span class="string">'iPhone 6'</span>];</span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.emulate(iPhone);</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://www.google.com'</span>);</span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong> 旧方法 (Puppeteer versions &lt;= v1.14.0) 中设备可以通过 <code>require(&#39;puppeteer/DeviceDescriptors&#39;)</code> 方法获得。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/01/08/electron%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/" rel="prev" title="electron入门学习">
      <i class="fa fa-chevron-left"></i> electron入门学习
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/01/12/%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/" rel="next" title="遇到的坑">
      遇到的坑 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#Puppeteer-是一个-Node-库，它提供了高级-API-来通过-DevTools-协议控制-Chromium-或-Chrome"><span class="nav-number">1.</span> <span class="nav-text">Puppeteer 是一个 Node 库，它提供了高级 API 来通过 DevTools 协议控制 Chromium 或 Chrome</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何创建一个-Browser-实例"><span class="nav-number">2.</span> <span class="nav-text">如何创建一个 Browser 实例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载导航页面"><span class="nav-number"></span> <span class="nav-text">加载导航页面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#等待元素、请求、响应"><span class="nav-number"></span> <span class="nav-text">等待元素、请求、响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#几个常用的案例"><span class="nav-number"></span> <span class="nav-text">几个常用的案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Case1：截图"><span class="nav-number"></span> <span class="nav-text">Case1：截图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case2-模拟用户登录"><span class="nav-number"></span> <span class="nav-text">case2: 模拟用户登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case3：请求拦截"><span class="nav-number"></span> <span class="nav-text">case3：请求拦截</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case4：植入-javascript-代码"><span class="nav-number"></span> <span class="nav-text">case4：植入 javascript 代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case5-如何抓取-iframe-中的元素"><span class="nav-number"></span> <span class="nav-text">case5: 如何抓取 iframe 中的元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case7-文件的上传和下载"><span class="nav-number"></span> <span class="nav-text">case7: 文件的上传和下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case8：跳转新-tab-页处理"><span class="nav-number"></span> <span class="nav-text">case8：跳转新 tab 页处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case9-模拟不同的设备"><span class="nav-number"></span> <span class="nav-text">case9: 模拟不同的设备</span></a></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="妮妮妮"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">妮妮妮</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/nini-hub" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nini-hub" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/490201490@qq.com" title="E-Mail → 490201490@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">妮妮妮</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>



        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
