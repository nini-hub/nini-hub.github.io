<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/favicon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"nini-hub.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="ninihub">
<meta property="og:url" content="https://nini-hub.github.io/index.html">
<meta property="og:site_name" content="ninihub">
<meta property="og:locale" content="zh">
<meta property="article:author" content="妮妮妮">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://nini-hub.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>ninihub</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="تشغيل شريط التصفح">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ninihub</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2021/01/12/%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/12/%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/" class="post-title-link" itemprop="url">遇到的坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>
              

              <time title="أُنشأ: 2021-01-12 10:06:34 / عُدل: 10:21:23" itemprop="dateCreated datePublished" datetime="2021-01-12T10:06:34+08:00">2021-01-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="gatsby搭建企业站，使用scrollreveal在元素滚动到视图中时对其进行动画处理，在执行gatsby-build的时候出现如下错误"><a href="#gatsby搭建企业站，使用scrollreveal在元素滚动到视图中时对其进行动画处理，在执行gatsby-build的时候出现如下错误" class="headerlink" title="gatsby搭建企业站，使用scrollreveal在元素滚动到视图中时对其进行动画处理，在执行gatsby build的时候出现如下错误"></a>gatsby搭建企业站，使用<code>scrollreveal</code>在元素滚动到视图中时对其进行动画处理，在执行<code>gatsby build</code>的时候出现如下错误</h4><p> ERROR #95312 </p>
<p>“window” is not available during server side rendering.</p>
<p>See our docs page for more info on this error: <a href="https://gatsby.dev/debug-html" target="_blank" rel="noopener">https://gatsby.dev/debug-html</a></p>
<p> })();</p>
<p> var index = window.requestAnimationFrame ||</p>
<p>window.webkitRequestAnimationFrame ||<br>window.mozRequestAnimationFrame ||<br>polyfill;</p>
<p>  WebpackError: ReferenceError: window is not defined</p>
<ul>
<li><p>miniraf.es.js:38<br>node_modules/miniraf/dist/miniraf.es.js:38:1</p>
</li>
<li><p>scrollreveal.es.js:1<br>node_modules/scrollreveal/dist/scrollreveal.es.js:1:1</p>
</li>
<li><p>service.js:1<br>src/components/home/service.js:1:1</p>
</li>
<li><p>index.js:1<br>src/pages/index.js:1:1</p>
</li>
</ul>
<p>not finished Generating image thumbnails - 18.303s</p>
<ol>
<li><p>问题分析</p>
<p>通常，由于以下原因之一，在生成静态HTML文件时发生错误：</p>
<ul>
<li><p>某些代码引用了“浏览器全局变量”，例如window或document。 如果这是您的问题，则应该在上面看到类似<code>window is not defined</code>的错误。 要解决此问题，请找出有问题的代码，或者</p>
<ul>
<li>在定义窗口之前调用此代码之前进行检查，以便在构建盖茨比时该代码无法运行（请参见下面的代码示例）；</li>
<li>如果该代码位于的render函数中 一个React.js组件，将该代码移动到componentDidMount生命周期或useEffect挂钩中，以确保该代码除非在浏览器中运行，否则不会运行</li>
</ul>
</li>
<li><p>检查页面目录（和所有子目录）中列出的每个JS文件是否正在导出React组件或字符串。 Gatsby会将页面目录下列出的所有JS文件都视为页面组件，因此它必须具有默认导出，即组件或字符串。</p>
</li>
<li><p>您混淆了导入，并要求在同一文件中进行调用。 由于webpack 4的版本比v3严格，因此这可能会导致“ WebpackError: Invariant Violation: Minified React error”。 解决方案是仅使用导入，这也扩展到gatsby-ssr和gatsby-browser文件。</p>
</li>
<li><p>您的应用程序未正确<a href="https://reactjs.org/docs/react-dom.html" target="_blank" rel="noopener">hydrated</a>，导致gatsby开发和gatsby构建不一致。 gatsby-ssr或gatsby-browser之类的文件中的更改很可能具有另一个文件中未反映的结构，这意味着客户端和服务器输出之间不匹配。</p>
</li>
</ul>
</li>
<li><p>解决方案</p>
<p>定位问题后，是使用了<code>scrollreveal</code>的原因，该模块期望定义window。 </p>
<ol>
<li><p>修复第三方模块的问题</p>
<p>一种解决方案是自定义Webpack配置，以在服务器渲染期间用虚拟模块替换有问题的模块。</p>
<p>项目根目录中的gatsby-node.js：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">exports.onCreateWebpackConfig = <span class="function">(<span class="params">&#123; stage, loaders, actions &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (stage === <span class="string">"build-html"</span>) &#123;</span><br><span class="line">    actions.setWebpackConfig(&#123;</span><br><span class="line">      <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">          &#123;</span><br><span class="line">            test: <span class="regexp">/bad-module/</span>, <span class="comment">// 写上问题模块 此处我的应该是`scrollreveal`</span></span><br><span class="line">            use: loaders.null(),</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ol>
<ol start="2">
<li>另一种解决方案是 <a href="https://github.com/gregberge/loadable-components" target="_blank" rel="noopener">loadable-components</a>. 尝试使用窗口的模块将仅在客户端动态加载（而不是在SSR期间加载).</li>
</ol>
<ol start="3">
<li><p>总结</p>
<p>当在Gatsby中使用带有window定义的第三方模块时，需要向其自己的webpack配置中添加一个空的loader，以避免在SSR（服务器端渲染）期间进行编译。 因为执行gatsby develop的环境是发生在浏览器中，而执行gatsby build是在Node服务器中（显然没有窗口或其他全局对象。）</p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2021/01/11/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B9%8Bpuppeteer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/11/%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%8B%E8%AF%95%E4%B9%8Bpuppeteer/" class="post-title-link" itemprop="url">自动化测试之puppeteer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>
              

              <time title="أُنشأ: 2021-01-11 13:57:29 / عُدل: 15:13:54" itemprop="dateCreated datePublished" datetime="2021-01-11T13:57:29+08:00">2021-01-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="Puppeteer-是一个-Node-库，它提供了高级-API-来通过-DevTools-协议控制-Chromium-或-Chrome"><a href="#Puppeteer-是一个-Node-库，它提供了高级-API-来通过-DevTools-协议控制-Chromium-或-Chrome" class="headerlink" title="Puppeteer 是一个 Node 库，它提供了高级 API 来通过 DevTools 协议控制 Chromium 或 Chrome"></a>Puppeteer 是一个 Node 库，它提供了高级 API 来通过 DevTools 协议控制 Chromium 或 Chrome</h4><h4 id="如何创建一个-Browser-实例"><a href="#如何创建一个-Browser-实例" class="headerlink" title="如何创建一个 Browser 实例"></a>如何创建一个 Browser 实例</h4><p>puppeteer 提供了两种方法用于创建一个 Browser 实例：</p>
<ul>
<li>puppeteer.connect: 连接一个已经存在的 Chrome 实例</li>
<li>puppeteer.launch: 每次都启动一个 Chrome 实例</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用 puppeteer.launch 启动 Chrome</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">        headless: <span class="literal">false</span>,   <span class="comment">//有浏览器界面启动</span></span><br><span class="line">        slowMo: <span class="number">100</span>,       <span class="comment">//放慢浏览器执行速度，方便测试观察</span></span><br><span class="line">        args: [            <span class="comment">//启动 Chrome 的参数，详见上文中的介绍</span></span><br><span class="line">            <span class="string">'–no-sandbox'</span>,</span><br><span class="line">            <span class="string">'--window-size=1280,960'</span></span><br><span class="line">        ],</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.baidu.com'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 puppeteer.connect 连接一个已经存在的 Chrome 实例</span></span><br><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="comment">//通过 9222 端口的 http 接口获取对应的 websocketUrl</span></span><br><span class="line">    <span class="keyword">let</span> version = <span class="keyword">await</span> request(&#123;</span><br><span class="line">        uri:  <span class="string">"http://127.0.0.1:9222/json/version"</span>,</span><br><span class="line">        json: <span class="literal">true</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//直接连接已经存在的 Chrome</span></span><br><span class="line">    <span class="keyword">let</span> browser = <span class="keyword">await</span> puppeteer.connect(&#123;</span><br><span class="line">        browserWSEndpoint: version.webSocketDebuggerUrl</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.baidu.com'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.disconnect();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>这两种方式的对比：</p>
<ul>
<li>puppeteer.launch 每次都要重新启动一个 Chrome 进程，启动平均耗时 100 到 150 ms，性能欠佳</li>
<li>puppeteer.connect 可以实现对于同一个 Chrome 实例的共用，减少启动关闭浏览器的时间消耗</li>
<li>puppeteer.launch 启动时参数可以动态修改</li>
<li>通过 puppeteer.connect 我们可以远程连接一个 Chrome 实例，部署在不同的机器上</li>
<li>puppeteer.connect 多个页面共用一个 chrome 实例，偶尔会出现 Page Crash 现象，需要进行并发控制，并定时重启 Chrome 实例</li>
</ul>
<h3 id="加载导航页面"><a href="#加载导航页面" class="headerlink" title="加载导航页面"></a>加载导航页面</h3><ul>
<li>page.goto：打开新页面</li>
<li>page.goBack ：回退到上一个页面</li>
<li>page.goForward ：前进到下一个页面</li>
<li>page.reload ：重新加载页面</li>
<li>page.waitForNavigation：等待页面跳转</li>
</ul>
<p>Pupeeteer 中的基本上所有的操作都是异步的，以上几个 API 都涉及到关于打开一个页面，什么情况下才能判断这个函数执行完毕呢，这些函数都提供了两个参数 waitUtil 和 timeout，waitUtil 表示直到什么出现就算执行完毕，timeout 表示如果超过这个时间还没有结束就抛出异常。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.goto(<span class="string">'https://www.baidu.com'</span>, &#123;</span><br><span class="line">   timeout: <span class="number">30</span> * <span class="number">1000</span>,</span><br><span class="line">   waitUntil: [</span><br><span class="line">       <span class="string">'load'</span>,              <span class="comment">//等待 “load” 事件触发</span></span><br><span class="line">       <span class="string">'domcontentloaded'</span>,  <span class="comment">//等待 “domcontentloaded” 事件触发</span></span><br><span class="line">       <span class="string">'networkidle0'</span>,      <span class="comment">//在 500ms 内没有任何网络连接</span></span><br><span class="line">       <span class="string">'networkidle2'</span>       <span class="comment">//在 500ms 内网络连接个数不超过 2 个</span></span><br><span class="line">   ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>以上 waitUtil 有四个事件，业务可以根据需求来设置其中一个或者多个触发才以为结束，networkidle0 和 networkidle2 中的 500ms 对时间性能要求高的用户来说，还是有点长的</p>
<h3 id="等待元素、请求、响应"><a href="#等待元素、请求、响应" class="headerlink" title="等待元素、请求、响应"></a>等待元素、请求、响应</h3><ul>
<li>page.waitForXPath：等待 xPath 对应的元素出现，返回对应的 ElementHandle 实例</li>
<li>page.waitForSelector ：等待选择器对应的元素出现，返回对应的 ElementHandle 实例</li>
<li>page.waitForResponse ：等待某个响应结束，返回 Response 实例</li>
<li>page.waitForRequest：等待某个请求出现，返回 Request 实例</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.waitForXPath(<span class="string">'//img'</span>);</span><br><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">'#uniqueId'</span>);</span><br><span class="line"><span class="keyword">await</span> page.waitForResponse(<span class="string">'https://d.youdata.netease.com/api/dash/hello'</span>);</span><br><span class="line"><span class="keyword">await</span> page.waitForRequest(<span class="string">'https://d.youdata.netease.com/api/dash/hello'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="几个常用的案例"><a href="#几个常用的案例" class="headerlink" title="几个常用的案例"></a>几个常用的案例</h3><h3 id="Case1：截图"><a href="#Case1：截图" class="headerlink" title="Case1：截图"></a>Case1：截图</h3><p>我们使用 Puppeteer 既可以对某个页面进行截图，也可以对页面中的某个元素进行截图：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="comment">//设置可视区域大小</span></span><br><span class="line">    <span class="keyword">await</span> page.setViewport(&#123;<span class="attr">width</span>: <span class="number">1920</span>, <span class="attr">height</span>: <span class="number">800</span>&#125;);</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://youdata.163.com'</span>);</span><br><span class="line">    <span class="comment">//对整个页面截图</span></span><br><span class="line">    <span class="keyword">await</span> page.screenshot(&#123;</span><br><span class="line">        path: <span class="string">'./files/capture.png'</span>,  <span class="comment">//图片保存路径</span></span><br><span class="line">        type: <span class="string">'png'</span>,</span><br><span class="line">        fullPage: <span class="literal">true</span> <span class="comment">//边滚动边截图</span></span><br><span class="line">        <span class="comment">// clip: &#123;x: 0, y: 0, width: 1920, height: 800&#125;</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//对页面某个元素截图</span></span><br><span class="line">    <span class="keyword">let</span> [element] = <span class="keyword">await</span> page.$x(<span class="string">'/html/body/section[4]/div/div[2]'</span>);</span><br><span class="line">    <span class="keyword">await</span> element.screenshot(&#123;</span><br><span class="line">        path: <span class="string">'./files/element.png'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>我们怎么去获取页面中的某个元素呢？</p>
<ul>
<li>page.$(‘#uniqueId’)：获取某个选择器对应的第一个元素</li>
<li>page.$$(‘div’)：获取某个选择器对应的所有元素</li>
<li>page.$x(‘//img’)：获取某个 xPath 对应的所有元素</li>
<li>page.waitForXPath(‘//img’)：等待某个 xPath 对应的元素出现</li>
<li>page.waitForSelector(‘#uniqueId’)：等待某个选择器对应的元素出现</li>
</ul>
<h3 id="case2-模拟用户登录"><a href="#case2-模拟用户登录" class="headerlink" title="case2: 模拟用户登录"></a>case2: 模拟用户登录</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;</span><br><span class="line">        slowMo: <span class="number">100</span>,    <span class="comment">//放慢速度</span></span><br><span class="line">        headless: <span class="literal">false</span>,</span><br><span class="line">        defaultViewport: &#123;<span class="attr">width</span>: <span class="number">1440</span>, <span class="attr">height</span>: <span class="number">780</span>&#125;,</span><br><span class="line">        ignoreHTTPSErrors: <span class="literal">false</span>, <span class="comment">//忽略 https 报错</span></span><br><span class="line">        args: [<span class="string">'--start-fullscreen'</span>] <span class="comment">//全屏打开页面</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://demo.youdata.com'</span>);</span><br><span class="line">    <span class="comment">//输入账号密码</span></span><br><span class="line">    <span class="keyword">const</span> uniqueIdElement = <span class="keyword">await</span> page.$(<span class="string">'#uniqueId'</span>);</span><br><span class="line">    <span class="keyword">await</span> uniqueIdElement.type(<span class="string">'admin@admin.com'</span>, &#123;<span class="attr">delay</span>: <span class="number">20</span>&#125;);</span><br><span class="line">    <span class="keyword">const</span> passwordElement = <span class="keyword">await</span> page.$(<span class="string">'#password'</span>, &#123;<span class="attr">delay</span>: <span class="number">20</span>&#125;);</span><br><span class="line">    <span class="keyword">await</span> passwordElement.type(<span class="string">'123456'</span>);</span><br><span class="line">    <span class="comment">//点击确定按钮进行登录</span></span><br><span class="line">    <span class="keyword">let</span> okButtonElement = <span class="keyword">await</span> page.$(<span class="string">'#btn-ok'</span>);</span><br><span class="line">    <span class="comment">//等待页面跳转完成，一般点击某个按钮需要跳转时，都需要等待 page.waitForNavigation() 执行完毕才表示跳转成功</span></span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">        okButtonElement.click(),</span><br><span class="line">        page.waitForNavigation()  </span><br><span class="line">    ]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'admin 登录成功'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>那么 ElementHandle 都提供了哪些操作元素的函数呢？</p>
<ul>
<li>elementHandle.click()：点击某个元素</li>
<li>elementHandle.tap()：模拟手指触摸点击</li>
<li>elementHandle.focus()：聚焦到某个元素</li>
<li>elementHandle.hover()：鼠标 hover 到某个元素上</li>
<li>elementHandle.type(‘hello’)：在输入框输入文本</li>
</ul>
<h3 id="case3：请求拦截"><a href="#case3：请求拦截" class="headerlink" title="case3：请求拦截"></a>case3：请求拦截</h3><p>请求在有些场景下很有必要，拦截一下没必要的请求提高性能，我们可以在监听 Page 的 request 事件，并进行请求拦截，前提是要开启请求拦截 page.setRequestInterception(true)。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">const</span> blockTypes = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">'image'</span>, <span class="string">'media'</span>, <span class="string">'font'</span>]);</span><br><span class="line">    <span class="keyword">await</span> page.setRequestInterception(<span class="literal">true</span>); <span class="comment">//开启请求拦截</span></span><br><span class="line">    page.on(<span class="string">'request'</span>, request =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> type = request.resourceType();</span><br><span class="line">        <span class="keyword">const</span> shouldBlock = blockTypes.has(type);</span><br><span class="line">        <span class="keyword">if</span>(shouldBlock)&#123;</span><br><span class="line">            <span class="comment">//直接阻止请求</span></span><br><span class="line">            <span class="keyword">return</span> request.abort();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//对请求重写</span></span><br><span class="line">            <span class="keyword">return</span> request.continue(&#123;</span><br><span class="line">                <span class="comment">//可以对 url，method，postData，headers 进行覆盖</span></span><br><span class="line">                headers: <span class="built_in">Object</span>.assign(&#123;&#125;, request.headers(), &#123;</span><br><span class="line">                    <span class="string">'puppeteer-test'</span>: <span class="string">'true'</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://demo.youdata.com'</span>);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>那 page 页面上都提供了哪些事件呢？</p>
<ul>
<li>page.on(‘close’) 页面关闭</li>
<li>page.on(‘console’) console API 被调用</li>
<li>page.on(‘error’) 页面出错</li>
<li>page.on(‘load’) 页面加载完</li>
<li>page.on(‘request’) 收到请求</li>
<li>page.on(‘requestfailed’) 请求失败</li>
<li>page.on(‘requestfinished’) 请求成功</li>
<li>page.on(‘response’) 收到响应</li>
<li>page.on(‘workercreated’) 创建 webWorker</li>
<li>page.on(‘workerdestroyed’) 销毁 webWorker</li>
</ul>
<h3 id="case4：植入-javascript-代码"><a href="#case4：植入-javascript-代码" class="headerlink" title="case4：植入 javascript 代码"></a>case4：植入 javascript 代码</h3><p>Puppeteer 最强大的功能是，你可以在浏览器里执行任何你想要运行的 javascript 代码，下面是我在爬 188 邮箱的收件箱用户列表时，发现每次打开收件箱再关掉都会多处一个 iframe 来，随着打开收件箱的增多，iframe 增多到浏览器卡到无法运行，所以我在爬虫代码里加了删除无用 iframe 的脚本：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://webmail.vip.188.com'</span>);</span><br><span class="line">    <span class="comment">//注册一个 Node.js 函数，在浏览器里运行</span></span><br><span class="line">    <span class="keyword">await</span> page.exposeFunction(<span class="string">'md5'</span>, text =&gt;</span><br><span class="line">        crypto.createHash(<span class="string">'md5'</span>).update(text).digest(<span class="string">'hex'</span>)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//通过 page.evaluate 在浏览器里执行删除无用的 iframe 代码</span></span><br><span class="line">    <span class="keyword">await</span> page.evaluate(<span class="keyword">async</span> () =&gt;  &#123;</span><br><span class="line">        <span class="keyword">let</span> iframes = <span class="built_in">document</span>.getElementsByTagName(<span class="string">'iframe'</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">3</span>; i &lt;  iframes.length - <span class="number">1</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">let</span> iframe = iframes[i];</span><br><span class="line">            <span class="keyword">if</span>(iframe.name.includes(<span class="string">"frameBody"</span>))&#123;</span><br><span class="line">                iframe.src = <span class="string">'about:blank'</span>;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    iframe.contentWindow.document.write(<span class="string">''</span>);</span><br><span class="line">                    iframe.contentWindow.document.clear();</span><br><span class="line">                &#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">                <span class="comment">//把iframe从页面移除</span></span><br><span class="line">                iframe.parentNode.removeChild(iframe);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//在页面中调用 Node.js 环境中的函数</span></span><br><span class="line">        <span class="keyword">const</span> myHash = <span class="keyword">await</span> <span class="built_in">window</span>.md5(<span class="string">'PUPPETEER'</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`md5 of <span class="subst">$&#123;myString&#125;</span> is <span class="subst">$&#123;myHash&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>基于antd的鼠标拖拽失效问题</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dragAndDrop = <span class="keyword">async</span> (</span><br><span class="line">  page,</span><br><span class="line">  sourceX,</span><br><span class="line">  sourceY,</span><br><span class="line">  destinationX,</span><br><span class="line">  destinationY,</span><br><span class="line">  waitTime</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> page.evaluate(<span class="string">`(async (sourceX, sourceY, destinationX, destinationY, waitTime) =&gt; &#123;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 每步间隔</span></span><br><span class="line"><span class="string">        const sleep = (waitTime) =&gt; &#123;</span></span><br><span class="line"><span class="string">            waitTime = waitTime === null ? 10 : waitTime;</span></span><br><span class="line"><span class="string">            return new Promise(resolve =&gt; setTimeout(resolve, waitTime));</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 获取起始位置的元素、定义被拖拽元素当前所在元素、定义被拖拽元素前一个所在元素</span></span><br><span class="line"><span class="string">        const elementDragged = document.elementFromPoint(sourceX, sourceY);</span></span><br><span class="line"><span class="string">        var elementDraggedOverNow = elementDragged;</span></span><br><span class="line"><span class="string">        var elementDraggedOverPrior = elementDraggedOverNow;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 创建 DataTransfer 对象</span></span><br><span class="line"><span class="string">        const dataTransfer = new DataTransfer();</span></span><br><span class="line"><span class="string">        dataTransfer.effectAllowed = 'all';</span></span><br><span class="line"><span class="string">        dataTransfer.dropEffect = 'move';</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 开始拖拽被拖拽元素触发 dragstart</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragstart', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 被拖拽元素进入可放置元素触发 dragenter</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragenter', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">        await sleep(waitTime);</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 拖拽被拖拽元素</span></span><br><span class="line"><span class="string">        const dragMove = async (x, y) =&gt; &#123;</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">                new DragEvent('drag', &#123;</span></span><br><span class="line"><span class="string">                    dataTransfer,</span></span><br><span class="line"><span class="string">                    bubbles: true,</span></span><br><span class="line"><span class="string">                    clientX: x,</span></span><br><span class="line"><span class="string">                    clientY: y,</span></span><br><span class="line"><span class="string">                &#125;)</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            elementDraggedOverNow = document.elementFromPoint(x, y);</span></span><br><span class="line"><span class="string">            // 是否进入新元素，如果是，应触发前一个元素的 dragleave 和新元素的 dragenter</span></span><br><span class="line"><span class="string">            if (!elementDraggedOverNow.isSameNode(elementDraggedOverPrior)) &#123;</span></span><br><span class="line"><span class="string">                elementDraggedOverPrior.dispatchEvent(</span></span><br><span class="line"><span class="string">                    new DragEvent('dragleave', &#123;</span></span><br><span class="line"><span class="string">                        dataTransfer,</span></span><br><span class="line"><span class="string">                        bubbles: true,</span></span><br><span class="line"><span class="string">                        clientX: x,</span></span><br><span class="line"><span class="string">                        clientY: y,</span></span><br><span class="line"><span class="string">                    &#125;)</span></span><br><span class="line"><span class="string">                );</span></span><br><span class="line"><span class="string">                elementDraggedOverNow.dispatchEvent(</span></span><br><span class="line"><span class="string">                    new DragEvent('dragenter', &#123;</span></span><br><span class="line"><span class="string">                        dataTransfer,</span></span><br><span class="line"><span class="string">                        bubbles: true,</span></span><br><span class="line"><span class="string">                        clientX: x,</span></span><br><span class="line"><span class="string">                        clientY: y,</span></span><br><span class="line"><span class="string">                    &#125;)</span></span><br><span class="line"><span class="string">                );</span></span><br><span class="line"><span class="string">                elementDraggedOverPrior = elementDraggedOverNow;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">            // 被拖拽元素在可放置元素上时触发 dragover</span></span><br><span class="line"><span class="string">            elementDraggedOverNow.dispatchEvent(</span></span><br><span class="line"><span class="string">                new DragEvent('dragover', &#123;</span></span><br><span class="line"><span class="string">                    dataTransfer,</span></span><br><span class="line"><span class="string">                    bubbles: true,</span></span><br><span class="line"><span class="string">                    clientX: x,</span></span><br><span class="line"><span class="string">                    clientY: y,</span></span><br><span class="line"><span class="string">                &#125;)</span></span><br><span class="line"><span class="string">            );</span></span><br><span class="line"><span class="string">            await sleep(waitTime);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        // 先水平拖拽</span></span><br><span class="line"><span class="string">        if (sourceX &lt;= destinationX) &#123;</span></span><br><span class="line"><span class="string">            for (let x = sourceX; x &lt;= destinationX; x++) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(x, sourceY);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            for (let x = sourceX; x &gt;= destinationX; x--) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(x, sourceY);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 再垂直拖拽</span></span><br><span class="line"><span class="string">        if (sourceY &lt;= destinationY) &#123;</span></span><br><span class="line"><span class="string">            for (let y = sourceY; y &lt;= destinationY; y++) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(destinationX, y);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125; else &#123;</span></span><br><span class="line"><span class="string">            for (let y = sourceY; y &gt;= destinationY; y--) &#123;</span></span><br><span class="line"><span class="string">                await dragMove(destinationX, y);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 在被拖拽元素当前所在的元素上放置被拖拽元素时触发 drop</span></span><br><span class="line"><span class="string">        elementDraggedOverNow.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('drop', &#123;</span></span><br><span class="line"><span class="string">                bubbles: true,</span></span><br><span class="line"><span class="string">                dataTransfer</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">        await sleep(waitTime);</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 结束拖拽被拖拽元素触发 dragend</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragend', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">        // 当元素变得不再是拖动操作的选中目标时触发 dragexit</span></span><br><span class="line"><span class="string">        elementDragged.dispatchEvent(</span></span><br><span class="line"><span class="string">            new DragEvent('dragexit', &#123;</span></span><br><span class="line"><span class="string">                dataTransfer,</span></span><br><span class="line"><span class="string">                bubbles: true</span></span><br><span class="line"><span class="string">            &#125;)</span></span><br><span class="line"><span class="string">        );</span></span><br><span class="line"><span class="string">        await sleep(waitTime);</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    &#125;)(<span class="subst">$&#123;sourceX&#125;</span>, <span class="subst">$&#123;sourceY&#125;</span>, <span class="subst">$&#123;destinationX&#125;</span>, <span class="subst">$&#123;destinationY&#125;</span>, <span class="subst">$&#123;waitTime&#125;</span>)`</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="case5-如何抓取-iframe-中的元素"><a href="#case5-如何抓取-iframe-中的元素" class="headerlink" title="case5: 如何抓取 iframe 中的元素"></a>case5: 如何抓取 iframe 中的元素</h3><p>一个 Frame 包含了一个执行上下文（Execution Context），我们不能跨 Frame 执行函数，一个页面中可以有多个 Frame，主要是通过 iframe 标签嵌入的生成的。其中在页面上的大部分函数其实是 page.mainFrame().xx 的一个简写，Frame 是树状结构，我们可以通过 frame.childFrames() 遍历到所有的 Frame，如果想在其它 Frame 中执行函数必须获取到对应的 Frame 才能进行相应的处理</p>
<p>以下是在登录 188 邮箱时，其登录窗口其实是嵌入的一个 iframe，以下代码时我们在获取 iframe 并进行登录</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(&#123;<span class="attr">headless</span>: <span class="literal">false</span>, <span class="attr">slowMo</span>: <span class="number">50</span>&#125;);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">await</span> page.goto(<span class="string">'https://www.188.com'</span>);</span><br><span class="line">    <span class="comment">//点击使用密码登录</span></span><br><span class="line">    <span class="keyword">let</span> passwordLogin = <span class="keyword">await</span> page.waitForXPath(<span class="string">'//*[@id="qcode"]/div/div[2]/a'</span>);</span><br><span class="line">    <span class="keyword">await</span> passwordLogin.click();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> frame <span class="keyword">of</span> page.mainFrame().childFrames())&#123;</span><br><span class="line">        <span class="comment">//根据 url 找到登录页面对应的 iframe</span></span><br><span class="line">        <span class="keyword">if</span> (frame.url().includes(<span class="string">'passport.188.com'</span>))&#123;</span><br><span class="line">            <span class="keyword">await</span> frame.type(<span class="string">'.dlemail'</span>, <span class="string">'admin@admin.com'</span>);</span><br><span class="line">            <span class="keyword">await</span> frame.type(<span class="string">'.dlpwd'</span>, <span class="string">'123456'</span>);</span><br><span class="line">            <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">                frame.click(<span class="string">'#dologin'</span>),</span><br><span class="line">                page.waitForNavigation()</span><br><span class="line">            ]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="case7-文件的上传和下载"><a href="#case7-文件的上传和下载" class="headerlink" title="case7: 文件的上传和下载"></a>case7: 文件的上传和下载</h3><p>在自动化测试中，经常会遇到对于文件的上传和下载的需求，那么在 Puppeteer 中如何实现呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch();</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="comment">//通过 CDP 会话设置下载路径</span></span><br><span class="line">    <span class="keyword">const</span> cdp = <span class="keyword">await</span> page.target().createCDPSession();</span><br><span class="line">    <span class="keyword">await</span> cdp.send(<span class="string">'Page.setDownloadBehavior'</span>, &#123;</span><br><span class="line">        behavior: <span class="string">'allow'</span>, <span class="comment">//允许所有下载请求</span></span><br><span class="line">        downloadPath: <span class="string">'path/to/download'</span>  <span class="comment">//设置下载路径</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//点击按钮触发下载</span></span><br><span class="line">    <span class="keyword">await</span> (<span class="keyword">await</span> page.waitForSelector(<span class="string">'#someButton'</span>)).click();</span><br><span class="line">    <span class="comment">//等待文件出现，轮训判断文件是否出现</span></span><br><span class="line">    <span class="keyword">await</span> waitForFile(<span class="string">'path/to/download/filename'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//上传时对应的 inputElement 必须是&lt;input&gt;元素</span></span><br><span class="line">    <span class="keyword">let</span> inputElement = <span class="keyword">await</span> page.waitForXPath(<span class="string">'//input[@type="file"]'</span>);</span><br><span class="line">    <span class="keyword">await</span> inputElement.uploadFile(<span class="string">'/path/to/file'</span>);</span><br><span class="line">    browser.close();</span><br><span class="line">    <span class="comment">// 如果需要上传多个文件 </span></span><br><span class="line">    <span class="comment">//  await inputElement.uploadFile('路径1','路径2' ...,'路径n');</span></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="case8：跳转新-tab-页处理"><a href="#case8：跳转新-tab-页处理" class="headerlink" title="case8：跳转新 tab 页处理"></a>case8：跳转新 tab 页处理</h3><p>在点击一个按钮跳转到新的 Tab 页时会新开一个页面，这个时候我们如何获取改页面对应的 Page 实例呢？可以通过监听 Browser 上的 targetcreated 事件来实现，表示有新的页面创建：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"><span class="keyword">await</span> page.goto(url);</span><br><span class="line"><span class="keyword">let</span> btn = <span class="keyword">await</span> page.waitForSelector(<span class="string">'#btn'</span>);</span><br><span class="line"><span class="comment">//在点击按钮之前，事先定义一个 Promise，用于返回新 tab 的 Page 对象</span></span><br><span class="line"><span class="keyword">const</span> newPagePromise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">res</span> =&gt;</span> </span><br><span class="line">  browser.once(<span class="string">'targetcreated'</span>, </span><br><span class="line">    target =&gt; res(target.page())</span><br><span class="line">  )</span><br><span class="line">);</span><br><span class="line"><span class="keyword">await</span> btn.click();</span><br><span class="line"><span class="comment">//点击按钮后，等待新tab对象</span></span><br><span class="line"><span class="keyword">let</span> newPage = <span class="keyword">await</span> newPagePromise;</span><br></pre></td></tr></table></figure>

<h3 id="case9-模拟不同的设备"><a href="#case9-模拟不同的设备" class="headerlink" title="case9: 模拟不同的设备"></a>case9: 模拟不同的设备</h3><p>Puppeteer 提供了模拟不同设备的功能，其中 puppeteer.devices 对象上定义很多设备的配置信息，这些配置信息主要包含 viewport 和 userAgent，然后通过函数 page.emulate 实现不同设备的模拟</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">'puppeteer'</span>);</span><br><span class="line"><span class="keyword">const</span> iPhone = puppeteer.devices[<span class="string">'iPhone 6'</span>];</span><br><span class="line">puppeteer.launch().then(<span class="keyword">async</span> browser =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">  <span class="keyword">await</span> page.emulate(iPhone);</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">'https://www.google.com'</span>);</span><br><span class="line">  <span class="keyword">await</span> browser.close();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong> 旧方法 (Puppeteer versions &lt;= v1.14.0) 中设备可以通过 <code>require(&#39;puppeteer/DeviceDescriptors&#39;)</code> 方法获得。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2021/01/08/electron%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/08/electron%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">electron入门学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>

              <time title="أُنشأ: 2021-01-08 14:39:24" itemprop="dateCreated datePublished" datetime="2021-01-08T14:39:24+08:00">2021-01-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">عُدل في</span>
                <time title="عُدل: 2021-01-11 15:14:38" itemprop="dateModified" datetime="2021-01-11T15:14:38+08:00">2021-01-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="electron"><a href="#electron" class="headerlink" title="electron"></a>electron</h2><p>Electron 是一个能让你使用 JavaScript, HTML 和 CSS 来创建桌面应用程序的框架。 这些应用程序可以打包后在 macOS、Windows 和 Linux 上直接运行，或者通过 Mac App Store 或微软商店进行分发。</p>
<p>通常，你可以使用操作系统 (OS) 特定的本地应用程序框架来创建一个桌面应用程序。 Electron 可以使用你了解的技术来编写应用程序。</p>
<p>Electron = Chromium + Node.js + Native API</p>
<h4 id="安装-Electron"><a href="#安装-Electron" class="headerlink" title="安装 Electron"></a>安装 Electron</h4><p>为您的项目创建一个文件夹并安装 Electron：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir my-electron-app &amp;&amp; cd my-electron-app</span><br><span class="line">npm init -y</span><br><span class="line">npm i --save-dev electron</span><br></pre></td></tr></table></figure>

<p>——暂未更新</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2020/12/16/Eggjs%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/16/Eggjs%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Eggjs入门学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>

              <time title="أُنشأ: 2020-12-16 17:04:17" itemprop="dateCreated datePublished" datetime="2020-12-16T17:04:17+08:00">2020-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">عُدل في</span>
                <time title="عُدل: 2021-01-11 15:48:28" itemprop="dateModified" datetime="2021-01-11T15:48:28+08:00">2021-01-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h4><ol>
<li><p>什么是Egg.js?</p>
<ul>
<li><p>Express是基于ES5的web开发框架</p>
</li>
<li><p>Koa1.x是Express原班人马打造的基于ES6的web开发框架</p>
</li>
<li><p>Koa2.x是Express原班人马打造的基于ES7的web开发框架</p>
</li>
<li><p>Egg是’阿里巴巴’基于Koa的’有约束和规范’的’企业级web开发框架’</p>
</li>
</ul>
<p>三个框架之间的关系其实是一部’编程界的进化论’</p>
</li>
<li><p>Egg.js发展史</p>
<p>2013 年蚂蚁的 chair 框架，可以视为 egg 的前身。</p>
<p>2015 年 11 月，在苏千的召集下，阿里各 BU(Business Unit) 的前端骨干齐聚黄龙，闭门共建。</p>
<p>2016 年中，广泛使用在绝大部分阿里的前端 Node.js 应用。</p>
<p>2016 年 09 月，在 JSConf China 2016 上亮相并宣布开源。</p>
<p>2017 年初，官网文档 egg - 为企业级框架和应用而生 亮相</p>
</li>
<li><p>Egg.js在阿里的应用</p>
<p>阿里旗下蚂蚁金服，天猫，UCWeb，村淘，神马搜索等项目的基础框架都是在 egg 之上扩展的</p>
</li>
<li><p>为什么是Egg, 而不是Express或Koa?</p>
<ul>
<li><p>Express 和 Koa没有约束和规范, 会导致团队的沟通成本和项目的维护成本变高</p>
<p>EggJS有约束和规范, 会大大降低团队的沟通成本和项目的维护成本</p>
</li>
<li><p>阿里内部大量企业级项目使用egg开发, 实践出真知</p>
</li>
<li><p>Node社区5位国人核心贡献者4人在阿里, 技术有保障</p>
</li>
<li><p>阿里前端安全专家，负责 egg-security 等 类库, 安全有保障</p>
</li>
</ul>
</li>
<li><p>什么是有约束和规范?</p>
<p>和ESLint检查JS代码一样, 有一套标准, 必须严格遵守这套标准 ,否则就会报错</p>
<p><a href="https://eggjs.org/zh-cn/basics/structure.html" target="_blank" rel="noopener">https://eggjs.org/zh-cn/basics/structure.html</a></p>
</li>
<li><p>什么是MVC?</p>
<p>M(Model)   :处理应用程序’数据逻辑’的部分(service)</p>
<p>V(View)   :处理数据显示的部分(静态/动态网页)</p>
<p>C(Controller):处理应用程序业务逻辑, 数据和页面的桥梁(controller)</p>
<p>推荐阅读: <a href="https://github.com/atian25/blog/issues/18" target="_blank" rel="noopener">https://github.com/atian25/blog/issues/18</a></p>
</li>
</ol>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><h5 id="手动安装手动配置"><a href="#手动安装手动配置" class="headerlink" title="手动安装手动配置"></a>手动安装手动配置</h5><ol>
<li><p><code>npm init --y</code></p>
</li>
<li><p><code>npm i egg --save</code> 其中egg模块就是egg.js的核心模块</p>
</li>
<li><p><code>npm i egg-bin --save-dev</code> 其中egg-bin用于快速启动项目，用于本地开发调试</p>
</li>
<li><p>scripts脚本中</p>
<p><code>“dev”:&quot;egg-bin dev”</code></p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">基本目录</span><br><span class="line">egg-example</span><br><span class="line">├── app  #开发目录</span><br><span class="line">│   ├── controller</span><br><span class="line">│   │   └── home.js</span><br><span class="line">│   └── router.js</span><br><span class="line">├── config  #配置目录</span><br><span class="line">│   └── config.default.js</span><br><span class="line">└── package.json</span><br></pre></td></tr></table></figure>

<p>config/config.default.js中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exports.keys  = <span class="string">'nini'</span>; <span class="comment">// 用户生成客户端中保存的userID</span></span><br></pre></td></tr></table></figure>

<p>app/router.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在router.js中必须暴露出去一个方法, 这个方法接收一个参数, 这个参数就是服务端的实例对象</span></span><br><span class="line"><span class="comment">// console.log(app);</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">      env: 'local',</span></span><br><span class="line"><span class="comment">      name: 'egg-example',</span></span><br><span class="line"><span class="comment">      baseDir: 'C:\\Users\\Jonathan_Lee\\Desktop\\Node_Common\\egg-example',</span></span><br><span class="line"><span class="comment">      subdomainOffset: 2,</span></span><br><span class="line"><span class="comment">      config: '&lt;egg config&gt;',</span></span><br><span class="line"><span class="comment">      controller: '&lt;egg controller&gt;',</span></span><br><span class="line"><span class="comment">      httpclient: '&lt;egg httpclient&gt;',</span></span><br><span class="line"><span class="comment">      loggers: '&lt;egg loggers&gt;',</span></span><br><span class="line"><span class="comment">      middlewares: '&lt;egg middlewares&gt;',</span></span><br><span class="line"><span class="comment">      router: '&lt;egg router&gt;',</span></span><br><span class="line"><span class="comment">      serviceClasses: '&lt;egg serviceClasses&gt;'</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="comment">// 1.从服务端的实例对象中解构出处理路由的对象和处理控制器的对象</span></span><br><span class="line">    <span class="keyword">const</span> &#123;router, controller&#125; = app;</span><br><span class="line">    <span class="comment">// 2.利用处理路由的对象监听路由的请求</span></span><br><span class="line">    <span class="comment">//   由于EggJS是基于KOA的, 所以监听方式和KOA一样</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    在EggJS中不用导入控制器, 只要拿到了从服务器实例中解构出来的控制器对象</span></span><br><span class="line"><span class="comment">    就相当于拿到了controller目录, 我们就可以通过点语法拿到这个目录中的文件</span></span><br><span class="line"><span class="comment">    只要拿到了controller目录中的文件, 我们就可以通过点语法拿到这个文件中的方法</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    router.get(<span class="string">'/'</span>, controller.home.index);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app/controller/home.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="keyword">async</span> index()&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        在EggJS中, EggJS会自动给控制器的this挂载一些属性</span></span><br><span class="line"><span class="comment">        this.ctx: 当前请求的上下文 Context 对象的实例，通过它我们可以拿到框架封装好的处理当前请求的各种便捷属性和方法。</span></span><br><span class="line"><span class="comment">        this.app: 当前应用 Application 对象的实例，通过它我们可以拿到框架提供的全局对象和方法。</span></span><br><span class="line"><span class="comment">        this.service：应用定义的 Service，通过它我们可以访问到抽象出的业务层，等价于 this.ctx.service 。</span></span><br><span class="line"><span class="comment">        this.config：应用运行时的配置项。</span></span><br><span class="line"><span class="comment">        this.logger：logger 对象，上面有四个方法（debug，info，warn，error），分别代表打印四个不同级别的日志，使用方法和效果与 context logger 中介绍的一样，但是通过这个 logger 对象记录的日志，在日志前面会加上打印该日志的文件路径，以便快速定位日志打印位置。</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="keyword">this</span>.ctx.body = <span class="string">'nini-hub'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HomeController;</span><br></pre></td></tr></table></figure>

<h5 id="处理请求"><a href="#处理请求" class="headerlink" title="处理请求"></a>处理请求</h5><p>app/controller/home.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line">    <span class="keyword">async</span> index()&#123;</span><br><span class="line">        <span class="keyword">this</span>.ctx.body = <span class="string">'www.it666.com'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> getQuery()&#123;</span><br><span class="line">        <span class="comment">// 获取传统get请求参数</span></span><br><span class="line">        <span class="comment">// this.ctx.request.query</span></span><br><span class="line">        <span class="keyword">let</span> query = <span class="keyword">this</span>.ctx.query;</span><br><span class="line">        <span class="keyword">this</span>.ctx.body = query;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> getParams()&#123;</span><br><span class="line">        <span class="comment">// 获取动态路由形式的get请求参数</span></span><br><span class="line">        <span class="keyword">let</span> params = <span class="keyword">this</span>.ctx.params;</span><br><span class="line">        <span class="keyword">this</span>.ctx.body = params;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">async</span> getBody()&#123;</span><br><span class="line">        <span class="comment">// 获取post请求参数</span></span><br><span class="line">        <span class="keyword">let</span> body = <span class="keyword">this</span>.ctx.request.body;</span><br><span class="line">        <span class="keyword">this</span>.ctx.body = body;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HomeController;</span><br></pre></td></tr></table></figure>

<p>app/router.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 1.从服务端的实例对象中解构出处理路由的对象和处理控制器的对象</span></span><br><span class="line">    <span class="keyword">const</span> &#123;router, controller&#125; = app;</span><br><span class="line">    <span class="comment">// 2.利用处理路由的对象监听路由的请求</span></span><br><span class="line">    router.get(<span class="string">'/'</span>, controller.home.index);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    1.EggJS如何处理Get/Post请求参数?</span></span><br><span class="line"><span class="comment">    "和Koa一样"</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    router.get(<span class="string">'/user'</span>, controller.home.getQuery);</span><br><span class="line">    router.get(<span class="string">'/register/:name/:age'</span>, controller.home.getParams);</span><br><span class="line">    router.post(<span class="string">'/login'</span>, controller.home.getBody);</span><br><span class="line">    <span class="comment">// 需要额外安全配置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>config/config.default.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exports.keys = 'nini.test'; // 用于生成客户端中保存的userId</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    keys: <span class="string">'nini.test'</span>,</span><br><span class="line">    security: &#123;</span><br><span class="line">        csrf: &#123;</span><br><span class="line">            ignoreJSON: <span class="literal">true</span>, <span class="comment">// 默认为 false，当设置为 true 时，将会放过所有 content-type 为 `application/json` 的请求</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="处理静态资源"><a href="#处理静态资源" class="headerlink" title="处理静态资源"></a>处理静态资源</h5><ol>
<li><p>将静态资源放置于app/public下</p>
<p>直接访问<a href="http://127.0.0.1:7001/public/login.html" target="_blank" rel="noopener">http://127.0.0.1:7001/public/login.html</a></p>
</li>
</ol>
<h5 id="处理动态网页"><a href="#处理动态网页" class="headerlink" title="处理动态网页"></a>处理动态网页</h5><ol>
<li><p>EggJS如何处理动态资源?</p>
<ul>
<li><p>什么是插件?</p>
<p> EggJS中的插件就是特殊的中间件</p>
<p> 用来处理那些和请求无关独立的业务逻辑</p>
<p> <a href="https://eggjs.org/zh-cn/basics/plugin.html" target="_blank" rel="noopener">https://eggjs.org/zh-cn/basics/plugin.html</a></p>
</li>
<li><p>插件的使用</p>
<p>  <code>npm i egg-view-ejs --save</code></p>
</li>
</ul>
</li>
<li><p>代码</p>
<ol>
<li><p>在app目录中新建view目录, 将动态网页放到这个目录中</p>
</li>
<li><p>在config/新建plugin.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exports.ejs=&#123;</span><br><span class="line">    enable:<span class="literal">true</span>,</span><br><span class="line">    package:<span class="string">'egg-view-ejs'</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在config.default.js中新增如下配置</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">view:&#123;</span><br><span class="line">    mapping:&#123;</span><br><span class="line">        <span class="string">'.html'</span>:<span class="string">'ejs'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在控制器中通过上下文render方法渲染</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> getHome()&#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="keyword">this</span>.ctx.render(<span class="string">'index'</span>, &#123;<span class="attr">msg</span>:<span class="string">'妮妮'</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ol>
<h5 id="处理网络请求"><a href="#处理网络请求" class="headerlink" title="处理网络请求"></a>处理网络请求</h5><p>EggJS处理数据</p>
<p>在EggJS中无论是处理数据库中的数据还是处理网络数据, 都是在Service中处理的</p>
<ol>
<li><p>在app目录下新建service目录</p>
</li>
<li><p>在service新建home.js</p>
<ul>
<li><p>和控制器一样, Service类的this上也挂载了很多属性</p>
<ul>
<li>this.ctx: 当前请求的上下文 Context 对象的实例，通过它我们可以拿到框架封装好的处理当前请求的各种便捷属性和方法</li>
<li>this.app: 当前应用 Application 对象的实例，通过它我们可以拿到框架提供的全局对象和方法</li>
<li>this.service：应用定义的 Service，通过它我们可以访问到其他业务层，等价于this.ctx.service </li>
<li>this.config：应用运行时的配置项</li>
<li>this.logger：logger 对象，上面有四个方法（debug，info，warn，error），分别代表打印四个不同级别的日志，使用方法和效果与 context logger 中介绍的一样，但是通过这个 logger 对象记录的日志，在日志前面会加上打印该日志的文件路径，以便快速定位日志打印位置</li>
</ul>
</li>
<li><p>ervice的上下文属性上还挂载了一些其它的属性</p>
<ul>
<li>this.ctx.curl 发起网络调用</li>
<li>this.ctx.service.otherService 调用其他 Service</li>
<li>this.ctx.db 发起数据库调用等， db 可能是其他插件提前挂载到 app 上的模块</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">'egg'</span>).Service;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">    <span class="keyword">async</span> findNews()&#123;</span><br><span class="line">        <span class="comment">// 在Service定义的方法中处理数据库和网络的数据即可</span></span><br><span class="line">        <span class="comment">// 发送get不带参数的请求</span></span><br><span class="line">        <span class="comment">// let response = await this.ctx.curl('http://127.0.0.1:3000/getUser');</span></span><br><span class="line">        <span class="comment">// 发送get带参数的请求</span></span><br><span class="line">        <span class="comment">// let response = await this.ctx.curl('http://127.0.0.1:3000/getUser2?name=nini&amp;age=16');</span></span><br><span class="line">        <span class="comment">// 发送post不带参数的请求</span></span><br><span class="line">        <span class="comment">// let response = await this.ctx.curl('http://127.0.0.1:3000/getNews', &#123;</span></span><br><span class="line">        <span class="comment">//     method: 'post'</span></span><br><span class="line">        <span class="comment">// &#125;);</span></span><br><span class="line">        <span class="comment">// 发送post带参数的请求</span></span><br><span class="line">        <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="keyword">this</span>.ctx.curl(<span class="string">'http://127.0.0.1:3000/getNews2'</span>, &#123;</span><br><span class="line">            method: <span class="string">'post'</span>,</span><br><span class="line">            data:&#123;</span><br><span class="line">                name:<span class="string">'nini'</span>,</span><br><span class="line">                age:<span class="number">18</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">let</span> data = <span class="built_in">JSON</span>.parse(response.data);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"HomeService"</span>, data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = HomeService;</span><br></pre></td></tr></table></figure>
</li>
<li><p>app/router.js</p>
<p>新增<code>router.get(&#39;/news&#39;, controller.home.getNews);</code>;</p>
</li>
<li><p>app/controller/home.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> getNews()&#123;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="keyword">this</span>.ctx.service.home.findNews();</span><br><span class="line">    <span class="keyword">this</span>.ctx.body = data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="service注意点"><a href="#service注意点" class="headerlink" title="service注意点"></a>service注意点</h5><h5 id="处理cookie"><a href="#处理cookie" class="headerlink" title="处理cookie"></a>处理cookie</h5><h5 id="处理日志"><a href="#处理日志" class="headerlink" title="处理日志"></a>处理日志</h5><h5 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h5><h5 id="自定义启动项"><a href="#自定义启动项" class="headerlink" title="自定义启动项"></a>自定义启动项</h5><h5 id="框架拓展"><a href="#框架拓展" class="headerlink" title="框架拓展"></a>框架拓展</h5><h5 id="利用egg脚手架工具安装使用（egg-init）"><a href="#利用egg脚手架工具安装使用（egg-init）" class="headerlink" title="利用egg脚手架工具安装使用（egg-init）"></a>利用egg脚手架工具安装使用（egg-init）</h5>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2020/12/14/jest%E6%B5%8B%E8%AF%95react/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/14/jest%E6%B5%8B%E8%AF%95react/" class="post-title-link" itemprop="url">jest测试react</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>

              <time title="أُنشأ: 2020-12-14 14:24:42" itemprop="dateCreated datePublished" datetime="2020-12-14T14:24:42+08:00">2020-12-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">عُدل في</span>
                <time title="عُدل: 2021-01-11 15:20:54" itemprop="dateModified" datetime="2021-01-11T15:20:54+08:00">2021-01-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>源自<a href="https://www.valentinog.com/blog/testing-react/" target="_blank" rel="noopener">https://www.valentinog.com/blog/testing-react/</a></p>
<h3 id="Testing-React-Components-with-react-test-renderer-and-the-Act-API"><a href="#Testing-React-Components-with-react-test-renderer-and-the-Act-API" class="headerlink" title="Testing React Components with react-test-renderer, and the Act API"></a>Testing React Components with react-test-renderer, and the Act API</h3><h3 id="使用react-test-renderer和Act-API测试React组件"><a href="#使用react-test-renderer和Act-API测试React组件" class="headerlink" title="使用react-test-renderer和Act API测试React组件"></a>使用react-test-renderer和Act API测试React组件</h3><p>如果您对React有一个基本的了解，并且想了解测试组件，那么本指南非常适合您。</p>
<p>本指南假定您对<strong>testing theory</strong>和<strong>testing runners</strong>（如Jest）有基本的了解</p>
<h3 id="你将学到"><a href="#你将学到" class="headerlink" title="你将学到"></a>你将学到</h3><ul>
<li>单元测试react组件</li>
<li>react应用的功能测试</li>
<li>测试react的可用工具</li>
</ul>
<h3 id="了解快照测试"><a href="#了解快照测试" class="headerlink" title="了解快照测试"></a>了解快照测试</h3><p>快照是技术中的常见主题。 快照就像实体在给定时间点的图片。 这也是测试React组件的最简单方法之一。</p>
<p>通过快照测试，您可以为React组件拍照，然后将原始快照与另一个快照进行比较。</p>
<p>快照测试是Jest测试运行器中内置的一项功能，由于它是测试React的默认库，因此我们将使用它。</p>
<p>首先使用create-react-app创建一个新的React项目：</p>
<p><code>npx create-react-app testing-react-tutorial</code></p>
<p>进入项目并安装react-test-renderer：</p>
<p><code>cd testing-react-tutorial &amp;&amp; npm i react-test-renderer --save-dev</code></p>
<p>接下来，在项目的src文件夹中创建一个名为<strong>tests</strong>的新文件夹（Jest将在此处寻找要运行的新测试）：</p>
<p><code>mkdir -p src/__tests__</code></p>
<p>在大多数情况下，创建新的React组件时，我会先为其创建一个测试。 对于那些尚未开始的人，这种做法称为测试驱动的开发，您不必从字面上遵循它。</p>
<p>无需任何测试就可以开始编码，这很好，特别是当您尚不知道要编写哪种实现的想法时。 无论如何，在本教程的范围内，我们将通过测试一个简单的按钮组件来实践一些TDD。</p>
<p><em>提示：您可以通过安装Jest的类型定义来为其获得方法自动完成功能：</em></p>
<p>对于我们的第一个快照测试，我们需要导入React，react-test-renderer和要测试的组件。 使用以下测试在<code>src / __ tests __ / Button.spec.js</code>中创建一个新文件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"Matches the snapshot"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> button = create(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> /&gt;</span></span>);</span><br><span class="line">    expect(button.toJSON()).toMatchSnapshot();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>此时，您可以使用以下命令运行第一遍：</p>
<p><code>npm test</code></p>
<p>您会看到测试失败，因为没有按钮组件。 您可以在同一文件中创建组件的最小实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>Nothing to do for now<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"Matches the snapshot"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> button = create(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> /&gt;</span></span>);</span><br><span class="line">    expect(button.toJSON()).toMatchSnapshot();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>再次运行</p>
<p><code>npm test</code></p>
<h3 id="揭开快照测试"><a href="#揭开快照测试" class="headerlink" title="揭开快照测试"></a>揭开快照测试</h3><p>这时候你可能会问，什么是<code>react-test-renderer</code>？<code>react-test-renderer</code>是一个用于将React组件呈现为纯JavaScript对象的库,<code>create</code>就是<code>react-test-renderer</code>的方法，用于mount一个组件</p>
<p>值得注意的是<code>react-test-renderer</code>没有使用真正的DOM。 当您使用<code>react-test-renderer</code>挂载组件时，您正在与纯JavaScript对象进行交互，即JavaScript组件的表示形式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span>&gt;</span>Nothing to do for now<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"Matches the snapshot"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> button = create(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> /&gt;</span></span>);</span><br><span class="line">    expect(button.toJSON()).toMatchSnapshot();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>toMatchSnapshot()</code>完成了很多繁重的工作:</p>
<ul>
<li>如果没有组件，则创建该组件的快照</li>
<li>检查组件是否与保存的快照匹配</li>
</ul>
<p>您还可以看到在组件实例上调用的<code>toJSON()</code>。</p>
<p>换句话说，Jest（测试运行程序）在第一次运行时为组件拍摄快照，然后检查保存的快照是否与实际组件匹配。 此时，您可能想知道如何在快照和其他类型的React测试之间进行选择？</p>
<p>我有一条经验法则：您的组件是否经常更改？ 如果是这样，请避免快照测试。 如果为组件拍摄快照，则测试将在第一次运行时通过，但是一旦发生更改，测试将失败，因为组件与其原始“图片”之间将不匹配。</p>
<p>您可能会猜到快照测试对于不经常更改的组件很有用。 换句话说，当组件稳定时编写快照测试。</p>
<p>现在让我们仔细看看 <code>react-test-renderer</code></p>
<h3 id="错误的测试方法"><a href="#错误的测试方法" class="headerlink" title="错误的测试方法"></a>错误的测试方法</h3><p>假设您的应用程序中有一个按钮组件，并且单击该按钮后，其文本应从“ SUBSCRIBE TO BASIC”更改为“ PROCEED TO CHECKOUT”。</p>
<p>该组件具有逻辑，也可能具有状态，这意味着快照测试不是我们的最佳选择。 react-test-renderer是一个用于将React组件呈现为纯JavaScript对象的库，但是它比创建对象还有更多的功能。 实际上，我们甚至可以使用react-test-renderer来声明组件的行为。</p>
<p>让我们在<code>src / __ tests __ / Button.spec.js</code>中创建一个全新的测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows the expected text when clicked (testing the wrong way!)"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如您所见，我称此测试为“测试错误的方式”。 为什么这样？ 由于我们要测试有状态组件（具有自己状态的React组件），因此我们自然很想测试它的内部实现。 让我们来看看。 我们将在组件的内部状态上创建并声明。</p>
<p><em>注意：使用React钩子，不需要使用类来保存组件的状态。</em></p>
<p>我期望状态文本属性现在为空：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows the expected text when clicked (testing the wrong way!)"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> component = create(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">text</span>=<span class="string">"SUBSCRIBE TO BASIC"</span> /&gt;</span></span>);</span><br><span class="line">    <span class="keyword">const</span> instance = component.getInstance();</span><br><span class="line">    expect(instance.state.text).toBe(<span class="string">""</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>现在测试将失败，因为我尚未创建组件。 让我们为按钮组件做一个最小的实现（为方便起见，在同一测试文件中）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Button</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123; <span class="attr">text</span>: <span class="string">""</span> &#125;;</span><br><span class="line">    <span class="keyword">this</span>.handleClick = <span class="keyword">this</span>.handleClick.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">text</span>: <span class="string">"PROCEED TO CHECKOUT"</span> &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;button onClick=&#123;<span class="keyword">this</span>.handleClick&#125;&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.text || <span class="keyword">this</span>.props.text&#125;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">describe("Button component", () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  test("it shows the expected text when clicked (testing the wrong way!)", () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    const component = create(&lt;Button text="SUBSCRIBE TO BASIC" /</span>&gt;);</span><br><span class="line">    <span class="keyword">const</span> instance = component.getInstance();</span><br><span class="line">    expect(instance.state.text).toBe(<span class="string">""</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>再运行一次，到目前为止，我们还没测试任何东西。那么handleClick呢</p>
<p>如何在React组件上测试内部方法？ 事实证明，我们可以在实例上调用方法。 让我们更新测试：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Button</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123; <span class="attr">text</span>: <span class="string">""</span> &#125;;</span><br><span class="line">    <span class="keyword">this</span>.handleClick = <span class="keyword">this</span>.handleClick.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">text</span>: <span class="string">"PROCEED TO CHECKOUT"</span> &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;button onClick=&#123;<span class="keyword">this</span>.handleClick&#125;&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.text || <span class="keyword">this</span>.props.text&#125;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">describe("Button component", () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  test("it shows the expected text when clicked (testing the wrong way!)", () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    const component = create(&lt;Button text="SUBSCRIBE TO BASIC" /</span>&gt;);</span><br><span class="line">    <span class="keyword">const</span> instance = component.getInstance();</span><br><span class="line">    expect(instance.state.text).toBe(<span class="string">""</span>);</span><br><span class="line">    instance.handleClick();</span><br><span class="line">    expect(instance.state.text).toBe(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>请注意，我是如何调用<code>instance.handleClick()</code>的，因此认为该组件的状态按预期发生了变化：</p>
<p><code>expect(instance.state.text).toBe(&quot;PROCEED TO CHECKOUT&quot;);</code></p>
<p>如果我再次运行测试，它仍然会通过。 但是您可以在此测试中看到陷阱吗？</p>
<p>我们是否从用户的角度测试组件？ 我不知道我的按钮是否会向用户显示正确的文本。 我只是断言其内部状态。 让我们修复它。</p>
<h3 id="正确的测试方法"><a href="#正确的测试方法" class="headerlink" title="正确的测试方法"></a>正确的测试方法</h3><p>测试对象的内部实现总是一个坏主意。 这对于React，JavaScript和那里的任何编程语言都适用。 相反，我们可以做的就是牢记用户应该看到的内容来测试组件。 构建用户界面时，功能测试会驱动开发过程。</p>
<p>功能测试或e2e测试是从用户角度测试Web应用程序的一种方法。</p>
<p>（测试术语之间存在很多混乱和重叠。我建议您自己进行一些研究以了解有关各种类型的测试的更多信息。对于本指南的范围，功能测试===端到端测试）</p>
<p>对于功能测试，我喜欢Cypress。 现在，我们可以使用react-test-renderer在单元级别获得相同的结果。 让我们看看如何重构我们的测试。 我们测试了该组件的内部实现，直接调用handleClick。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;this.handleClick&#125;</span>&gt;</span></span><br><span class="line">  &#123;this.state.text || this.props.text&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们没有测试用户应该看到的内容。 我们可以做得更好吗？ 事实证明，我们可以在测试中使用root而不是<code>getInstance()</code>。 根据文档，<code>testRenderer.root</code>返回根测试实例对象，该对象对于对树中的特定节点进行断言很有用”。</p>
<p>找到按钮</p>
<p><code>const button = instance.findByType(&quot;button&quot;);</code></p>
<p>那么我们可以访问button的属性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">button.props.onClick();</span><br><span class="line">button.props.children;</span><br></pre></td></tr></table></figure>

<p>这是新的测试</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Button</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123; <span class="attr">text</span>: <span class="string">""</span> &#125;;</span><br><span class="line">    <span class="keyword">this</span>.handleClick = <span class="keyword">this</span>.handleClick.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleClick() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">text</span>: <span class="string">"PROCEED TO CHECKOUT"</span> &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;button onClick=&#123;<span class="keyword">this</span>.handleClick&#125;&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.text || <span class="keyword">this</span>.props.text&#125;</span><br><span class="line">      &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">describe("Button component", () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  test("it shows the expected text when clicked (testing the wrong way!)", () =&gt; &#123;</span></span><br><span class="line"><span class="regexp">    const component = create(&lt;Button text="SUBSCRIBE TO BASIC" /</span>&gt;);</span><br><span class="line">    <span class="keyword">const</span> instance = component.root;</span><br><span class="line">    <span class="keyword">const</span> button = instance.findByType(<span class="string">"button"</span>);</span><br><span class="line">    button.props.onClick();</span><br><span class="line">    expect(button.props.children).toBe(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>那么她为什么比之前的测试优秀呢，当然，我们也可以手动模拟click事件（我们将在以后看到）。 现在，我们已经完善的是：我们测试了用户应该看到的内容，而不是像以前一样测试了内部组件的状态。</p>
<p>永远要记得，不要测试<strong>implementation</strong>，从用户的视角测试组件</p>
<p>接下来的部分，我们将介绍：使用react hook时 测试意味着什么</p>
<h2 id="React-hooks-interlude-the-Act-API"><a href="#React-hooks-interlude-the-Act-API" class="headerlink" title="React hooks interlude: the Act API"></a>React hooks interlude: the Act API</h2><p>在react hools之前 在一个react组件中只有一种方式来保存state:ES2015 class</p>
<p>JavaScript的类非常适合来自Java和C＃等语言的程序员，但是它们比JavaScript函数冗长且不直观，特别是对于初学者而言。</p>
<p>它们不会很快消失（想象一下用类编写了多少React组件），但是有了钩子，我们就可以大大减少组件的数量。</p>
<p>例如，我们之前创建的Button组件通过钩子变得越来越小：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [text, setText] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setText(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>&#123;text || props.text&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在如何基于钩子测试React组件呢？ 我们可以重用之前的测试吗？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [text, setText] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setText(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>&#123;text || props.text&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows the expected text when clicked"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> component = create(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">text</span>=<span class="string">"SUBSCRIBE TO BASIC"</span> /&gt;</span></span>);</span><br><span class="line">    <span class="keyword">const</span> instance = component.root;</span><br><span class="line">    <span class="keyword">const</span> button = instance.findByType(<span class="string">"button"</span>);</span><br><span class="line">    button.props.onClick();</span><br><span class="line">    expect(button.props.children).toBe(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>运行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="built_in">test</span></span><br></pre></td></tr></table></figure>

<p>看看输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Warning: An update to Button inside a test was not wrapped in act(...).</span><br><span class="line"></span><br><span class="line">When testing, code that causes React state updates should be wrapped into act(...):</span><br><span class="line"></span><br><span class="line">act(() &#x3D;&gt; &#123;</span><br><span class="line">  &#x2F;* fire events that update state *&#x2F;</span><br><span class="line">&#125;);</span><br><span class="line">&#x2F;* assert on the output *&#x2F;</span><br></pre></td></tr></table></figure>

<p>有趣。 我们的测试不适用于React钩子。 事实证明，我们需要为React使用一个新的测试API，称为Act。 幸运的是，有两种方法可以使用Act API编写测试。</p>
<h3 id="React-hooks-interlude-Act-API-with-react-test-renderer"><a href="#React-hooks-interlude-Act-API-with-react-test-renderer" class="headerlink" title="React hooks interlude: Act API with react-test-renderer"></a>React hooks interlude: Act API with react-test-renderer</h3><p>If you can live with the fact that react-test-renderer does not use a DOM you’ll need just to tweak the test a bit for Act. That means <strong>importing act alongside with create</strong>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create, act &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br></pre></td></tr></table></figure>

<p>Your Button component will stay the same:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create, act &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [text, setText] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setText(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>&#123;text || props.text&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The test must use <code>act()</code> for any action that changes the component’s state, like “mounting” it or clicking on a function passed as a prop. Here’s the complete test with Act:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; create, act &#125; <span class="keyword">from</span> <span class="string">"react-test-renderer"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [text, setText] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setText(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>&#123;text || props.text&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows the expected text when clicked"</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> component;</span><br><span class="line">    act(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      component = create(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">text</span>=<span class="string">"SUBSCRIBE TO BASIC"</span> /&gt;</span></span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> instance = component.root;</span><br><span class="line">    <span class="keyword">const</span> button = instance.findByType(<span class="string">"button"</span>);</span><br><span class="line">    act(<span class="function"><span class="params">()</span> =&gt;</span> button.props.onClick());</span><br><span class="line">    expect(button.props.children).toBe(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Notice that both the call to create and to <code>button.props.onClick()</code> are wrapped in a callback passed to <code>act()</code>. <strong>That’s it if you don’t need the DOM</strong>.</p>
<p>If instead you want to mount React components into the Document Object Model then another version of the Act API will suite you best.</p>
<p>Head over the next section!</p>
<h3 id="React-hooks-interlude-Act-API-with-the-real-DOM"><a href="#React-hooks-interlude-Act-API-with-the-real-DOM" class="headerlink" title="React hooks interlude: Act API with the real DOM"></a>React hooks interlude: Act API with the real DOM</h3><p>Since <strong>Act came out I’m using it almost exclusively. I pick react-test-renderer only for writing snapshot tests</strong>. <strong>The approach we’re going to see is my favourite</strong> because <strong>tests for me feel more real if I can interact with the DOM</strong>.</p>
<p>The Act API is available both on react-test-renderer and on <strong>react-dom/test-utils</strong> and when imported from the latter it’s possible to use <code>ReactDOM.render</code>, thus mounting the React component into the Document Object Model.</p>
<p>Still in <code>src/__tests__/Button.spec.js</code> wipe everything out and start with a new test:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; act &#125; <span class="keyword">from</span> <span class="string">"react-dom/test-utils"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> container;</span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  container = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(container);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">document</span>.body.removeChild(container);</span><br><span class="line">  container = <span class="literal">null</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// test here</span></span><br></pre></td></tr></table></figure>

<p>We import act from react-dom/test-utils, ReactDOM, and more important we initialize a minimal DOM structure for our component. Next up we can create the actual test. <strong>Step 1, mount the component with Act</strong>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; act &#125; <span class="keyword">from</span> <span class="string">"react-dom/test-utils"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> container;</span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  container = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(container);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">document</span>.body.removeChild(container);</span><br><span class="line">  container = <span class="literal">null</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [text, setText] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setText(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>&#123;text || props.text&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows the expected text when clicked"</span>, () =&gt; &#123;</span><br><span class="line">    act(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">text</span>=<span class="string">"SUBSCRIBE TO BASIC"</span> /&gt;</span></span>, container);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// more soon</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>Step 2, once mounted you can make assertions on the DOM which now contains your component</strong>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> button = container.getElementsByTagName(<span class="string">"button"</span>)[<span class="number">0</span>];</span><br><span class="line">expect(button.textContent).toBe(<span class="string">"SUBSCRIBE TO BASIC"</span>);</span><br></pre></td></tr></table></figure>

<p>You can also <strong>fire DOM events</strong> on the button. Here’s the complete test (it will pass without any problem):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; useState &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; act &#125; <span class="keyword">from</span> <span class="string">"react-dom/test-utils"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> container;</span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  container = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(container);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">document</span>.body.removeChild(container);</span><br><span class="line">  container = <span class="literal">null</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Button</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [text, setText] = useState(<span class="string">""</span>);</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleClick</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setText(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span>&#123;text || props.text&#125;<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"Button component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows the expected text when clicked"</span>, () =&gt; &#123;</span><br><span class="line">    act(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      ReactDOM.render(<span class="xml"><span class="tag">&lt;<span class="name">Button</span> <span class="attr">text</span>=<span class="string">"SUBSCRIBE TO BASIC"</span> /&gt;</span></span>, container);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> button = container.getElementsByTagName(<span class="string">"button"</span>)[<span class="number">0</span>];</span><br><span class="line">    expect(button.textContent).toBe(<span class="string">"SUBSCRIBE TO BASIC"</span>);</span><br><span class="line">    act(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      button.dispatchEvent(<span class="keyword">new</span> MouseEvent(<span class="string">"click"</span>, &#123; <span class="attr">bubbles</span>: <span class="literal">true</span> &#125;));</span><br><span class="line">    &#125;);</span><br><span class="line">    expect(button.textContent).toBe(<span class="string">"PROCEED TO CHECKOUT"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>NOTE</strong>: <code>button.dispatchEvent</code> seems to have effect even if the call is not wrapped inside act.</p>
<p>Seems a bit of boilerplate, especially all these <strong>DOM methods</strong>. It’s not a big deal for me but libraries like <a href="https://github.com/testing-library/react-testing-library" target="_blank" rel="noopener">react-testing-library</a> can help on this.</p>
<p>Now hands on <strong>mocking</strong>!</p>
<h2 id="Testing-React-Components-mocking-interlude"><a href="#Testing-React-Components-mocking-interlude" class="headerlink" title="Testing React Components: mocking interlude"></a>Testing React Components: mocking interlude</h2><p><strong>Fetching and displaying data is one of the most common use cases</strong> for a front-end library. This is usually done by contacting an external API which holds some JSON for us.</p>
<p>In React you can use <code>componentDidMount</code> for making AJAX calls as soon as the component mounts. (And with hooks there is <code>useEffect</code>).</p>
<p>Now, the thing is: <strong>how do you test an AJAX call within React</strong>? Should you make a call to the actual API? Maybe! But some questions arise. Consider this: your team runs automated testing in CI/CD, developers commit to the main branch 3/4 times a day.</p>
<p><strong>What happens if the API goes down</strong>? The <strong>tests will fail</strong> with no reasons. Clearly, contacting the real endpoint in testing is far from optimal. So? <strong>What’s the solution? We can use fakes and mocks</strong>.</p>
<p>Faking external requirements is a common pattern in testing. For example, we can replace an external system with a fake in testing.</p>
<h2 id="Mocking-Fetch-API-calls-with-Jest"><a href="#Mocking-Fetch-API-calls-with-Jest" class="headerlink" title="Mocking Fetch API calls with Jest"></a>Mocking Fetch API calls with Jest</h2><p><strong>Mocking is the act of replacing a function with a fake copy</strong>. In this section we’ll <strong>mock an API call in Jest</strong>.</p>
<p>Again, let’s start with a test (act API on ReactDOM). Suppose we want a Users component for fetching and displaying a list of users. In our test <strong>we can mount the component and then assert on the output</strong>.</p>
<p>Let’s give it a shot by preparing a test with the Act API, this time we’ll use <code>unmountComponentAtNode</code> from <a href="https://reactjs.org/docs/testing-recipes.html#setup--teardown" target="_blank" rel="noopener">ReactDOM for cleaning up the test properly</a>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render, unmountComponentAtNode &#125; <span class="keyword">from</span> <span class="string">"react-dom"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; act &#125; <span class="keyword">from</span> <span class="string">"react-dom/test-utils"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> container;</span><br><span class="line"></span><br><span class="line">beforeEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  container = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(container);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">afterEach(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  unmountComponentAtNode(container);</span><br><span class="line">  container.remove();</span><br><span class="line">  container = <span class="literal">null</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">"User component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows a list of users"</span>, () =&gt; &#123;</span><br><span class="line">    act(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      render(<span class="xml"><span class="tag">&lt;<span class="name">Users</span> /&gt;</span></span>, container);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Run the test with <code>npm test</code> and see it fail.</p>
<p>Now let’s make a minimal implementation of the React component. Here’s the class component (you can easily refactor the component to hooks):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Users</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.state = &#123; <span class="attr">data</span>: [] &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    fetch(<span class="string">"https://jsonplaceholder.typicode.com/users"</span>)</span><br><span class="line">      .then(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// make sure to check for errors</span></span><br><span class="line">        <span class="keyword">return</span> response.json();</span><br><span class="line">      &#125;)</span><br><span class="line">      .then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> &#123; <span class="attr">data</span>: json &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ul&gt;</span><br><span class="line">        &#123;<span class="keyword">this</span>.state.data.map(<span class="function"><span class="params">user</span> =&gt;</span> (</span><br><span class="line">          &lt;li key=&#123;user.name&#125;&gt;&#123;user.name&#125;&lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">        ))&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/u</span>l&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Import the component in your test file (I called mine <code>Users.spec.js</code>) and let’s start by making a simple assertion on the container’s text content:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rest omitted for brevity</span></span><br><span class="line"></span><br><span class="line">describe(<span class="string">"User component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows a list of users"</span>, () =&gt; &#123;</span><br><span class="line">    act(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      render(<span class="xml"><span class="tag">&lt;<span class="name">Users</span> /&gt;</span></span>, container);</span><br><span class="line">    &#125;);</span><br><span class="line">    expect(container.textContent).toBe(<span class="string">"What to expect?"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Run the test with <code>npm test</code> and that’s what you get:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FAIL  src&#x2F;__tests__&#x2F;Users.spec.js</span><br><span class="line"> User component</span><br><span class="line">   ✕ it shows a list of users (30ms)</span><br><span class="line"></span><br><span class="line"> ● User component › it shows a list of users</span><br><span class="line"></span><br><span class="line">   expect(received).toBe(expected) &#x2F;&#x2F; Object.is equality</span><br><span class="line"></span><br><span class="line">   Expected: &quot;What to expect?&quot;</span><br><span class="line">   Received: &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>A failing test! There is no text content in the container. That makes sense because <code>componentDidMount</code> is calling Fetch which is <strong>asynchronous</strong>.</p>
<p>With <a href="https://reactjs.org/blog/2019/08/08/react-v16.9.0.html#async-act-for-testing" target="_blank" rel="noopener">React 16.9 the Act API gained the ability to deal with asynchronous functions</a>, and that means we can await on the component’s rendering like so:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"User component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows a list of users"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> act(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      render(<span class="xml"><span class="tag">&lt;<span class="name">Users</span> /&gt;</span></span>, container);</span><br><span class="line">    &#125;);</span><br><span class="line">    expect(container.textContent).toBe(<span class="string">"What to expect?"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Be aware that <strong>Act cannot wait</strong> for <code>componentDidMount</code> and the real API endpoint is never hit. The test still fails with the same error, no text content inside the container.</p>
<p>That’s by design according to Facebook developers. In the end I think it’s a sane default because most of the times there is no reason to call external APIs during testing.</p>
<p>But it’s not that bad because we’re interested in <strong>mocking the API with a fake JSON response</strong>. First we can provide a fake response and while we’re there let’s adjust the assertion (what follows is just the relevant part of the test suite):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"User component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows a list of users"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> fakeResponse = [&#123; <span class="attr">name</span>: <span class="string">"John Doe"</span> &#125;, &#123; <span class="attr">name</span>: <span class="string">"Kevin Mitnick"</span> &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> act(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      render(<span class="xml"><span class="tag">&lt;<span class="name">Users</span> /&gt;</span></span>, container);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    expect(container.textContent).toBe(<span class="string">"John DoeKevin Mitnick"</span>);</span><br><span class="line"></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Next up we mock the actual Fetch API with <code>jest.spyOn</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"User component"</span>, () =&gt; &#123;</span><br><span class="line">  test(<span class="string">"it shows a list of users"</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> fakeResponse = [&#123; <span class="attr">name</span>: <span class="string">"John Doe"</span> &#125;, &#123; <span class="attr">name</span>: <span class="string">"Kevin Mitnick"</span> &#125;];</span><br><span class="line"></span><br><span class="line">    jest.spyOn(<span class="built_in">window</span>, <span class="string">"fetch"</span>).mockImplementation(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fetchResponse = &#123;</span><br><span class="line">        json: <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>.resolve(fakeResponse)</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(fetchResponse);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> act(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      render(<span class="xml"><span class="tag">&lt;<span class="name">Users</span> /&gt;</span></span>, container);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    expect(container.textContent).toBe(<span class="string">"John DoeKevin Mitnick"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">window</span>.fetch.mockRestore();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>You may find this code extremely hard to reason about, especially if you’re just starting out with testing.</p>
<p>Here’s how it works: <code>jest.spyOn</code> “spies” on the Fetch method, available on the window object. When the method is called we mock, aka replace the real Fetch with a so called mock implementation. <code>mockImplementation</code> takes a function which is our fake Fetch.</p>
<p>Inside the <strong>mock we create a new response object with a function called json. This function returns a resolved Promise with the fake JSON response</strong>. Finally we return the entire response object inside another resolved Promise.</p>
<p>Now run the test again with <code>npm test</code> and see it passing! Fantastic.</p>
<p>Takeaways:</p>
<p><strong>Do not call a real API in your tests</strong>. Tests should not depend on external systems. By mocking Fetch and providing a fake response we ensure test isolation.</p>
<p><strong>TIP</strong>: doing async calls in <code>componentDidMount</code> is poor practice. Consider always moving async logic out of React components. A good place for async logic is a Redux middleware, or a custom Hook for data fetching.</p>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h2><p>Some time ago I asked on Reddit: “What’s the consensus among the React community for testing React components?” Shawn Wang replied: “testing is an enormously complicated and nuanced topic on which there isn’t a consensus anywhere in JS, much less in React.”</p>
<p>I was not trying to find the best library for testing React. Mainly because there isn’t one.</p>
<p>But there’s one truth, as we saw in the previous sections: <strong>use a library that encourages best practices and do not test the internal implementation</strong>, even if Enzyme or react-test-renderer make it easy.</p>
<p>Here are my tools of choice for testing React apps:</p>
<ul>
<li>react-test-renderer for snapshot unit testing</li>
<li>Act API for unit testing React components</li>
<li>Jest for unit and integration testing of JavaScript code</li>
<li>Cypress for end to end / UI testing</li>
</ul>
<p>I also suggest taking a look at <strong>react-testing-library</strong>, a nice wrapper around the Act API.</p>
<p>Thanks for reading and stay tuned!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2020/12/11/%E4%B8%8A%E7%BA%BFnode%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/11/%E4%B8%8A%E7%BA%BFnode%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">上线node项目笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>

              <time title="أُنشأ: 2020-12-11 14:28:20" itemprop="dateCreated datePublished" datetime="2020-12-11T14:28:20+08:00">2020-12-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">عُدل في</span>
                <time title="عُدل: 2020-12-16 16:37:04" itemprop="dateModified" datetime="2020-12-16T16:37:04+08:00">2020-12-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="cookie跨域问题"><a href="#cookie跨域问题" class="headerlink" title="cookie跨域问题"></a>cookie跨域问题</h4><ol>
<li><p>Cookie的跨域问题</p>
<p>Cookie是不能跨域使用的, 所以在前后端分离开发的时候, 我们当前的代码就会出现问题</p>
</li>
<li><p>什么是跨域?</p>
<p>协议/一级域名/二级域名/端口号 有一个不同就是跨域</p>
</li>
<li><p>如何解决前后端分离Cookie的跨域问题?</p>
<p>通过Nginx反向代理</p>
<p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a></p>
</li>
</ol>
<h4 id="正向代理和反向道理"><a href="#正向代理和反向道理" class="headerlink" title="正向代理和反向道理"></a>正向代理和反向道理</h4><h5 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h5><ol>
<li><p>代理服务器是为用户服务, 我们称之为正向代理</p>
<p>例如: 访问谷歌</p>
<p>用户访问不了谷歌, 但是我可以访问一台海外的服务器, 这台海外服务器又可以访问谷歌</p>
<p>那么’用户’就可以先访问’海外的服务器’, 再通过’海外的服务器’访问谷歌, 这就是正向代理</p>
</li>
<li><p>正向代理的用途</p>
<ul>
<li><p>访问原来无法访问的资源，如google</p>
</li>
<li><p>对客户端访问授权，上网进行认证</p>
</li>
<li><p>… …</p>
</li>
</ul>
</li>
</ol>
<pre class="mermaid">    graph LR
        subgraph Google服务器
        end
        subgraph 用户及代理服务器
        user1-->代理服务器
        user2-->代理服务器
        user3-->代理服务器
        end
        代理服务器-->Google服务器
        Google服务器-->代理服务器</pre>

<h5 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h5><ol>
<li><p>反向代理服务器是为’服务器’服务,我们称之为反向代理</p>
</li>
<li><p>反向代理的用途</p>
<ul>
<li><p>负载均衡，通过反向代理服务器来优化网站的负载</p>
</li>
<li><p>前后端分离, 统一请求地址</p>
</li>
</ul>
</li>
</ol>
<pre class="mermaid">    graph LR
        subgraph 用户
        user1
        user2
        user3
        end
        subgraph 前后端服务器及代理服务器
        代理服务器80-->前端服务器3001
        代理服务器80-->后端服务器3000
        end
        user1-->代理服务器80
        user2-->代理服务器80
        user3-->代理服务器80</pre>

<p>快出来啊啊啊啊啊</p>
<h4 id="nginx解决cookie跨域问题"><a href="#nginx解决cookie跨域问题" class="headerlink" title="nginx解决cookie跨域问题"></a>nginx解决cookie跨域问题</h4><pre class="mermaid">    graph LR
        subgraph 代理服务器
        代理服务器8080
        end
           subgraph 用户
        用户A浏览器
        用户B浏览器
        end
        subgraph 前后端服务器及代理服务器
        代理服务器8080--请求的是/-->前端服务器3001
        代理服务器8080--请求的是/api-->后端服务器3000
        后端服务器3000--cookie-->代理服务器8080
        end
        用户A浏览器-->代理服务器8080
        用户B浏览器--设置cookie 8080-->代理服务器8080
        代理服务器8080--读取cookie 8080-->用户B浏览器</pre>



<h5 id="Nginx安装和使用"><a href="#Nginx安装和使用" class="headerlink" title="Nginx安装和使用"></a>Nginx安装和使用</h5><ol>
<li><p>安装</p>
<p>下载解压即可</p>
<p><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">http://nginx.org/en/download.html</a></p>
</li>
<li><p>使用</p>
<p>修改配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 4; &#x2F;&#x2F; CPU核数</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">    </span><br><span class="line">    	listen   8080;</span><br><span class="line">    	</span><br><span class="line">        location &#x2F; &#123; &#x2F;&#x2F; 请求根路径代理的地址</span><br><span class="line"></span><br><span class="line">         proxy_pass http:&#x2F;&#x2F;192.168.0.107:3001;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location &#x2F;api &#123; &#x2F;&#x2F; 请求&#x2F;api代理的地址</span><br><span class="line"></span><br><span class="line">         proxy_pass http:&#x2F;&#x2F;127.0.0.1:3000;</span><br><span class="line"></span><br><span class="line">         proxy_set_header Host $host; &#x2F;&#x2F; 响应头的地址改成代理的地址</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>启动nginx，访问<code>http://192.168.0.107:3001/login.html</code>，再访问<code>http://127.0.0.1:3000</code></p>
<p>再访问<code>http://127.0.0.1:8080/login.html</code></p>
<h4 id="PM2"><a href="#PM2" class="headerlink" title="PM2"></a>PM2</h4><ol>
<li><p>如何上线Node编写的项目?</p>
<p>上线项目需要考虑的几个问题</p>
<ul>
<li>服务稳定性, 不会因为程序的某个错误或异常导致项目停止服务</li>
<li>线上日志记录, 除了记录访问日志以外, 我们还需要记录错误日志和自定义日志</li>
<li>充分利用服务器资源, Node是单线程的, 服务器是多核的, 一台服务器只运行一个Node程序太浪费资源</li>
</ul>
</li>
<li><p>如何解决上述问题?</p>
<p>通过<strong>PM2</strong></p>
<ul>
<li><p>PM2的进程守护可以在程序崩溃后自动重启</p>
</li>
<li><p>PM2自带日志记录的功能, 可以很方便的记录错误日志和自定义日志</p>
</li>
<li><p>PM2能够启动多个Node进程, 充分利用服务器资源</p>
</li>
</ul>
</li>
</ol>
<h5 id="PM2基本使用"><a href="#PM2基本使用" class="headerlink" title="PM2基本使用"></a>PM2基本使用</h5><p><code>npm install pm2 -g</code></p>
<p><code>pm2 start app.js</code></p>
<h5 id="PM2常用指定"><a href="#PM2常用指定" class="headerlink" title="PM2常用指定"></a>PM2常用指定</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pm2 start app.js|config     <span class="comment">// 启动应用程序</span></span><br><span class="line">pm2 list                    <span class="comment">// 列出启动的所有的应用程序</span></span><br><span class="line">pm2 restart appName|appId   <span class="comment">// 重启应用程序</span></span><br><span class="line">pm2 info appName|appId      <span class="comment">// 查看应用程序详细信息</span></span><br><span class="line">pm2 log appName|appId       <span class="comment">// 显示指定应用程序的日志</span></span><br><span class="line">pm2 monit appName|appId     <span class="comment">// 监控应用程序</span></span><br><span class="line">pm2 stop appName|appId      <span class="comment">// 停止应用程序</span></span><br><span class="line">pm2 <span class="keyword">delete</span> appName|appId    <span class="comment">// 关闭并删除所有应用</span></span><br></pre></td></tr></table></figure>

<h5 id="PM2-进程守护"><a href="#PM2-进程守护" class="headerlink" title="PM2 进程守护"></a>PM2 进程守护</h5><p>PM2的进程守护可以在程序崩溃后自动重启</p>
<h5 id="PM2常用配置"><a href="#PM2常用配置" class="headerlink" title="PM2常用配置"></a>PM2常用配置</h5><p>pm2.conf.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"apps"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"应用程序名称"</span>,</span><br><span class="line">    <span class="attr">"script"</span>: <span class="string">"入口文件名称"</span>,</span><br><span class="line">    <span class="attr">"watch"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"ignore_watch"</span>: [</span><br><span class="line">      <span class="string">"node_modules"</span>,</span><br><span class="line">      <span class="string">"logs"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"error_file"</span>: <span class="string">"logs/错误日志文件名称"</span>,</span><br><span class="line">    <span class="attr">"out_file"</span>: <span class="string">"logs/自定义日志文件名称"</span>,</span><br><span class="line">    <span class="attr">"log_date_format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过配置文件来启动<code>pm2 start pm2.conf.json</code></p>
<h5 id="PM2多进程"><a href="#PM2多进程" class="headerlink" title="PM2多进程"></a>PM2多进程</h5><p>在配置文件中增加 instances 配置, 想启动几个Node进程就写几个</p>
<p>注意点:instances 个数 不能超过服务器CPU的核数</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"apps"</span>:&#123;</span><br><span class="line">    <span class="attr">"name"</span>:<span class="string">"应用程序名称"</span>,</span><br><span class="line">    <span class="attr">"script"</span>: <span class="string">"入口文件名称"</span>,</span><br><span class="line">    <span class="attr">"watch"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"ignore_watch"</span>: [</span><br><span class="line">      <span class="string">"node_modules"</span>,</span><br><span class="line">      <span class="string">"logs"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"error_file"</span>: <span class="string">"logs/错误日志文件名称"</span>,</span><br><span class="line">    <span class="attr">"out_file"</span>: <span class="string">"logs/自定义日志文件名称"</span>,</span><br><span class="line">    <span class="attr">"log_date_format"</span>: <span class="string">"yyyy-MM-dd HH:mm:ss"</span>,</span><br><span class="line">     <span class="attr">"instances "</span>: <span class="number">4</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2020/12/09/KOA%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/09/KOA%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">KOA入门学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>

              <time title="أُنشأ: 2020-12-09 16:47:10" itemprop="dateCreated datePublished" datetime="2020-12-09T16:47:10+08:00">2020-12-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">عُدل في</span>
                <time title="عُدل: 2020-12-14 14:07:30" itemprop="dateModified" datetime="2020-12-14T14:07:30+08:00">2020-12-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="开篇"><a href="#开篇" class="headerlink" title="开篇"></a>开篇</h4><ol>
<li><p>什么是Express?</p>
<p>Express是第一代最流行的web框架，它对Node.js的http进行了封装</p>
<p>但是它是’基于ES5’的语法，内部实现异步代码，只有一个方法：’回调’</p>
</li>
<li><p>什么是KOA1.x?</p>
<p>随着新版Node.js开始支持ES6，Express的团队又’基于ES6’重新编写了下一代web框架koa。</p>
<p>和Express相比，koa 1.x’使用generator实现异步’.</p>
<p>用generator实现异步比回调简单了不少，但是generator的本意并不是异步</p>
</li>
<li><p>什么是KOA2.x?</p>
<p>koa团队并没有止步于koa 1.x，他们非常超前地’基于ES7’开发了koa2，</p>
<p>和koa 1相比，koa2完全’使用Promise并配合async来实现异步’</p>
</li>
<li><p>Express、Koa1.x、Koa2.x区别</p>
<ul>
<li><p>最大的区别就是内部实现异步的方式不同</p>
<ul>
<li>Express使用回调函数实现异步, 容易出现回调地狱问题, 但是语法更老兼容性更好</li>
<li>Koa1.x使用generator实现异步, 解决了回调地域问题, 但是generator的本意并不是异步</li>
<li>Koa2.x使用Promise并配合async来实现异步, 解决了回调地域问题, 但是语法太新兼容性不好</li>
</ul>
</li>
<li><p>第二大的区别就是重量级不同</p>
<p>Express中内置了很多封装好的功能, 而Koa中将这些功能都封装到了独立的模块中</p>
<p>想要使用这些功能必须先安装对应的模块才能使用, 所以Koa比Express更轻量级</p>
</li>
</ul>
</li>
</ol>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><ol>
<li><p>如何使用Koa?</p>
<ul>
<li><p>手动安装手动配置</p>
</li>
<li><p>利用Koa脚手架工具安装使用(Koa-generator)</p>
</li>
</ul>
</li>
<li><p>手动安装手动配置  <a href="https://www.npmjs.com/package/koa" target="_blank" rel="noopener">https://www.npmjs.com/package/koa</a></p>
</li>
</ol>
<h5 id="手动安装手动配置"><a href="#手动安装手动配置" class="headerlink" title="手动安装手动配置"></a>手动安装手动配置</h5><ol>
<li><p><code>npm install koa</code></p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入Koa</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">app.use(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">'Hello Koa'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="处理静态资源"><a href="#处理静态资源" class="headerlink" title="处理静态资源"></a>处理静态资源</h5><ol>
<li><p>Koa如何处理静态资源?</p>
<p>Koa是一个轻量级的框架, 它将所有的附加功能都封装到了独立的模块中</p>
<p>所以想要使用这些功能, 都必须先安装才能使用</p>
<p><a href="https://www.npmjs.com/package/koa-static" target="_blank" rel="noopener">https://www.npmjs.com/package/koa-static</a></p>
<p><code>npm install koa-static</code></p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>); <span class="comment">// 导入处理静态资源的模块</span></span><br><span class="line"><span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(serve(<span class="string">'public'</span>)); <span class="comment">// 注册处理静态资源的中间件</span></span><br><span class="line"><span class="comment">// response</span></span><br><span class="line">app.use(<span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    ctx.body = <span class="string">'Hello Koa'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问<code>localhost:3000/login.html</code></p>
</li>
</ol>
<h5 id="处理动态网页"><a href="#处理动态网页" class="headerlink" title="处理动态网页"></a>处理动态网页</h5><ol>
<li><p>Koa如何处理动态资源?</p>
<p><a href="https://www.npmjs.com/package/koa-views" target="_blank" rel="noopener">https://www.npmjs.com/package/koa-views</a></p>
<p><code>npm install koa-views</code></p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.导入Koa</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>); <span class="comment">// 导入处理静态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>); <span class="comment">// 导入处理动态资源的模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(serve(<span class="string">'public'</span>)); <span class="comment">// 注册处理静态资源的中间件</span></span><br><span class="line">app.use(views(<span class="string">'views'</span>, &#123;<span class="attr">extension</span>: <span class="string">'ejs'</span>&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// response</span></span><br><span class="line"><span class="comment">// koa中的ctx就是express中的req,res的结合体</span></span><br><span class="line">app.use( <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="comment">// ctx.body = 'Hello Koa';</span></span><br><span class="line">    <span class="keyword">await</span> ctx.render(<span class="string">'index'</span>, &#123;<span class="attr">msg</span>: <span class="string">'妮妮碎碎念'</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问<code>localhost:3000</code></p>
</li>
</ol>
<h5 id="处理路由"><a href="#处理路由" class="headerlink" title="处理路由"></a>处理路由</h5><ol>
<li><p>Koa如何处理路由?</p>
<p><a href="https://www.npmjs.com/package/koa-router" target="_blank" rel="noopener">https://www.npmjs.com/package/koa-router</a></p>
<p><a href="https://github.com/ZijianHe/koa-router" target="_blank" rel="noopener">https://github.com/ZijianHe/koa-router</a></p>
<p><code>npm install koa-router</code></p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入Koa</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>); <span class="comment">// 导入处理静态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>); <span class="comment">// 导入处理动态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>); <span class="comment">// 导入处理路由的模块</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router(); <span class="comment">// 创建路由对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(serve(<span class="string">'public'</span>)); <span class="comment">// 注册处理静态资源的中间件</span></span><br><span class="line">app.use(views(<span class="string">'views'</span>, &#123;<span class="attr">extension</span>: <span class="string">'ejs'</span>&#125;)); <span class="comment">// 注册处理动态资源的中间件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理路由</span></span><br><span class="line">router.get(<span class="string">'/api/goods/list'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    ctx.body = <span class="string">'get /api/goods/list'</span>; <span class="comment">// ctx.body === res.writeHeader + res.end</span></span><br><span class="line">&#125;);</span><br><span class="line">router.get(<span class="string">'/api/user/login'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        method: <span class="string">'get'</span>,</span><br><span class="line">        name: <span class="string">'xxn'</span>,</span><br><span class="line">        age: <span class="number">66</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">router.post(<span class="string">'/api/goods/detail'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    ctx.body = <span class="string">'post /api/goods/detail'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">router.post(<span class="string">'/api/user/register'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">        method: <span class="string">'post'</span>,</span><br><span class="line">        name: <span class="string">'666'</span>,</span><br><span class="line">        age: <span class="number">33</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">    .use(router.routes()) <span class="comment">// 启动路由功能</span></span><br><span class="line">    .use(router.allowedMethods()); <span class="comment">// 自动设置响应头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问<code>localhost:3000</code></p>
</li>
</ol>
<h5 id="处理get请求"><a href="#处理get请求" class="headerlink" title="处理get请求"></a>处理get请求</h5><ol>
<li><p>Koa如何处理Get请求参数?</p>
<ul>
<li><p>处理传统get参数</p>
</li>
<li><p>处理动态路由形式get参数</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入Koa</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>); <span class="comment">// 导入处理静态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>); <span class="comment">// 导入处理动态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>); <span class="comment">// 导入处理路由的模块</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router(); <span class="comment">// 创建路由对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/user'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> request = ctx.request;</span><br><span class="line">    <span class="built_in">console</span>.log(request.query); <span class="comment">// 获取转换成对象之后的get请求参数</span></span><br><span class="line">    <span class="built_in">console</span>.log(request.querystring); <span class="comment">// 获取字符串形式的get请求参数</span></span><br><span class="line">&#125;);</span><br><span class="line">router.get(<span class="string">'/login/:name/:age'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(ctx.params);</span><br><span class="line">&#125;);</span><br><span class="line">app.use(serve(<span class="string">'public'</span>)); <span class="comment">// 注册处理静态资源的中间件</span></span><br><span class="line">app.use(views(<span class="string">'views'</span>, &#123;<span class="attr">extension</span>: <span class="string">'ejs'</span>&#125;)); <span class="comment">// 注册处理动态资源的中间件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理路由</span></span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">    .use(router.routes()) <span class="comment">// 启动路由功能</span></span><br><span class="line">    .use(router.allowedMethods()); <span class="comment">// 自动设置响应头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="处理post请求"><a href="#处理post请求" class="headerlink" title="处理post请求"></a>处理post请求</h5><ol>
<li><p>Koa如何处理Post请求参数?</p>
<ul>
<li><p>借助koa-bodyparser中间件</p>
</li>
<li><p>koa-bodyparser中间件会将post请求参数转换成对象之后放到请求对象的body中</p>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入Koa</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>); <span class="comment">// 导入处理静态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>); <span class="comment">// 导入处理动态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>); <span class="comment">// 导入处理路由的模块</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router(); <span class="comment">// 创建路由对象</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>); <span class="comment">// 导入处理post请求参数的模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">app.use(serve(<span class="string">'public'</span>)); <span class="comment">// 注册处理静态资源的中间件</span></span><br><span class="line">app.use(views(<span class="string">'views'</span>, &#123;<span class="attr">extension</span>: <span class="string">'ejs'</span>&#125;)); <span class="comment">// 注册处理动态资源的中间件</span></span><br><span class="line"></span><br><span class="line">app.use(bodyParser()); <span class="comment">// 注册处理post请求参数的中间件</span></span><br><span class="line"><span class="comment">// 处理路由</span></span><br><span class="line">router.post(<span class="string">'/user'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> request = ctx.request;</span><br><span class="line">    <span class="built_in">console</span>.log(request.body);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app</span><br><span class="line">    .use(router.routes()) <span class="comment">// 启动路由功能</span></span><br><span class="line">    .use(router.allowedMethods()); <span class="comment">// 自动设置响应头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="处理cookie"><a href="#处理cookie" class="headerlink" title="处理cookie"></a>处理cookie</h5><ol>
<li><p>Koa如何处理cookie?</p>
<p>Koa中处理cookie不需要引入其他模块, 只要拿到ctx对象就可以操作cookie</p>
<p><a href="https://demopark.github.io/koa-docs-Zh-CN/" target="_blank" rel="noopener">https://demopark.github.io/koa-docs-Zh-CN/</a></p>
<p><a href="https://demopark.github.io/koa-docs-Zh-CN/api/context.html" target="_blank" rel="noopener">https://demopark.github.io/koa-docs-Zh-CN/api/context.html</a></p>
<p><em>注意点：如何在koa中存储值为中文的cookie</em></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 1.导入Koa</span></span><br><span class="line">   <span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line">   <span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>); <span class="comment">// 导入处理静态资源的模块</span></span><br><span class="line">   <span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>); <span class="comment">// 导入处理动态资源的模块</span></span><br><span class="line">   <span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>); <span class="comment">// 导入处理路由的模块</span></span><br><span class="line">   <span class="keyword">const</span> router = <span class="keyword">new</span> Router(); <span class="comment">// 创建路由对象</span></span><br><span class="line">   <span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>); <span class="comment">// 导入处理post请求参数的模块</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line">   <span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">   </span><br><span class="line">   app.use(serve(<span class="string">'public'</span>)); <span class="comment">// 注册处理静态资源的中间件</span></span><br><span class="line">   app.use(views(<span class="string">'views'</span>, &#123;<span class="attr">extension</span>: <span class="string">'ejs'</span>&#125;)); <span class="comment">// 注册处理动态资源的中间件</span></span><br><span class="line">   app.use(bodyParser()); <span class="comment">// 注册处理post请求参数的中间件</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 处理路由</span></span><br><span class="line">   router.get(<span class="string">'/setCookie'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">       <span class="comment">// ctx.cookies.set('name', 'nini', &#123;</span></span><br><span class="line">       <span class="comment">//     path: '/',</span></span><br><span class="line">       <span class="comment">//     httpOnly: true,</span></span><br><span class="line">       <span class="comment">//     maxAge: 24 * 60 * 60 * 1000</span></span><br><span class="line">       <span class="comment">// &#125;);</span></span><br><span class="line">       <span class="comment">// 注意点: 在koa中不能给cookie设置中文的值</span></span><br><span class="line">       <span class="keyword">let</span> value = <span class="keyword">new</span> Buffer(<span class="string">'妮妮'</span>).toString(<span class="string">'base64'</span>);</span><br><span class="line">       ctx.cookies.set(<span class="string">'userName'</span>, value, &#123;</span><br><span class="line">           path: <span class="string">'/'</span>,</span><br><span class="line">           httpOnly: <span class="literal">true</span>,</span><br><span class="line">           maxAge: <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span></span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="comment">// let value = new Buffer('妮妮').toString('base64');</span></span><br><span class="line">       <span class="comment">// console.log(value); // 5p2O5Y2X5rGf</span></span><br><span class="line">       <span class="comment">// let res = new Buffer('5p2O5Y2X5rGf', 'base64').toString();</span></span><br><span class="line">       <span class="comment">// console.log(res);</span></span><br><span class="line">   &#125;);</span><br><span class="line">   router.get(<span class="string">'/getCookie'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">       <span class="comment">// console.log(ctx.cookies.get('name'));</span></span><br><span class="line">       <span class="keyword">let</span> value = ctx.cookies.get(<span class="string">'userName'</span>);</span><br><span class="line">       <span class="keyword">let</span> res = <span class="keyword">new</span> Buffer(value, <span class="string">'base64'</span>).toString();</span><br><span class="line">       <span class="built_in">console</span>.log(res);</span><br><span class="line">   &#125;);</span><br><span class="line">   app</span><br><span class="line">       .use(router.routes()) <span class="comment">// 启动路由功能</span></span><br><span class="line">       .use(router.allowedMethods()); <span class="comment">// 自动设置响应头</span></span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h5 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h5><ol>
<li><p>Koa如何处理错误?</p>
<p>使用koa-onerror模块</p>
<p><a href="https://www.npmjs.com/package/koa-onerror" target="_blank" rel="noopener">https://www.npmjs.com/package/koa-onerror</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入Koa</span></span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>); <span class="comment">// 导入处理静态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>); <span class="comment">// 导入处理动态资源的模块</span></span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>); <span class="comment">// 导入处理路由的模块</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router(); <span class="comment">// 创建路由对象</span></span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>); <span class="comment">// 导入处理post请求参数的模块</span></span><br><span class="line"><span class="keyword">const</span> onerror = <span class="built_in">require</span>(<span class="string">'koa-onerror'</span>); <span class="comment">// 导入处理错误的模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line">onerror(app); <span class="comment">// 告诉koa-onerror我们需要捕获所有服务端实例对象的错误</span></span><br><span class="line"></span><br><span class="line">app.use(serve(<span class="string">'public'</span>)); <span class="comment">// 注册处理静态资源的中间件</span></span><br><span class="line">app.use(views(<span class="string">'views'</span>, &#123;<span class="attr">extension</span>: <span class="string">'ejs'</span>&#125;)); <span class="comment">// 注册处理动态资源的中间件</span></span><br><span class="line">app.use(bodyParser()); <span class="comment">// 注册处理post请求参数的中间件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理路由</span></span><br><span class="line">router.get(<span class="string">'/api/user/login'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    ctx.body = <span class="string">'我是登录'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">router.get(<span class="string">'/api/user/register'</span>, (ctx, next)=&gt;&#123;</span><br><span class="line">    ctx.body = <span class="string">'我是注册'</span>;</span><br><span class="line">&#125;);</span><br><span class="line">app</span><br><span class="line">    .use(router.routes()) <span class="comment">// 启动路由功能</span></span><br><span class="line">    .use(router.allowedMethods()); <span class="comment">// 自动设置响应头</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理错误</span></span><br><span class="line">app.use(<span class="function">(<span class="params">err, ctx</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.status, err.message);</span><br><span class="line">    ctx.body = err.message;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.指定监听的端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>撒花撒花~~</p>
<h5 id="使用脚手架"><a href="#使用脚手架" class="headerlink" title="使用脚手架"></a>使用脚手架</h5><ol>
<li><p>全局安装koa-generator</p>
<ul>
<li><p><code>npm install -g koa-generator</code></p>
</li>
<li><p>quickly start</p>
<p><code>koa demo &amp;&amp; cd demo</code></p>
<p><code>koa2 demo &amp;&amp; cd demo</code></p>
</li>
</ul>
</li>
<li><p>与express-generator不同的是，通过koa-generator生成项目里已经使用了nodemon，无序额外安装及设置</p>
</li>
<li><p>目录结构介绍-参照express</p>
<p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>) <span class="comment">// 导入koa</span></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa() <span class="comment">// 创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> views = <span class="built_in">require</span>(<span class="string">'koa-views'</span>) <span class="comment">// 导入了处理动态资源包</span></span><br><span class="line"><span class="keyword">const</span> json = <span class="built_in">require</span>(<span class="string">'koa-json'</span>) <span class="comment">// 导入了输出json格式的包</span></span><br><span class="line"><span class="keyword">const</span> onerror = <span class="built_in">require</span>(<span class="string">'koa-onerror'</span>) <span class="comment">// 导入了处理错误的包</span></span><br><span class="line"><span class="keyword">const</span> bodyparser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>) <span class="comment">// 导入了处理post请求参数包</span></span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'koa-logger'</span>) <span class="comment">// 导入了记录日志包</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> index = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>) <span class="comment">// 导入了封装好的路由</span></span><br><span class="line"><span class="keyword">const</span> users = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// error handler</span></span><br><span class="line">onerror(app) <span class="comment">// 告诉系统需要捕获哪一个程序的错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册了解析post请求参数的中间件</span></span><br><span class="line">app.use(bodyparser(&#123;</span><br><span class="line">  enableTypes:[<span class="string">'json'</span>, <span class="string">'form'</span>, <span class="string">'text'</span>]</span><br><span class="line">&#125;))</span><br><span class="line">app.use(json())</span><br><span class="line"><span class="comment">// 注册了记录日志的中间件</span></span><br><span class="line">app.use(logger())</span><br><span class="line"><span class="comment">// 注册了处理静态资源的中间件</span></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'koa-static'</span>)(__dirname + <span class="string">'/public'</span>))</span><br><span class="line"><span class="comment">// 注册了处理动态资源的中间件</span></span><br><span class="line">app.use(views(__dirname + <span class="string">'/views'</span>, &#123;</span><br><span class="line">  extension: <span class="string">'pug'</span></span><br><span class="line">&#125;))</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 记录日志</span></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">  <span class="keyword">await</span> next()</span><br><span class="line">  <span class="keyword">const</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span>() - start</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx.url&#125;</span> - <span class="subst">$&#123;ms&#125;</span>ms`</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册启用了路由</span></span><br><span class="line">app.use(index.routes(), index.allowedMethods())</span><br><span class="line">app.use(users.routes(), users.allowedMethods())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理错误</span></span><br><span class="line">app.on(<span class="string">'error'</span>, (err, ctx) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.error(<span class="string">'server error'</span>, err, ctx)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2020/12/09/webpack%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/09/webpack%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">webpack基础配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>
              

              <time title="أُنشأ: 2020-12-09 16:16:43 / عُدل: 16:17:50" itemprop="dateCreated datePublished" datetime="2020-12-09T16:16:43+08:00">2020-12-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>sourcemap存储映射关系</p>
<ul>
<li><strong>development</strong>： cheap-module-eval-source-map</li>
</ul>
<p>只需要行错误信息, 并且包含第三方模块错误信息, 并且不会生成单独sourcemap文件</p>
<ul>
<li><strong>production</strong>: cheap-module-source-map</li>
</ul>
<p>只需要行错误信息, 并且包含第三方模块错误信息, 并且会生成单独sourcemap文件</p>
</li>
<li><p>module: 告诉webpack如何处理webpack不能够识别的文件</p>
<ul>
<li><p>打包图片规则:url-loader</p>
<p>优势:(相比于file-loader)</p>
<ul>
<li>图片比较小的时候直接转换成base64字符串图片, 减少请求次数</li>
<li>图片比较大的时候由于生成的base64字符串图片也比较大, 就保持原有的图片</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    test: <span class="regexp">/\.(png|jpg|gif)$/</span>,</span><br><span class="line">    use: [</span><br><span class="line">        &#123;</span><br><span class="line">            loader: <span class="string">'url-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">                <span class="comment">// 指定图片限制的大小</span></span><br><span class="line">                limit: <span class="number">1024</span> * <span class="number">100</span>,</span><br><span class="line">                <span class="comment">// 指定打包后文件名称</span></span><br><span class="line">                name: <span class="string">'[name].[ext]'</span>,</span><br><span class="line">                <span class="comment">// 指定打包后文件存放目录</span></span><br><span class="line">                outputPath: <span class="string">'images/'</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>



</li>
</ol>
<ul>
<li>配置less-loader</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">  use: [&#123;</span><br><span class="line">      loader: <span class="string">"style-loader"</span> <span class="comment">// 将 JS 字符串生成为 style 节点</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">      loader: <span class="string">"css-loader"</span> ,<span class="comment">// 将 CSS 转化成 CommonJS 模块</span></span><br><span class="line">       options: &#123;</span><br><span class="line">        modules: <span class="literal">true</span> <span class="comment">// 开启CSS模块化</span></span><br><span class="line">       &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">      loader: <span class="string">"less-loader"</span> <span class="comment">// 将 less 编译成 CSS</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            <em>use:自下而上，自右向左</em></p>
<ol start="3">
<li><p>plugins: 告诉webpack需要新增一些什么样的功能</p>
<ul>
<li>HtmlWebpackPlugin</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">plugins: [<span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">    <span class="comment">// 指定打包的模板, 如果不指定会自动生成一个空的</span></span><br><span class="line">    template: <span class="string">"./index.html"</span>,</span><br><span class="line">    minify: &#123;</span><br><span class="line">        <span class="comment">// 告诉htmlplugin打包之后的html文件需要压缩</span></span><br><span class="line">        collapseWhitespace: <span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)]</span><br></pre></td></tr></table></figure>
</li>
<li><p>webpack-watch</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">watch: <span class="literal">true</span>,</span><br><span class="line">watchOptions: &#123;</span><br><span class="line">    aggregateTimeout: <span class="number">300</span>, <span class="comment">// 防抖, 和函数防抖一样, 改变过程中不重新打包, 只有改变完成指定时间后才打包</span></span><br><span class="line">    poll: <span class="number">1000</span>, <span class="comment">// 每隔多少时间检查一次变动</span></span><br><span class="line">    ignored: <span class="regexp">/node_modules/</span> <span class="comment">// 排除一些巨大的文件夹, 不需要监控的文件夹</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">optimization: 配置webpack的优化项</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line">optimization: &#123;</span><br><span class="line">    minimizer: [<span class="keyword">new</span> TerserJSPlugin(&#123;&#125;), <span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;&#125;)],</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>devServer:自动检测文件变化配置</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">    contentBase: <span class="string">"./bundle"</span>, <span class="comment">// 打包后的目录</span></span><br><span class="line">    open: <span class="literal">true</span>, <span class="comment">// 是否自动在浏览器中打开</span></span><br><span class="line">    port: <span class="number">9090</span> <span class="comment">// 服务器端口号</span></span><br><span class="line">    proxy: [&#123;</span><br><span class="line">        context: [<span class="string">"/user"</span>, <span class="string">"/login"</span>],</span><br><span class="line">        target: <span class="string">"http://127.0.0.1:3000"</span>,</span><br><span class="line">        changeOrigin: <span class="literal">true</span>,     <span class="comment">// 域名跨域</span></span><br><span class="line">        secure: <span class="literal">false</span>,          <span class="comment">// https跨域</span></span><br><span class="line">        pathRewrite:&#123;<span class="string">""</span>: <span class="string">"/api"</span>&#125; <span class="comment">// 路径重写, 将路径中的api替换为空</span></span><br><span class="line">    &#125;],</span><br><span class="line">    hot: <span class="literal">true</span>, <span class="comment">// 开启热更新, 只要开启了热更新就不会自动刷新网页了</span></span><br><span class="line">    hotOnly: <span class="literal">true</span> <span class="comment">// 哪怕不支持热更新也不要刷新网页</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2020/12/09/TypeScript%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/09/TypeScript%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">TypeScript入门笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>
              

              <time title="أُنشأ: 2020-12-09 16:16:18 / عُدل: 16:19:48" itemprop="dateCreated datePublished" datetime="2020-12-09T16:16:18+08:00">2020-12-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>修改webpack配置文件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">entry: <span class="string">"./src/js/index.ts"</span>,</span><br><span class="line">resolve: &#123;</span><br><span class="line">	extensions: [ <span class="string">'.tsx'</span>, <span class="string">'.ts'</span>, <span class="string">'.js'</span> ]</span><br><span class="line">  	&#125;,</span><br><span class="line">   <span class="built_in">module</span>: &#123;</span><br><span class="line">       rules: [</span><br><span class="line">           <span class="comment">// ts编译配置</span></span><br><span class="line">           &#123;</span><br><span class="line">               test: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">               use: <span class="string">'ts-loader'</span>,</span><br><span class="line">               exclude: <span class="regexp">/node_modules/</span></span><br><span class="line">           &#125;</span><br><span class="line">       ]</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<h5 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h5><h6 id="数组和元祖"><a href="#数组和元祖" class="headerlink" title="数组和元祖"></a>数组和元祖</h6><ul>
<li><p>数组</p>
<ul>
<li><code>let arr1:Array&lt;number&gt;</code>:表示定义了一个名称叫做arr1的数组, 这个数组中将来只能够存储数值类型的数据</li>
<li><code>let arr2:string[]</code>:只能够存储字符串类型的数据</li>
<li><code>let arr3:(number | string)[]</code>:既可以存储数值类型的数据, 也可以存储字符串类型的数据</li>
<li><code>let arr4:any[]</code>:任意类型</li>
</ul>
</li>
<li><p>元组：定长定类型</p>
<ul>
<li><code>let arr5:[string, number, boolean]</code> : 表示定义了一个名称叫做arr5的元祖, 这个元祖中将来可以（只能）存储3个元素, 第一个元素必须是字符串类型, 第二个元素必须是数字类型, 第三个元素必须是布尔类型</li>
</ul>
</li>
</ul>
<h6 id="枚举类型：表示固定的几个取值"><a href="#枚举类型：表示固定的几个取值" class="headerlink" title="枚举类型：表示固定的几个取值"></a>枚举类型：表示固定的几个取值</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义了一个名称叫做Gender的枚举类型, 这个枚举类型的取值有两个, 分别是Male和Femal</span></span><br><span class="line"><span class="keyword">enum</span> Gender&#123; </span><br><span class="line">  Male,</span><br><span class="line">  Femal</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义了一个名称叫做val的变量, 这个变量中只能保存Male或者Femal</span></span><br><span class="line"><span class="keyword">let</span> val:Gender; </span><br><span class="line">val = Gender.Male;</span><br><span class="line">val = Gender.Femal;</span><br><span class="line">val = <span class="string">'nini'</span>; <span class="comment">// 报错</span></span><br><span class="line">val = <span class="literal">false</span>;<span class="comment">// 报错</span></span><br><span class="line">val = <span class="number">666</span>; <span class="comment">// 不会报错</span></span><br><span class="line"><span class="comment">// TS中的枚举底层实现的本质其实就是数值类型, 所以赋值一个数值不会报错</span></span><br><span class="line"><span class="built_in">console</span>.log(Gender.Male); <span class="comment">// 0</span></span><br><span class="line"><span class="built_in">console</span>.log(Gender.Femal);<span class="comment">// 1</span></span><br><span class="line"><span class="built_in">console</span>.log(Gender[<span class="number">0</span>]);<span class="comment">// Male</span></span><br><span class="line"><span class="built_in">console</span>.log(Gender[<span class="number">1</span>]);<span class="comment">// Femal</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 探究底层实现原理</span></span><br><span class="line"><span class="keyword">var</span> Gender;</span><br><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">Gender</span>) </span>&#123;</span><br><span class="line"> <span class="comment">// Gender[key] = value;</span></span><br><span class="line">  Gender[Gender[<span class="string">"Male"</span>] = <span class="number">0</span>] = <span class="string">"Male"</span>;</span><br><span class="line">  Gender[Gender[<span class="string">"Femal"</span>] = <span class="number">1</span>] = <span class="string">"Femal"</span>;</span><br><span class="line">&#125;)(Gender || (Gender = &#123;&#125;));</span><br><span class="line"><span class="comment">// Gender["Male"] = 0  返回 0</span></span><br><span class="line"><span class="keyword">let</span> Gender = &#123;&#125;;</span><br><span class="line">Gender[<span class="string">"Male"</span>] = <span class="number">0</span>;</span><br><span class="line">Gender[<span class="number">0</span>] = <span class="string">"Male"</span>;</span><br><span class="line">Gender[<span class="string">"Femal"</span>] = <span class="number">1</span>;</span><br><span class="line">Gender[<span class="number">1</span>] = <span class="string">"Femal"</span>;</span><br></pre></td></tr></table></figure>

<h6 id="any和void"><a href="#any和void" class="headerlink" title="any和void"></a>any和void</h6><ul>
<li>any表示任意类型，一般用于定义一些通用性比较强的变量, 或者用于保存从其它框架中获取的不确定类型的值</li>
<li>void与any正好相反, 表示没有任何类型, 一般用于函数返回值，在TS中只有null和undefined可以赋值给void类型</li>
</ul>
<h6 id="Never和Object类型"><a href="#Never和Object类型" class="headerlink" title="Never和Object类型"></a>Never和Object类型</h6><ul>
<li><p>Never：表示的是那些永不存在的值的类型</p>
<p>一般用于抛出异常或根本不可能有返回值的函数</p>
</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">demo</span>(<span class="params"></span>):<span class="title">never</span> </span>&#123;</span><br><span class="line">   <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'报错了'</span>);</span><br><span class="line">&#125;</span><br><span class="line">demo();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">demo2</span>(<span class="params"></span>):<span class="title">never</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">demo2();</span><br></pre></td></tr></table></figure>

<ul>
<li>Object:对象</li>
</ul>
<p><code>let obj:object</code></p>
<h6 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> str1:<span class="built_in">any</span> = <span class="string">'nini'</span>;</span><br><span class="line"><span class="comment">// 方式一</span></span><br><span class="line"> <span class="keyword">let</span> len = (&lt;<span class="built_in">string</span>&gt;str1).length;</span><br><span class="line"><span class="comment">// 方式二</span></span><br><span class="line"><span class="comment">// 注意点: 在企业开发中推荐使用as来进行类型转换(类型断言)</span></span><br><span class="line"><span class="comment">//         因为第一种方式有兼容性问题, 在使用到了JSX的时候兼容性不是很好</span></span><br><span class="line"><span class="keyword">let</span> len = (str1 <span class="keyword">as</span> <span class="built_in">string</span>).length;</span><br><span class="line"><span class="built_in">console</span>.log(len);</span><br></pre></td></tr></table></figure>

<h5 id="接口类型"><a href="#接口类型" class="headerlink" title="接口类型"></a>接口类型</h5><ul>
<li>基本使用</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> FullName&#123;</span><br><span class="line">    firstName:<span class="built_in">string</span></span><br><span class="line">    lastName:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    firstName:<span class="string">'Jonathan'</span>,</span><br><span class="line">    lastName:<span class="string">'Lee'</span></span><br><span class="line">    <span class="comment">// lastName:18</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 需求: 要求定义一个函数输出一个人完整的姓名, 这个人的姓必须是字符串, 这个人的名也必须是一个字符</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params">&#123;firstName, lastName&#125;:FullName</span>):<span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`我的姓名是:<span class="subst">$&#123;firstName&#125;</span>_<span class="subst">$&#123;lastName&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line">say(obj);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>可选属性和索引签名</p>
<p><em>如果使用接口来限定了变量或者形参, 那么在给变量或者形参赋值的时候,赋予的值就必须和接口限定的一模一样才可以, 多一个或者少一个都不行</em>    </p>
<ul>
<li>少一个或少多个怎么做? –&gt;可选属性</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> FullName&#123;</span><br><span class="line">    firstName:<span class="built_in">string</span></span><br><span class="line">    lastName:<span class="built_in">string</span></span><br><span class="line">    middleName?:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>多一个或者多多个怎么做? 如果绕开TS检查</p>
<ul>
<li><p>方式一: 使用类型断言(告诉ts憋管我)</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">say(&#123;firstName:<span class="string">'Jonathan'</span>, lastName:<span class="string">'Lee'</span>, middleName:<span class="string">"666"</span>, abc:<span class="string">'abc'</span>&#125; <span class="keyword">as</span> FullName);</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二: 使用变量（不推荐）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">（<span class="keyword">let</span> obj = &#123;firstName:<span class="string">'Jonathan'</span>, lastName:<span class="string">'Lee'</span>, middleName:<span class="string">"666"</span>, abc:<span class="string">'abc'</span>&#125;;</span><br><span class="line">say(obj);</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式三: 使用索引签名</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> FullName&#123;</span><br><span class="line">    firstName:<span class="built_in">string</span></span><br><span class="line">    lastName:<span class="built_in">string</span></span><br><span class="line">    middleName?:<span class="built_in">string</span></span><br><span class="line">    [propName:<span class="built_in">string</span>]:<span class="built_in">any</span></span><br><span class="line">&#125;</span><br><span class="line">say(&#123;firstName:<span class="string">'Jonathan'</span>, lastName:<span class="string">'Lee'</span>, middleName:<span class="string">"666"</span>, abc:<span class="string">'abc'</span>, <span class="number">123</span>:<span class="number">123</span>, def:<span class="string">"def"</span>&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>索引签名</strong>：索引签名用于描述那些“通过索引得到”的类型，比如arr[10]或obj[“key”]</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> FullName &#123;</span><br><span class="line">    [propName:<span class="built_in">string</span>]:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> obj:FullName = &#123;</span><br><span class="line">    <span class="comment">// 注意点: 只要key和value满足索引签名的限定即可, 无论有多少个都无所谓</span></span><br><span class="line">    firstName:<span class="string">'Jonathan'</span>,</span><br><span class="line">    lastName:<span class="string">'Lee'</span>,</span><br><span class="line">    <span class="comment">// middleName:false // 报错</span></span><br><span class="line">    <span class="comment">// false: '666' // 无论key是什么类型最终都会自动转换成字符串类型, 所以没有报错</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>函数接口和混合类型接口</p>
<ul>
<li>函数接口</li>
</ul>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> SumInterface &#123;</span><br><span class="line">    (a:<span class="built_in">number</span>, b:<span class="built_in">number</span>):<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> sum:SumInterface = <span class="function"><span class="keyword">function</span> (<span class="params">x:<span class="built_in">number</span>, y:<span class="built_in">number</span></span>):<span class="title">number</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> res = sum(<span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>

<ul>
<li>混合类型接口：约定的内容中既有对象属性, 又有函数</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> CountInterface &#123;</span><br><span class="line">    ():<span class="built_in">void</span></span><br><span class="line">    count:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> getCounter = (<span class="function"><span class="keyword">function</span> (<span class="params"></span>):<span class="title">CountInterface</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    CountInterface接口要求数据既要是一个没有参数没有返回值的函数</span></span><br><span class="line"><span class="comment">                              又要是一个拥有count属性的对象</span></span><br><span class="line"><span class="comment">    fn作为函数的时候符合接口中函数接口的限定 ():void</span></span><br><span class="line"><span class="comment">    fn作为对象的时候符合接口中对象属性的限定  count:number</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="keyword">let</span> fn = &lt;CountInterface&gt;<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        fn.count++;</span><br><span class="line">        <span class="built_in">console</span>.log(fn.count);</span><br><span class="line">    &#125;</span><br><span class="line">    fn.count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> fn;</span><br><span class="line">&#125;)();</span><br><span class="line">getCounter();</span><br><span class="line">getCounter();</span><br><span class="line">getCounter();</span><br></pre></td></tr></table></figure>
</li>
<li><p>接口的继承</p>
</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> LengthInterface &#123;</span><br><span class="line">    length:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> WidthInterface &#123;</span><br><span class="line">    width:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> HeightInterface &#123;</span><br><span class="line">    height:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> RectInterface <span class="keyword">extends</span> LengthInterface,WidthInterface,HeightInterface &#123;</span><br><span class="line">    <span class="comment">// length:number</span></span><br><span class="line">    <span class="comment">// width:number</span></span><br><span class="line">    <span class="comment">// height:number</span></span><br><span class="line">    color:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> rect:RectInterface = &#123;</span><br><span class="line">    length:<span class="number">10</span>,</span><br><span class="line">    width:<span class="number">20</span>,</span><br><span class="line">    height:<span class="number">30</span>,</span><br><span class="line">    color:<span class="string">'red'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h5><h6 id="函数重载：同名的函数可以根据不同的参数实现不同的功能"><a href="#函数重载：同名的函数可以根据不同的参数实现不同的功能" class="headerlink" title="函数重载：同名的函数可以根据不同的参数实现不同的功能"></a>函数重载：同名的函数可以根据不同的参数实现不同的功能</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getArray</span>(<span class="params">x:<span class="built_in">number</span></span>):<span class="title">number</span>[]</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getArray</span>(<span class="params">str:<span class="built_in">string</span></span>):<span class="title">string</span>[]</span>;</span><br><span class="line"><span class="comment">// 实现函数的重载</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getArray</span>(<span class="params">value:<span class="built_in">any</span></span>):<span class="title">any</span>[] </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">typeof</span> value === <span class="string">'string'</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> value.split(<span class="string">''</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> arr = [];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= value; i++)&#123;</span><br><span class="line">            arr.push(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> arr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getArray = &lt;T&gt;(value:T, items:<span class="built_in">number</span> = <span class="number">5</span>):T[]=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Array</span>(items).fill(value);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// let arr = getArray&lt;string&gt;('abc');</span></span><br><span class="line"><span class="comment">// let arr = getArray&lt;number&gt;(6);</span></span><br><span class="line"><span class="comment">// 注意点: 泛型具体的类型可以不指定</span></span><br><span class="line"><span class="comment">//         如果没有指定, 那么就会根据我们传递的泛型参数自动推导出来</span></span><br><span class="line"><span class="keyword">let</span> arr = getArray(<span class="string">'abc'</span>);</span><br><span class="line"><span class="comment">// let arr = getArray(6);</span></span><br><span class="line"><span class="keyword">let</span> res = arr.map(<span class="function"><span class="params">item</span>=&gt;</span>item.length);</span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>

<h6 id="泛型约束"><a href="#泛型约束" class="headerlink" title="泛型约束"></a>泛型约束</h6><p>默认情况下我们可以指定泛型为任意类型</p>
<p>但是有些情况下我们需要指定的类型满足某些条件后才能指定</p>
<p>那么这个时候我们就可以使用泛型约束</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需求: 要求指定的泛型类型必须有Length属性才可以</span></span><br><span class="line"><span class="keyword">interface</span> LengthInterface&#123;</span><br><span class="line">    length:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> getArray = &lt;T <span class="keyword">extends</span> LengthInterface&gt;(value:T, items:<span class="built_in">number</span> = <span class="number">5</span>):T[]=&gt;&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Array</span>(items).fill(value);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> arr = getArray&lt;<span class="built_in">string</span>&gt;(<span class="string">'abc'</span>);</span><br><span class="line"><span class="comment">// let arr = getArray&lt;number&gt;(6);</span></span><br><span class="line"><span class="keyword">let</span> res = arr.map(<span class="function"><span class="params">item</span>=&gt;</span>item.length);</span><br></pre></td></tr></table></figure>



<h6 id="在泛型约束中使用类型参数"><a href="#在泛型约束中使用类型参数" class="headerlink" title="在泛型约束中使用类型参数"></a>在泛型约束中使用类型参数</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getProps = (obj:object,key:<span class="built_in">string</span>):<span class="function"><span class="params">any</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obj[key]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  a:<span class="string">'a'</span>,</span><br><span class="line">  b:<span class="string">'b'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(getProps(obj,<span class="string">'c'</span>));</span><br><span class="line"><span class="comment">// 代码不够健壮, 明明obj中没有c这个key但是却没有报错</span></span><br><span class="line"><span class="comment">// let res = getProps(obj, "c");</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> getProps = &lt;t,k <span class="keyword">extends</span> keyof t&gt;(obj:t,key:k):<span class="function"><span class="params">any</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> obj[key]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">  a:<span class="string">'a'</span>,</span><br><span class="line">  b:<span class="string">'b'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(getProps(obj,<span class="string">'c'</span>));<span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>

<h5 id="类"><a href="#类" class="headerlink" title="类"></a>类</h5><h6 id="类属性修饰符"><a href="#类属性修饰符" class="headerlink" title="类属性修饰符"></a>类属性修饰符</h6><ul>
<li><p>public(公开的)   :</p>
<p>如果使用public来修饰属性, 那么表示这个属性是公开的</p>
<p>可以在类的内部使用, 也可以在子类中使用, 也可以在外部使用</p>
</li>
<li><p>protected(受保护的) :</p>
<p>如果使用protected来修饰属性, 那么表示这个属性是受保护的</p>
<p>可以在类的内部使用, 也可以在子类中使用</p>
</li>
<li><p>private(私有的)   :</p>
<p>如果使用private来修饰属性, 那么表示这个属性是私有的</p>
<p>可以在类的内部使用</p>
</li>
<li><p>readonly(只读的)  :</p>
</li>
</ul>
<h6 id="类方法修饰符"><a href="#类方法修饰符" class="headerlink" title="类方法修饰符"></a>类方法修饰符</h6><ul>
<li><p>public :</p>
<p>如果使用public来修饰方法, 那么表示这个方法是公开的</p>
<p>可以在类的内部使用, 也可以在子类中使用, 也可以在外部使用</p>
</li>
<li><p>protected :</p>
<p>如果使用protected来修饰方法, 那么表示这个方法是受保护的</p>
<p>可以在类的内部使用, 也可以在子类中使用</p>
</li>
<li><p>private</p>
<p>如果使用private来修饰方法, 那么表示这个方法是私有的</p>
<p>可以在类的内部使用</p>
</li>
</ul>
<h6 id="可选属性和参数属性"><a href="#可选属性和参数属性" class="headerlink" title="可选属性和参数属性"></a>可选属性和参数属性</h6><ul>
<li><p>可选属性：和接口中的可选属性一样, 可传可不传的属性</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">  <span class="comment">// 注意点: 在TS中如果定义了实例属性, 那么就必须在构造函数中使用, 否则就会报错</span></span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  age?:<span class="built_in">number</span>; <span class="comment">// 可选属性</span></span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">name:<span class="built_in">string</span>, age?:<span class="built_in">number</span></span>)&#123;</span><br><span class="line">      <span class="keyword">this</span>.name = name;</span><br><span class="line">      <span class="keyword">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// setNameAndAge(name:string, age:number)&#123;</span></span><br><span class="line">  <span class="comment">//   this.name = name;</span></span><br><span class="line">  <span class="comment">//   this.age = age;</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> Person(<span class="string">'xxn'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(p);</span><br></pre></td></tr></table></figure>
</li>
<li><p>参数属性: 一句话搞定实例属性的接收和定义</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  age:<span class="built_in">number</span>;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">name:<span class="built_in">string</span>, age?:<span class="built_in">number</span></span>)&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.age = age;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> name:<span class="built_in">string</span>,<span class="keyword">public</span> age:<span class="built_in">number</span></span>)&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> Person(<span class="string">'xxn'</span>, <span class="number">18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(p);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="存取器"><a href="#存取器" class="headerlink" title="存取器"></a>存取器</h6><p>通过getters/setters来截取对对象成员的访问</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">    <span class="keyword">private</span> _age:<span class="built_in">number</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> age(val:<span class="built_in">number</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'进入了set age方法'</span>);</span><br><span class="line">        <span class="keyword">if</span>(val&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'人的年龄不能小于零'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>._age = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">get</span> age():<span class="built_in">number</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'进入了get age方法'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> Person();</span><br><span class="line">p.age = <span class="number">18</span>;</span><br><span class="line"><span class="comment">// p.age = -6; // p.age(-6);</span></span><br><span class="line"><span class="built_in">console</span>.log(p.age);</span><br></pre></td></tr></table></figure>

<h6 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义基类  不被外界创建</span></span><br><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    age: <span class="built_in">number</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">constructor</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> Student <span class="keyword">extends</span> Person&#123;</span><br><span class="line">    <span class="keyword">constructor</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>)&#123;</span><br><span class="line">        <span class="keyword">super</span>(name, age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// let p = new Person('xxn', 18); //报错</span></span><br><span class="line"><span class="keyword">let</span> stu = <span class="keyword">new</span> Student(<span class="string">'xxn'</span>, <span class="number">18</span>);</span><br><span class="line"><span class="built_in">console</span>.log(stu);</span><br></pre></td></tr></table></figure>

<p>抽象类：专门用于定义哪些不希望被外界直接创建的类的</p>
<p>抽象类一般用于定义基类</p>
<p>抽象类和接口一样用于约束子类</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> Person &#123;</span><br><span class="line">    <span class="keyword">abstract</span> name:<span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">abstract</span> say():<span class="built_in">void</span>;</span><br><span class="line">    <span class="comment">// 子类必须有name 必须有say()</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// let p = new Person(); // 报错</span></span><br><span class="line"><span class="keyword">class</span> Student <span class="keyword">extends</span> Person&#123;</span><br><span class="line">    name:<span class="built_in">string</span> = <span class="string">'xxn'</span>;</span><br><span class="line">    say():<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`我的名字是<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> stu = <span class="keyword">new</span> Student();</span><br><span class="line">stu.say();</span><br></pre></td></tr></table></figure>

<p><em>抽象类和接口区别?</em></p>
<ul>
<li><p>接口中只能定义约束, 不能定义具体实现</p>
</li>
<li><p>而抽象类中既可以定义约束, 又可以定义具体实现</p>
</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> Person &#123;</span><br><span class="line">    <span class="keyword">abstract</span> name:<span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">abstract</span> say():<span class="built_in">void</span>;</span><br><span class="line">    <span class="comment">// 子类必须有name 必须有say()</span></span><br><span class="line">    eat():<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>正在吃东西`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// let p = new Person();</span></span><br><span class="line"><span class="keyword">class</span> Student <span class="keyword">extends</span> Person&#123;</span><br><span class="line">    name:<span class="built_in">string</span> = <span class="string">'xxn'</span>;</span><br><span class="line">    say():<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`我的名字是<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> stu = <span class="keyword">new</span> Student();</span><br><span class="line">stu.say();</span><br><span class="line">stu.eat();</span><br></pre></td></tr></table></figure>

<h6 id="类”实现”接口"><a href="#类”实现”接口" class="headerlink" title="类”实现”接口"></a>类”实现”接口</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> PersonInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    say():<span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 只要实现的某一个接口, 那么就必须实现接口中所有的属性和方法</span></span><br><span class="line"><span class="keyword">class</span> Person <span class="keyword">implements</span> PersonInterface&#123;</span><br><span class="line">    name:<span class="built_in">string</span> = <span class="string">'xxn'</span>;</span><br><span class="line">    say():<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`我的名字叫:<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> Person();</span><br><span class="line">p.say();</span><br></pre></td></tr></table></figure>

<h6 id="接口”继承”类"><a href="#接口”继承”类" class="headerlink" title="接口”继承”类"></a>接口”继承”类</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">    <span class="comment">// protected name:string = 'xxn';</span></span><br><span class="line">    name:<span class="built_in">string</span> = <span class="string">'xxn'</span>;</span><br><span class="line">    age:<span class="built_in">number</span> = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">protected</span> say():<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`name = <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>, age = <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// let p = new Person();</span></span><br><span class="line"><span class="comment">// p.say();</span></span><br><span class="line"><span class="comment">// 注意点: 只要一个接口继承了某个类, 那么就会继承这个类中所有的属性和方法</span></span><br><span class="line"><span class="comment">//         但是只会继承属性和方法的声明, 不会继承属性和方法实现</span></span><br><span class="line"><span class="comment">// 注意点: 如果接口继承的类中包含了protected的属性和方法, 那么就只有这个类的子类才能实现这个接口</span></span><br><span class="line"><span class="keyword">interface</span> PersonInterface <span class="keyword">extends</span> Person&#123;</span><br><span class="line">    gender:<span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> Student <span class="keyword">extends</span> Person <span class="keyword">implements</span> PersonInterface&#123;</span><br><span class="line">    gender:<span class="built_in">string</span> = <span class="string">'male'</span>;</span><br><span class="line">    name:<span class="built_in">string</span> = <span class="string">'xxn'</span>;</span><br><span class="line">    age:<span class="built_in">number</span> = <span class="number">18</span>;</span><br><span class="line">    say():<span class="built_in">void</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`name = <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>, age = <span class="subst">$&#123;<span class="keyword">this</span>.age&#125;</span>, gender = <span class="subst">$&#123;<span class="keyword">this</span>.gender&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> stu = <span class="keyword">new</span> Student();</span><br><span class="line">stu.say();</span><br></pre></td></tr></table></figure>

<h6 id="类和泛型"><a href="#类和泛型" class="headerlink" title="类和泛型"></a>类和泛型</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Chache&lt;T&gt; &#123;</span><br><span class="line">    arr:T[] = [];</span><br><span class="line">    add(value:T):T&#123;</span><br><span class="line">        <span class="keyword">this</span>.arr.push(value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    all():T[]&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.arr;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> chache = <span class="keyword">new</span> Chache&lt;<span class="built_in">number</span>&gt;();</span><br><span class="line">chache.add(<span class="number">1</span>);</span><br><span class="line">chache.add(<span class="number">3</span>);</span><br><span class="line">chache.add(<span class="number">5</span>);</span><br><span class="line"><span class="built_in">console</span>.log(chache.all());</span><br></pre></td></tr></table></figure>

<h6 id="接口合并现象"><a href="#接口合并现象" class="headerlink" title="接口合并现象:"></a>接口合并现象:</h6><p>当我们定义了多个同名的接口时, 多个接口的内容会自动合并</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    age:<span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">interface TestInterface &#123;</span></span><br><span class="line"><span class="comment">    name:string;</span></span><br><span class="line"><span class="comment">    age:number;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Person <span class="keyword">implements</span> TestInterface&#123;</span><br><span class="line">    age:<span class="built_in">number</span> = <span class="number">19</span>;</span><br><span class="line">    name:<span class="built_in">string</span> = <span class="string">'nini'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认情况下就是数字枚举</span></span><br><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male,</span><br><span class="line">    Female</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>枚举反向映射:</strong></p>
<ul>
<li><p>可以根据枚举值获取到原始值</p>
</li>
<li><p>也可以根据原始值获取到枚举值</p>
</li>
</ul>
<ol>
<li><p>数字枚举</p>
<ul>
<li>数字枚举的取值默认从0开始递增</li>
<li>数字枚举的取值可以是字面量, 也可以是常量, 也可以是计算的结果</li>
</ul>
</li>
</ol>
<ol start="2">
<li>字符串枚举</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male = <span class="string">'www.baidu.com'</span>,</span><br><span class="line">    Female = <span class="string">'www.sina.com'</span> <span class="comment">// 注意点: 如果使用字符串给前面的枚举值赋值了, 那么后面的枚举值也必须手动赋值</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Gender.Male);</span><br><span class="line"><span class="built_in">console</span>.log(Gender.Female);</span><br></pre></td></tr></table></figure>

<p>注意点: </p>
<ul>
<li><p>如果使用字符串给前面的枚举值赋值了, 那么后面的枚举值也必须手动赋值</p>
</li>
<li><p>和数字枚举不一样, 字符串枚举不能使用常量或者计算结果给枚举值赋值</p>
</li>
<li><p>虽然字符串枚举不能够使用常量或者计算结果给枚举值赋值, 但是它可以使用内部的其它枚举值来赋值</p>
</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> str = <span class="string">'nini'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'abc'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male = <span class="string">'www.baidu.com'</span>,</span><br><span class="line">    <span class="comment">// Male = str, 报错</span></span><br><span class="line">    <span class="comment">// Male = getStr(),  报错</span></span><br><span class="line">    Female = <span class="string">'www.sina.com'</span>,</span><br><span class="line">    Yao = Female</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Gender.Female);</span><br><span class="line"><span class="built_in">console</span>.log(Gender.Yao);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>异构枚举</li>
</ol>
<p>枚举中既包含数字又包含字符串, 我们就称之为异构枚举</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male = <span class="number">6</span>,</span><br><span class="line">    Female = <span class="string">'nv'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(Gender.Male);</span><br><span class="line"><span class="built_in">console</span>.log(Gender.Female);</span><br><span class="line"><span class="built_in">console</span>.log(Gender[<span class="number">6</span>]);</span><br><span class="line"><span class="comment">// 注意点: 如果是字符串枚举, 那么无法通过原始值获取到枚举值</span></span><br><span class="line"><span class="comment">// console.log(Gender['nv']);</span></span><br><span class="line"><span class="built_in">console</span>.log(Gender);</span><br></pre></td></tr></table></figure>

<h6 id="枚举成员类型"><a href="#枚举成员类型" class="headerlink" title="枚举成员类型"></a>枚举成员类型</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male,</span><br><span class="line">    Female</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    age: Gender.Male</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> Person <span class="keyword">implements</span> TestInterface&#123;</span><br><span class="line">    age: Gender.Male</span><br><span class="line">    <span class="comment">// age: Gender.Female // 由于类型不匹配, 所以会报错</span></span><br><span class="line">    <span class="comment">// age: 0 // 注意点: 由于数字枚举的本质就是数值, 所以这里写一个数值也不会报错</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male = <span class="string">'www.baidu.com'</span>,</span><br><span class="line">    Female = <span class="string">'www.sina.com'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    age: Gender.Male</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> Person <span class="keyword">implements</span> TestInterface&#123;</span><br><span class="line">     age: Gender.Male</span><br><span class="line">    <span class="comment">// age: Gender.Female 报错</span></span><br><span class="line">    <span class="comment">// age: 'www.baidu.com' // 注意点: 如果是字符串枚举, 那么只能是枚举成员的值, 不能是其它的值 报错</span></span><br><span class="line">    <span class="comment">// age: string 报错</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行时枚举</p>
<ul>
<li><p>枚举在编译之后是一个真实存储的对象, 所以可以在运行时使用</p>
</li>
<li><p>而像接口这种只是用来做约束做静态检查的代码, 编译之后是不存在的</p>
</li>
</ul>
<p>常量枚举</p>
<ul>
<li><p>普通枚举会生成真实存在的对象</p>
</li>
<li><p>常量枚举不会生成真实存在的对象, 而是利用枚举成员的值直接替换使用到的地方</p>
</li>
</ul>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender1&#123;</span><br><span class="line">    Male,</span><br><span class="line">    Female</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Gender1.Male === <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">enum</span> Gender2&#123;</span><br><span class="line">    Male,</span><br><span class="line">    Female</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(Gender2.Male === <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p><strong>类型兼容性，函数兼容性，枚举兼容性，类兼容性，泛型兼容性：不想做笔记</strong></p>
<h5 id="交叉和联合类型"><a href="#交叉和联合类型" class="headerlink" title="交叉和联合类型"></a>交叉和联合类型</h5><ol>
<li><p>交叉类型</p>
<p>格式: type1 &amp; type2 &amp; …</p>
<p>交叉类型是将多个类型合并为一个类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mergeFn = &lt;T, U&gt;<span class="function">(<span class="params">arg1:T, arg2:U</span>):(<span class="params">T &amp; U</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> res = &#123;&#125; <span class="keyword">as</span> (T &amp; U);</span><br><span class="line">    res = <span class="built_in">Object</span>.assign(arg1, arg2);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> res = mergeFn(&#123;name:<span class="string">'nini'</span>&#125;, &#123;age:<span class="number">18</span>&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>
</li>
<li><p>联合类型</p>
<p>格式: type1 | type2 | …</p>
<p>联合类型是多个类型中的任意一个类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> value: (<span class="built_in">string</span> | <span class="built_in">number</span>);</span><br><span class="line">value = <span class="string">'abc'</span>;</span><br><span class="line">value = <span class="number">123</span>;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>对于联合类型的变量，在使用时如何确切告诉编译器它是哪一种类型：<strong>通过类型断言或者类型保护</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> getRandomValue = <span class="function"><span class="params">()</span>:(<span class="params"><span class="built_in">string</span> | <span class="built_in">number</span></span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> num = <span class="built_in">Math</span>.random();</span><br><span class="line">    <span class="keyword">return</span> (num &gt;= <span class="number">0.5</span>) ? <span class="string">'abc'</span> : <span class="number">123.123</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>虽然通过类型断言可以确切的告诉编译器当前的变量是什么类型,</p>
<p>但是每一次使用的时候都需要手动的告诉编译器, 这样比较麻烦, 冗余代码也比较多</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>((value <span class="keyword">as</span> <span class="built_in">string</span>).length)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log((value <span class="keyword">as</span> <span class="built_in">string</span>).length);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log((value <span class="keyword">as</span> <span class="built_in">number</span>).toFixed());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>定义了一个类型保护函数, 这个函数的’返回类型’是一个布尔类型,这个函数的返回值类型是, 传入的参数 + is 具体类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isString</span>(<span class="params">value:(<span class="built_in">string</span> | <span class="built_in">number</span>)</span>): <span class="title">value</span> <span class="title">is</span> <span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> value === <span class="string">'string'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(isString(value))&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value.length);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(value.toFixed());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>除了可以通过typeof类实现类型保护以外, 我们还可以通过instanceof来实现类型保护</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">    name:<span class="built_in">string</span> = <span class="string">'nini'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> Animal &#123;</span><br><span class="line">    age: <span class="built_in">number</span> = <span class="number">18</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> getRandomObject = <span class="function"><span class="params">()</span>:(<span class="params">Person | Animal</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> num = <span class="built_in">Math</span>.random();</span><br><span class="line">    <span class="keyword">return</span> (num &gt;= <span class="number">0.5</span>) ? <span class="keyword">new</span> Person() : <span class="keyword">new</span> Animal();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> obj = getRandomObject();</span><br><span class="line"><span class="built_in">console</span>.log(obj);</span><br><span class="line"><span class="keyword">if</span>(obj <span class="keyword">instanceof</span> Person)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(obj.name);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(obj.age);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="null和undefined"><a href="#null和undefined" class="headerlink" title="null和undefined"></a>null和undefined</h6><ul>
<li><p>默认情况下我们可以将 null和 undefined赋值给任意类型</p>
</li>
<li><p>默认情况下null和 undefined也可以相互赋值</p>
</li>
</ul>
<p><em>注意点: 在企业开发中, 如果不想把 null和 undefined赋值给其它的类型或者不想让 null和 undefined相互赋值, 那么我们就可以开strictNullChecks</em></p>
<ul>
<li><p>如果我们开启了strictNullChecks, 还想把null和 undefined赋值给其它的类型， 那么我们就必须在声明的时候使用联合类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> value:(<span class="built_in">number</span> | <span class="literal">null</span> | <span class="literal">undefined</span>);</span><br><span class="line">value = <span class="literal">null</span>;</span><br><span class="line">value = <span class="literal">undefined</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>对于可选属性和可选参数而言, 如果开启了strictNullChecks, 那么默认情况下数据类型就是联合类型</p>
<p>就是当前的类型 + undefined类型</p>
</li>
<li><p>去除 null或 undefined检测</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLength</span>(<span class="params">value:(<span class="built_in">string</span> | <span class="literal">null</span> | <span class="literal">undefined</span>)</span>) </span>&#123;</span><br><span class="line">    value = <span class="string">'abc'</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span>=&gt;</span>&#123;</span><br><span class="line">        <span class="comment">// return value.length; // 报错</span></span><br><span class="line">        <span class="comment">// return (value || '').length;</span></span><br><span class="line">        <span class="comment">// return (value as string).length;</span></span><br><span class="line">        <span class="comment">// 我们可以使用!来去除null和undefined</span></span><br><span class="line">        <span class="comment">// !的含义就是这个变量一定不是null和undefined</span></span><br><span class="line">        <span class="keyword">return</span> value!.length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> fn = getLength(<span class="string">'www.it66.com'</span>);</span><br><span class="line"><span class="keyword">let</span> res = fn();</span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h5 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h5><h6 id="类型兼容性"><a href="#类型兼容性" class="headerlink" title="类型兼容性"></a>类型兼容性</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p1 = &#123;name:<span class="string">'nini'</span>&#125;;</span><br><span class="line"><span class="keyword">let</span> p2 = &#123;age:<span class="number">18</span>&#125;;</span><br><span class="line"><span class="keyword">let</span> p3 = &#123;name:<span class="string">'nini'</span>, age:<span class="number">18</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> t:TestInterface;</span><br><span class="line">t = p1;</span><br><span class="line">t = p2; <span class="comment">// 报错</span></span><br><span class="line">t = p3; <span class="comment">// 可多不可少</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    children:&#123;</span><br><span class="line">        age:<span class="built_in">number</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> p1 = &#123;name:<span class="string">'nini'</span>, children:&#123;age:<span class="number">18</span>&#125;&#125;;</span><br><span class="line"><span class="keyword">let</span> p2 = &#123;name:<span class="string">'nini'</span>,children:&#123;age:<span class="string">'abc'</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> t:TestInterface;</span><br><span class="line">t = p1;</span><br><span class="line">t = p2; <span class="comment">// 报错 会递归检查</span></span><br></pre></td></tr></table></figure>

<h6 id="函数兼容性"><a href="#函数兼容性" class="headerlink" title="函数兼容性"></a>函数兼容性</h6><ol>
<li><p>参数个数</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fn1 = <span class="function">(<span class="params">x:<span class="built_in">number</span>, y:<span class="built_in">number</span></span>)=&gt;</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> fn2 = <span class="function">(<span class="params">x:<span class="built_in">number</span></span>)=&gt;</span>&#123;&#125;;</span><br><span class="line">fn1 = fn2;</span><br><span class="line">fn2 = fn1; <span class="comment">//报错 可少不可多</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>参数类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fn1 = <span class="function">(<span class="params">x:<span class="built_in">number</span></span>)=&gt;</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> fn2 = <span class="function">(<span class="params">x:<span class="built_in">number</span></span>)=&gt;</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> fn3 = <span class="function">(<span class="params">x:<span class="built_in">string</span></span>)=&gt;</span>&#123;&#125;;</span><br><span class="line">fn1 = fn2;</span><br><span class="line">fn2 = fn1;</span><br><span class="line">fn1 = fn3; <span class="comment">// 报错 必须一模一样</span></span><br><span class="line">fn3 = fn1;<span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>返回值类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fn1 = ():<span class="function"><span class="params">number</span>=&gt;</span> <span class="number">123</span>;</span><br><span class="line"><span class="keyword">let</span> fn2 = ():<span class="function"><span class="params">number</span>=&gt;</span> <span class="number">456</span>;</span><br><span class="line"><span class="keyword">let</span> fn3 = ():<span class="function"><span class="params">string</span>=&gt;</span> <span class="string">'abc'</span>;</span><br><span class="line">fn1 = fn2;</span><br><span class="line">fn2 = fn1;</span><br><span class="line">fn1 = fn3; <span class="comment">// 报错必须一模一样</span></span><br><span class="line">fn3 = fn1;<span class="comment">// 报错必须一模一样</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>函数双向协变</p>
<ul>
<li><p>参数的双向协变</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fn1 = <span class="function">(<span class="params">x:(<span class="params"><span class="built_in">number</span> | <span class="built_in">string</span></span>)</span>) =&gt;</span>&#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> fn2 = <span class="function">(<span class="params">x:<span class="built_in">number</span></span>) =&gt;</span>&#123;&#125;;</span><br><span class="line">fn1 = fn2;</span><br><span class="line">fn2 = fn1;</span><br></pre></td></tr></table></figure>
</li>
<li><p>返回值的双向协变</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fn1 = <span class="function">(<span class="params">x:<span class="built_in">boolean</span></span>):(<span class="params"><span class="built_in">number</span> | <span class="built_in">string</span></span>) =&gt;</span> x ? <span class="number">123</span> : <span class="string">'abc'</span>;</span><br><span class="line"><span class="keyword">let</span> fn2 = (x:<span class="built_in">boolean</span>):<span class="function"><span class="params">number</span> =&gt;</span> <span class="number">456</span>;</span><br><span class="line">fn1 = fn2; <span class="comment">// 不报错 但是可以将返回值是具体类型的赋值给联合类型的</span></span><br><span class="line">fn2 = fn1; <span class="comment">//报错  不能将返回值是联合类型的赋值给具体类型的</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>函数重载</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x:<span class="built_in">number</span>, y:<span class="built_in">number</span></span>):<span class="title">number</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x:<span class="built_in">string</span>, y:<span class="built_in">string</span></span>):<span class="title">string</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">x:<span class="built_in">number</span>, y:<span class="built_in">number</span></span>):<span class="title">number</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x - y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// let fn = add;</span></span><br><span class="line"><span class="comment">// fn = sub; // 报错 不能将重载少的赋值给重载多的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fn = sub;</span><br><span class="line">fn = add; <span class="comment">// 可以将重载多的赋值给重载少</span></span><br></pre></td></tr></table></figure>


</li>
</ol>
<h6 id="枚举兼容性"><a href="#枚举兼容性" class="headerlink" title="枚举兼容性"></a>枚举兼容性</h6><ul>
<li><p>数字枚举与数值兼容</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male,</span><br><span class="line">    Female</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> value:Gender;</span><br><span class="line">value = Gender.Male;</span><br><span class="line">value = <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>数字枚举与数字枚举不兼容</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male, <span class="comment">// 0</span></span><br><span class="line">    Female <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span> Animal&#123;</span><br><span class="line">    Dog, <span class="comment">// 0</span></span><br><span class="line">    Cat <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> value:Gender;</span><br><span class="line">value = Gender.Male;</span><br><span class="line">value = Animal.Dog; <span class="comment">// 报错</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串枚举与字符串不兼容</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Gender&#123;</span><br><span class="line">    Male = <span class="string">'abc'</span>,</span><br><span class="line">    Female  = <span class="string">'def'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> value:Gender;</span><br><span class="line">value = Gender.Male;</span><br><span class="line">value = <span class="string">'abc'</span>;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h6 id="类兼容性"><a href="#类兼容性" class="headerlink" title="类兼容性"></a>类兼容性</h6><ul>
<li>只比较实例成员, 不比较类的构造函数和静态成员</li>
<li>类的私有属性和受保护属性会影响兼容性</li>
</ul>
<h6 id="泛型兼容性"><a href="#泛型兼容性" class="headerlink" title="泛型兼容性"></a>泛型兼容性</h6><p>泛型只影响使用的部分, 不会影响声明的部分</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> TestInterface&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// age:T;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> t1: TestInterface&lt;<span class="built_in">number</span>&gt;; <span class="comment">// age:number</span></span><br><span class="line"><span class="keyword">let</span> t2: TestInterface&lt;<span class="built_in">string</span>&gt;; <span class="comment">// age:string</span></span><br><span class="line">t1 = t2;</span><br><span class="line">t2 = t1;</span><br></pre></td></tr></table></figure>

<h5 id="类型别名和接口的异同点"><a href="#类型别名和接口的异同点" class="headerlink" title="类型别名和接口的异同点"></a>类型别名和接口的异同点</h5><ol>
<li><p>都可以描述属性或方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyType = &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    say():<span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> MyInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    say():<span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>都允许拓展</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> MyInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    say():<span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> MyInterface2 <span class="keyword">extends</span> MyInterface&#123;</span><br><span class="line">    age:<span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> value:MyInterface2 = &#123;</span><br><span class="line">    name:<span class="string">'nini'</span>,</span><br><span class="line">    age:<span class="number">18</span>,</span><br><span class="line">    say():<span class="built_in">void</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyType = &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    say():<span class="built_in">void</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> MyType2 = MyType &amp; &#123;</span><br><span class="line">    age:<span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> value:MyType2 = &#123;</span><br><span class="line">    name:<span class="string">'nini'</span>,</span><br><span class="line">    age: <span class="number">18</span>,</span><br><span class="line">    say():<span class="built_in">void</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>type 可以声明基本类型别名，联合类型，元组等类型, interface不能</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyType1 = <span class="built_in">boolean</span>;</span><br><span class="line"><span class="keyword">type</span> MyType2 = <span class="built_in">string</span> | <span class="built_in">number</span>;</span><br><span class="line"><span class="keyword">type</span> MyType3 = [<span class="built_in">string</span>, <span class="built_in">boolean</span>, <span class="built_in">number</span>];</span><br></pre></td></tr></table></figure>
</li>
<li><p>type不会自动合并</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> MyInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> MyInterface &#123;</span><br><span class="line">    age:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> value:MyInterface  =&#123;</span><br><span class="line">    name:<span class="string">'nini'</span>,</span><br><span class="line">    age:<span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyType = &#123;</span><br><span class="line">    name:<span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> MyType = &#123;</span><br><span class="line">    age:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="可辨识联合"><a href="#可辨识联合" class="headerlink" title="可辨识联合"></a>可辨识联合</h5><ol>
<li>什么是可辨识联合<br>具有共同的可辨识特征。<br>一个类型别名, 包含了具有共同的可辨识特征的类型的联合。</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Square &#123;</span><br><span class="line">    kind: <span class="string">"square"</span>; <span class="comment">// 共同的可辨识特征</span></span><br><span class="line">    size: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> Rectangle &#123;</span><br><span class="line">    kind: <span class="string">"rectangle"</span>; <span class="comment">// 共同的可辨识特征</span></span><br><span class="line">    width: <span class="built_in">number</span>;</span><br><span class="line">    height: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> Circle &#123;</span><br><span class="line">    kind: <span class="string">"circle"</span>; <span class="comment">// 共同的可辨识特征</span></span><br><span class="line">    radius: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Shape就是一个可辨识联合</span></span><br><span class="line"><span class="comment">因为: 它的取值是一个联合</span></span><br><span class="line"><span class="comment">因为: 这个联合的每一个取值都有一个共同的可辨识特征</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line"><span class="keyword">type</span> Shape = (Square | Rectangle | Circle);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aera</span>(<span class="params">s: Shape</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (s.kind) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"square"</span>: <span class="keyword">return</span> s.size * s.size;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"rectangle"</span>: <span class="keyword">return</span> s.width * s.height;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"circle"</span>: <span class="keyword">return</span>  <span class="built_in">Math</span>.PI * s.radius ** <span class="number">2</span>; <span class="comment">// **是ES7中推出的幂运算符</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在企业开发中如果相对可辨识联合的完整性进行检查, 那么我们可以使用</p>
<ul>
<li><p>方式一: 给函数添加返回值 + 开启strictNullChecks</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aera</span>(<span class="params">s: Shape</span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (s.kind) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"square"</span>: <span class="keyword">return</span> s.size * s.size;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"rectangle"</span>: <span class="keyword">return</span> s.width * s.height;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"circle"</span>: <span class="keyword">return</span>  <span class="built_in">Math</span>.PI * s.radius ** <span class="number">2</span>; <span class="comment">// **是ES7中推出的幂运算符</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
</li>
</ol>
<ul>
<li><p>方式二: 添加default + never(不常用)</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyNever</span>(<span class="params">x: never</span>):<span class="title">never</span> </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'可辨识联合处理不完整'</span> + x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aera</span>(<span class="params">s: Shape</span>):<span class="title">number</span></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (s.kind) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"square"</span>: <span class="keyword">return</span> s.size * s.size;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"rectangle"</span>: <span class="keyword">return</span> s.width * s.height;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"circle"</span>: <span class="keyword">return</span>  <span class="built_in">Math</span>.PI * s.radius ** <span class="number">2</span>; <span class="comment">// **是ES7中推出的幂运算符</span></span><br><span class="line">        <span class="keyword">default</span>:<span class="keyword">return</span> MyNever(s)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="索引类型"><a href="#索引类型" class="headerlink" title="索引类型"></a>索引类型</h5><p>通过[]索引类型访问操作符, 我们就能得到某个索引的类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    age:<span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> MyType = Person[<span class="string">'name'</span>];</span><br></pre></td></tr></table></figure>

<ul>
<li><p>应用场景</p>
<p>需求: 获取指定对象, 部分属性的值, 放到数组中返回</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> obj = &#123;</span><br><span class="line">    name:<span class="string">'nini'</span>,</span><br><span class="line">    age:<span class="number">18</span>,</span><br><span class="line">    gender:<span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getValues</span>&lt;<span class="title">T</span>, <span class="title">K</span> <span class="title">extends</span> <span class="title">keyof</span> <span class="title">T</span>&gt;(<span class="params">obj:T, keys:K[]</span>):<span class="title">T</span>[<span class="title">K</span>][] </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [] <span class="keyword">as</span> T[K][];</span><br><span class="line">    keys.forEach(<span class="function"><span class="params">key</span>=&gt;</span>&#123;</span><br><span class="line">        arr.push(obj[key]);</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> res = getValues(obj, [<span class="string">'name'</span>, <span class="string">'age'</span>]);</span><br><span class="line"><span class="built_in">console</span>.log(res);</span><br></pre></td></tr></table></figure>

<p><em>索引访问操作符注意点,不会返回null/undefined/never类型</em></p>
</li>
</ul>
<h4 id="组件性能优化"><a href="#组件性能优化" class="headerlink" title="组件性能优化"></a>组件性能优化</h4><ul>
<li><p>类组件</p>
<p><code>extend PureComponent</code></p>
</li>
<li><p>函数组件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> son = React.memo(</span><br><span class="line">	<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>哈哈哈<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h5 id="映射类型"><a href="#映射类型" class="headerlink" title="映射类型?"></a>映射类型?</h5><p>根据旧的类型创建出新的类型, 我们称之为映射类型</p>
<ul>
<li><p>只读/可选</p>
<p>通过+/-来指定添加还是删除 只读和可选修饰符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">interface TestInterface1&#123;</span><br><span class="line">    name:string;</span><br><span class="line">    age:number</span><br><span class="line">&#125;</span><br><span class="line">interface TestInterface2&#123;</span><br><span class="line">    readonly name?:string;</span><br><span class="line">    readonly age?:number</span><br><span class="line">&#125;	</span><br><span class="line">type ReadonlyTestInterface&lt;T&gt; &#x3D; &#123;</span><br><span class="line">    &#x2F;&#x2F; [P in keyof T]作用: 遍历出指定类型所有的key, 添加到当前对象上</span><br><span class="line">    &#x2F;&#x2F; readonly [P in keyof T]: T[P]</span><br><span class="line">    &#x2F;&#x2F; readonly [P in keyof T]?: T[P]</span><br><span class="line">    -readonly [P in keyof T]-?: T[P]</span><br><span class="line">&#125;</span><br><span class="line">type MyType &#x3D; ReadonlyTestInterface&lt;TestInterface2&gt;</span><br></pre></td></tr></table></figure>

<p><strong>由于生成只读属性和可选属性比较常用</strong>, 所以TS内部已经给我们提供了现成的实现:Readonly / Partial</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyType2 = Readonly&lt;TestInterface1&gt;</span><br><span class="line"><span class="keyword">type</span> MyType3 = Partial&lt;TestInterface1&gt;</span><br><span class="line"><span class="keyword">type</span> MyType4 = Partial&lt;Readonly&lt;TestInterface1&gt;&gt;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>Pick映射类型:将原有类型中的部分内容映射到新类型中</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    age:<span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> MyType = Pick&lt;TestInterface, <span class="string">'name'</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Record映射类型:他会将一个类型的所有属性值都映射到另一个类型上并创造一个新的类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Animal = <span class="string">'person'</span> | <span class="string">'dog'</span> | <span class="string">'cat'</span>;</span><br><span class="line"><span class="keyword">interface</span> TestInterface &#123;</span><br><span class="line">    name:<span class="built_in">string</span>;</span><br><span class="line">    age:<span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> MyType = Record&lt;Animal, TestInterface&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> res:MyType = &#123;</span><br><span class="line">    person:&#123;</span><br><span class="line">        name:<span class="string">'zs'</span>,</span><br><span class="line">        age:<span class="number">18</span></span><br><span class="line">    &#125;,</span><br><span class="line">    dog:&#123;</span><br><span class="line">        name:<span class="string">'wc'</span>,</span><br><span class="line">        age:<span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    cat:&#123;</span><br><span class="line">        name:<span class="string">'mm'</span>,</span><br><span class="line">        age:<span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="分布式条件类型"><a href="#分布式条件类型" class="headerlink" title="分布式条件类型"></a>分布式条件类型</h5><ol>
<li><p>条件类型(三目运算)</p>
<p>判断前面一个类型是否是后面一个类型或者继承于后面一个类型</p>
<p>如果是就返回第一个结果, 如果不是就返回第二个结果</p>
<p>语法: <code>T extends U ? X : Y;</code></p>
</li>
<li><p>分布式条件类型?</p>
<p>被检测类型是一个联合类型的时候, 该条件类型就被称之为分布式条件类型</p>
<ul>
<li><p>从T中剔除可以赋值给U的类型。 Exclude</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyType&lt;T, U&gt; = T <span class="keyword">extends</span> U ? never : T;</span><br><span class="line"><span class="keyword">type</span> res = MyType&lt;<span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span>, <span class="built_in">number</span>&gt;</span><br><span class="line"><span class="keyword">type</span> res = Exclude&lt;<span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span>, <span class="built_in">number</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>提取T中可以赋值给U的类型。 Extract</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> res = Extract&lt;<span class="built_in">string</span> | <span class="built_in">number</span> | <span class="built_in">boolean</span>, <span class="built_in">number</span> | <span class="built_in">string</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从T中剔除null和undefined。 NonNullable</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> res = NonNullable&lt;<span class="built_in">string</span> | <span class="literal">null</span> | <span class="built_in">boolean</span> | <span class="literal">undefined</span>&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取函数返回值类型。 ReturnType</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> res = ReturnType&lt;<span class="function">(<span class="params">(<span class="params"></span>)=&gt;<span class="built_in">number</span></span>)&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>获取一个类的构造函数参数组成的元组类型ConstructorParameters</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> Person &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span></span>)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> res = ConstructorParameters&lt;<span class="keyword">typeof</span> Person&gt;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获得函数的参数类型组成的元组类型。 Parameters</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params">name:<span class="built_in">string</span>, age:<span class="built_in">number</span>, gender:<span class="built_in">boolean</span></span>) </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> res = Parameters&lt;<span class="keyword">typeof</span> say&gt;;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="infer关键字"><a href="#infer关键字" class="headerlink" title="infer关键字"></a>infer关键字</h5><p>条件类型提供了一个infer关键字, 可以让我们在条件类型中定义新的类型</p>
<p>需求: 定义一个类型, 如果传入的是数组, 就返回数组的元素类型,</p>
<p>​         如果传入的是普通类型, 则直接返回这个类型</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MyType&lt;T&gt; = T <span class="keyword">extends</span> <span class="built_in">any</span>[] ? T[<span class="built_in">number</span>] : T;</span><br><span class="line"><span class="keyword">type</span> res = MyType&lt;<span class="built_in">string</span>[]&gt;;</span><br><span class="line"><span class="keyword">type</span> res = MyType&lt;<span class="built_in">number</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyType&lt;T&gt; = T <span class="keyword">extends</span> <span class="built_in">Array</span>&lt;infer U&gt; ? U : T;</span><br><span class="line"><span class="keyword">type</span> res = MyType&lt;<span class="built_in">string</span>[]&gt;;</span><br><span class="line"><span class="keyword">type</span> res = MyType&lt;<span class="built_in">number</span>&gt;;</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="https://nini-hub.github.io/2020/12/09/Express%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="妮妮妮">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ninihub">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/09/Express%E5%85%A5%E9%97%A8%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">Express入门学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">نُشر في</span>
              

              <time title="أُنشأ: 2020-12-09 14:15:53 / عُدل: 16:12:03" itemprop="dateCreated datePublished" datetime="2020-12-09T14:15:53+08:00">2020-12-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Express介绍"><a href="#Express介绍" class="headerlink" title="Express介绍"></a>Express介绍</h3><ol>
<li><p>什么是Express?</p>
<p>Express是一个基于NodeJS的Web Server开发框架, 能够帮助我们快速的搭建Web服务器</p>
</li>
<li><p>为什么需要Express?</p>
<ul>
<li><p>利用原生的NodeJS开发Web服务器,</p>
<p>我们需要处理很多繁琐且没有技术含量的内容</p>
<p>例如: 获取路由-&gt;解析路由-&gt;分配路由-&gt;处理路由等</p>
<p>但是有了Express之后, 就能帮助我们省去大量繁琐的环节, 让我们只用关注核心业务逻辑</p>
</li>
<li><p>利用原生的NodeJS开发Web服务器,</p>
<p>我们需要自己手动去实现静态/动态资源处理, get/post参数的解析, cookie的解析, 日志处理等</p>
<p>但是有了Express之后, 已经有现成的插件帮我们实现了上述功能</p>
</li>
<li><p>所以作为单身的程序猿(媛), 如果你还想留一些时间去约会, 那么Express是你的最佳选择</p>
</li>
</ul>
</li>
<li><p>永不过时的Express</p>
<ul>
<li><p>Express最早的版本是在2010年发布的, 目前最新的版本是5.0是在2015年左右发布的</p>
</li>
<li><p>虽然Express是一个古老的框架, 但是它并没有过时，因为</p>
<ul>
<li>公司老项目仍然在使用</li>
<li>目前比较火的KOA就是Express原班人马打造的(几乎有这相同的API)</li>
<li>目前比较火的EggJS就是KOA打造的</li>
</ul>
<p>所以</p>
<ul>
<li>学会Express能够帮助你很好的维护公司的老项目</li>
<li>学会Express能够帮助你更快的学习KOA和EggJS</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><ol>
<li><p>如何使用Express?</p>
<ul>
<li><p>手动安装手动配置</p>
</li>
<li><p>利用Express脚手架工具安装使用(Express-generator)</p>
</li>
</ul>
</li>
<li><p>手动安装手动配置</p>
<p><a href="https://www.npmjs.com/package/express" target="_blank" rel="noopener">https://www.npmjs.com/package/express</a></p>
</li>
</ol>
<h4 id="手动安装手动配置"><a href="#手动安装手动配置" class="headerlink" title="手动安装手动配置"></a>手动安装手动配置</h4><h5 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h5><ol>
<li><p><code>npm init &amp;&amp; npm install express</code></p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.调用express方法, 创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain; charset=utf-8;'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.end(<span class="string">'www.baidu.com'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.告诉服务端需要监听哪一个端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listen ok'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问<code>localhost:3000</code></p>
</li>
</ol>
<h5 id="处理静态网页"><a href="#处理静态网页" class="headerlink" title="处理静态网页"></a>处理静态网页</h5><ol>
<li><p>将静态资源public文件夹复制到项目目录下</p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.调用express方法, 创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理静态资源</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.writeHead(<span class="number">200</span>, &#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'text/plain; charset=utf-8;'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    res.end(<span class="string">'www.it666.com'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.告诉服务端需要监听哪一个端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listen ok'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>访问<code>localhost:3000/login.html</code></p>
</li>
</ol>
<h5 id="处理动态网页"><a href="#处理动态网页" class="headerlink" title="处理动态网页"></a>处理动态网页</h5><ol>
<li><p>讲动态网页views文件夹复制到项目目录下</p>
</li>
<li><p>安装ejs</p>
<p><code>npm install ejs</code></p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.导入express</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.调用express方法, 创建服务端实例对象</span></span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理静态资源</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理动态资源</span></span><br><span class="line"><span class="comment">// 1.告诉express动态资源存储在什么地方</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line"><span class="comment">// 2.告诉express动态网页使用的是什么模板引擎</span></span><br><span class="line">app.set(<span class="string">'view engine'</span>,<span class="string">'ejs'</span>)</span><br><span class="line"><span class="comment">// 3.监听请求, 返回渲染之后的动态网页</span></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    <span class="comment">// 注意点: express给请求对象和影响对象添加了很多自定义的方法</span></span><br><span class="line">    res.render(<span class="string">'index'</span>, &#123;<span class="attr">msg</span>:<span class="string">'妮妮碎碎念'</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.告诉服务端需要监听哪一个端口</span></span><br><span class="line">app.listen(<span class="number">3000</span>, ()=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'listen ok'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><em>报错：</em></p>
<p><code>TypeError [ERR_INVALID_ARG_TYPE]: The &quot;path&quot; argument must be of type string. Received an instance of Object</code></p>
<p><em>解决</em></p>
<p>删除node_module,重新安包</p>
</li>
</ol>
<h5 id="处理路由"><a href="#处理路由" class="headerlink" title="处理路由"></a>处理路由</h5><ul>
<li><p>方式一</p>
<p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过express处理路由方式一</span></span><br><span class="line">app.get(<span class="string">'/api/goods/list'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.end(<span class="string">'nini.get'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/api/user/login'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    <span class="comment">// 注意点: 响应对象的json方法是express给响应对象扩展的</span></span><br><span class="line">    <span class="comment">//         这个方法会自动将对象转换成字符串之后返回</span></span><br><span class="line">    <span class="comment">//         这个方法还会自动帮助我们设置响应头</span></span><br><span class="line">    res.json(&#123;</span><br><span class="line">        name:<span class="string">'nini'</span>,</span><br><span class="line">        age:<span class="number">18</span>,</span><br><span class="line">        method: <span class="string">'get'</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/api/goods/detail'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.end(<span class="string">'nini.detail.post'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.post(<span class="string">'/api/user/register'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.json(&#123;</span><br><span class="line">        name:<span class="string">'nini'</span>,</span><br><span class="line">        age:<span class="number">18</span>,</span><br><span class="line">        method: <span class="string">'post'</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>方式二</p>
<ol>
<li><p>新建router目录</p>
</li>
<li><p>router下新建user.js，goods.js</p>
<p>/router/user.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"><span class="comment">// 会将注册的地址和当前的地址拼接在一起来匹配</span></span><br><span class="line"><span class="comment">// /api/user/login</span></span><br><span class="line">router.get(<span class="string">'/login'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    <span class="comment">// 注意点: 响应对象的json方法是express给响应对象扩展的</span></span><br><span class="line">    <span class="comment">//         这个方法会自动将对象转换成字符串之后返回</span></span><br><span class="line">    <span class="comment">//         这个方法还会自动帮助我们设置响应头</span></span><br><span class="line">    res.json(&#123;</span><br><span class="line">        name:<span class="string">'nini'</span>,</span><br><span class="line">        age:<span class="number">18</span>,</span><br><span class="line">        method: <span class="string">'get'</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">router.post(<span class="string">'/register'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.json(&#123;</span><br><span class="line">        name:<span class="string">'nini'</span>,</span><br><span class="line">        age:<span class="number">18</span>,</span><br><span class="line">        method: <span class="string">'post'</span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> userRouter = <span class="built_in">require</span>(<span class="string">'./router/user'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 通过express处理路由方式二</span></span><br><span class="line">app.use(<span class="string">'/api/user'</span>, userRouter);</span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ul>
<h5 id="处理请求参数"><a href="#处理请求参数" class="headerlink" title="处理请求参数"></a>处理请求参数</h5><ol>
<li><p>get请求：express会将get的请求参数转换成对象之后, 放到请求对象的query属性中</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/get'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.query);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>post请求：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 告诉express能够解析 application/json类型的请求参数</span></span><br><span class="line">app.use(express.json());</span><br><span class="line"><span class="comment">// 告诉express能够解析 表单类型的请求参数 application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">// extended: false 使用系统自带</span></span><br><span class="line">app.use(express.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">false</span>&#125;)); </span><br><span class="line"><span class="comment">// express会将解析之后, 转换成对象的post请求参数放到请求对象的body属性中</span></span><br><span class="line">app.post(<span class="string">'/post'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.body);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="处理cookie"><a href="#处理cookie" class="headerlink" title="处理cookie"></a>处理cookie</h5><ol>
<li><p>设置cookie</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/setCookie'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.cookie(<span class="string">'username'</span>, <span class="string">'nini'</span>, &#123;<span class="attr">httpOnly</span>: <span class="literal">true</span>, <span class="attr">path</span>: <span class="string">'/'</span>, <span class="attr">maxAge</span>: <span class="number">10000</span>&#125;);</span><br><span class="line">    res.end();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取cookie</p>
<ul>
<li>安装插件<code>npm install cookie-parser</code></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>)</span><br><span class="line">...</span><br><span class="line">app.use(cookieParser());</span><br><span class="line">app.get(<span class="string">'/getCookie'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.cookies);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="next方法"><a href="#next方法" class="headerlink" title="next方法"></a>next方法</h5><p>默认情况下会从上至下的匹配路由处理方法, 一旦匹配到了就会执行,</p>
<p>执行完毕之后如果没有调用next就停止,</p>
<p>执行完毕之后如果调用了next就继续向下匹配</p>
<p>通过next方法, 我们可以将同一个请求的多个业务逻辑拆分到不同的方法中处理</p>
<p>这样可以提升代码的可读性和可维护性, 以及保证代码的单一性</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">'/api/user/info'</span>,</span><br><span class="line">    (req, res, next)=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'验证用户是否登陆'</span>);</span><br><span class="line">        next();</span><br><span class="line">    &#125;,</span><br><span class="line">    (req, res, next)=&gt;&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'用户已经登陆, 可以查看用户信息'</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="处理错误"><a href="#处理错误" class="headerlink" title="处理错误"></a>处理错误</h5><ol>
<li><p>安装createError</p>
<p><code>npm install createError</code></p>
</li>
<li><p>app.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> createError = <span class="built_in">require</span>(<span class="string">'http-errors'</span>);</span><br><span class="line">...</span><br><span class="line"><span class="comment">// express错误处理</span></span><br><span class="line">app.get(<span class="string">'/api/user/login'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.end(<span class="string">'login'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/api/user/register'</span>, (req, res, next)=&gt;&#123;</span><br><span class="line">    res.end(<span class="string">'register'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">由于在处理请求的时候会从上至下的匹配</span></span><br><span class="line"><span class="comment">由于前面的处理方法都没有调用next方法, 所以处理完了就不会再继续向下匹配了</span></span><br><span class="line"><span class="comment">由于use没有指定路由地址, 由于use既可以处理get请求, 又可以处理post请求</span></span><br><span class="line"><span class="comment">所以只要前面的路由都没有匹配到, 就会执行下面的use</span></span><br><span class="line"><span class="comment">* */</span></span><br><span class="line">app.use(<span class="function">(<span class="params">req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">    next(createError(<span class="number">404</span>));</span><br><span class="line">&#125;);</span><br><span class="line">app.use(<span class="function">(<span class="params">err, req, res, next</span>)=&gt;</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.status, err.message);</span><br><span class="line">    res.end(err.message);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h5><ol>
<li><p>什么是中间件?</p>
<ul>
<li>中间件的本质就是一个函数, 这个函数接收3个参数request请求对象、response响应对象、next函数</li>
<li>当请求进来，会从第一个中间件开始进行匹配。如果匹配则进入，如果不匹配，则向后依次对比匹配</li>
</ul>
</li>
<li><p>中间件的作用?</p>
</li>
</ol>
<ul>
<li>将一个请求的处理过程，分发到多个环节中，目的效率高，便于维护。即每个环节专门干一件事</li>
</ul>
<ol start="3">
<li><p>中间件的分类</p>
<ul>
<li><p>应用级别中间件</p>
<p>绑定到app实例上的中间件</p>
<p>例如: app.get / app.post</p>
</li>
<li><p>路由级别中间件</p>
<p>绑定到router实例上的中间件</p>
<p>例如: router.get / router.post</p>
</li>
<li><p>错误处理中间件</p>
<p>与其他中间件函数的定义基本相同，</p>
<p>不同之处在于错误处理函数多了一个变量：err，即它有4个变量：err, req, res, next</p>
</li>
<li><p>内置中间件</p>
<p>express.static()、express.json()、express.urlencoded()、…</p>
</li>
<li><p>第三方中间件</p>
<p>cookie-parser、…</p>
</li>
</ul>
</li>
</ol>
<h4 id="脚手架使用"><a href="#脚手架使用" class="headerlink" title="脚手架使用"></a>脚手架使用</h4><ol>
<li><p>全局安装express-generator</p>
<p><code>npm install -g express-generator</code></p>
</li>
<li><p><code>express demo</code></p>
</li>
<li><p><code>cd demo &amp;&amp; npm install</code></p>
</li>
<li><p>为方便调试，继续安装nodemon、cross-env</p>
<p><code>npm install nodemon cross-env</code></p>
</li>
<li><p>目录结构介绍</p>
<ul>
<li><p>bin/<a href="http://www.js：服务端配置文件（创建服务端实例以及设置监听的端口）">www.js：服务端配置文件（创建服务端实例以及设置监听的端口）</a></p>
</li>
<li><p>node_module：依赖</p>
</li>
<li><p>public：静态资源</p>
</li>
<li><p>routes：处理路由的文件</p>
</li>
<li><p>views：存放动态网页</p>
</li>
<li><p>app.js：编写业务逻辑</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入了一些第三方的模块</span></span><br><span class="line"><span class="keyword">var</span> createError = <span class="built_in">require</span>(<span class="string">'http-errors'</span>);</span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);</span><br><span class="line"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入了处理路由的模块</span></span><br><span class="line"><span class="keyword">var</span> indexRouter = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> usersRouter = <span class="built_in">require</span>(<span class="string">'./routes/users'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建了服务端实例对象</span></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理动态网页</span></span><br><span class="line">app.set(<span class="string">'views'</span>, path.join(__dirname, <span class="string">'views'</span>));</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>);</span><br><span class="line"></span><br><span class="line">app.use(logger(<span class="string">'dev'</span>));</span><br><span class="line"><span class="comment">// 处理post请求参数</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(express.urlencoded(&#123; <span class="attr">extended</span>: <span class="literal">false</span> &#125;));</span><br><span class="line"><span class="comment">// 解析cookie</span></span><br><span class="line">app.use(cookieParser());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理静态网页</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册处理路由模块</span></span><br><span class="line">app.use(<span class="string">'/'</span>, indexRouter);</span><br><span class="line">app.use(<span class="string">'/users'</span>, usersRouter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理错误</span></span><br><span class="line"><span class="comment">// catch 404 and forward to error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  next(createError(<span class="number">404</span>));</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// error handler</span></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>(<span class="params">err, req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// set locals, only providing error in development</span></span><br><span class="line">  res.locals.message = err.message;</span><br><span class="line">  res.locals.error = req.app.get(<span class="string">'env'</span>) === <span class="string">'development'</span> ? err : &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render the error page</span></span><br><span class="line">  res.status(err.status || <span class="number">500</span>);</span><br><span class="line">  res.render(<span class="string">'error'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="الصفحة التالية"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          المحتويات
        </li>
        <li class="sidebar-nav-overview">
          عام
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="妮妮妮"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">妮妮妮</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">المقالات</span>
        </a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/nini-hub" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;nini-hub" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/490201490@qq.com" title="E-Mail → 490201490@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">妮妮妮</span>
</div>
  <div class="powered-by">تطبيق الموقع <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>



        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
